<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>es高级命令 | 点到为止</title><meta name="keywords" content="学习笔记"><meta name="author" content="candy"><meta name="copyright" content="candy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="es高级命令"><meta name="application-name" content="es高级命令"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="es高级命令"><meta property="og:url" content="https://candyadmin.github.io/elasticsearch/es%E9%AB%98%E7%BA%A7%E5%91%BD%E4%BB%A4/index.html"><meta property="og:site_name" content="点到为止"><meta property="og:description" content="以下是优化过的笔记，已加入注释并调整格式，使其更符合Markdown标准：  Elasticsearch 集群管理与优化笔记1. 移动分片到另一个节点12345678910111213POST _cluster&amp;#x2F;reroute&amp;#123;  &amp;quot;commands&amp;quot;: [    &amp;amp;#"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta property="article:author" content="candy"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg"><meta name="description" content="以下是优化过的笔记，已加入注释并调整格式，使其更符合Markdown标准：  Elasticsearch 集群管理与优化笔记1. 移动分片到另一个节点12345678910111213POST _cluster&amp;#x2F;reroute&amp;#123;  &amp;quot;commands&amp;quot;: [    &amp;amp;#"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://candyadmin.github.io/elasticsearch/es%E9%AB%98%E7%BA%A7%E5%91%BD%E4%BB%A4/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: candy","link":"链接: ","source":"来源: 点到为止","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '点到为止',
  title: 'es高级命令',
  postAI: '',
  pageFillDescription: 'Elasticsearch 集群管理与优化笔记, 1. 移动分片到另一个节点, 2. 强制分配未分配的分片（带原因说明）, 3. 从集群中移除节点, 4. 强制执行同步刷新, 5. 调整集群平衡时移动的分片数量, 6. 调整每个节点同时恢复的分片数量, 7. 调整恢复速度, 8. 调整单节点恢复时并发流数量, 9. 调整搜索队列大小, 10. 清除节点缓存, 11. 调整断路器配置, 监控 Elasticsearch 集群, 1. 节点统计, 2. 集群统计, 3. 索引统计, 4. 查看待处理的集群任务, 5. 查看所有任务支持取消任务, 6. 查看节点的线程池信息, 7. 设置索引慢日志（Slowlog）, 解决集群 Yellow 与 Red 状态问题, 1. 检查集群健康状态, 2. 查看索引级别健康状态找出红色索引, 3. 查看分片级别健康状态, 4. 解释索引分片无法分配的原因, 5. 删除并重新创建索引, 提升集群写性能, 1. 设置优化写入性能的索引设置, 提升集群读性能, 1. 示例：查询优化, 集群压力测试, 1. 安装并配置 esrally, 2. 执行简单的压力测试, 3. 执行完整数据测试, 使用缓存与 Breaker 限制内存使用, 1. 获取节点统计信息, 2. 设置内存限制, 使用 Shrink 与 Rollover API 管理索引, 1. Shrink 索引, 2. Rollover 索引, 运行三个节点分片 将box_type设置成 hotwarm和cold, 具体参考 github下docker-hot-warm-cold 下的docker-compose 文件, 设置 1秒刷新1次生产环境10分种刷新一次, 设置 Policy, 设置索引模版, 对 Alias写入文档, 一个 Demo demo 运行, demo数据, codec demo, 多行数据异常, 一个实例, 新增用户, 更新用户, 删除用户, 创建 alias只显示没有被标记 deleted的用户, 通过 Alias查询查不到被标记成 deleted的用户, , 查看 packetbeat 模块, 设置 packetbeat 的mysql 模块, 启动运行, , 安装mysql, 配置 packetbeat, 启动, 查看所有 Filebeat 模块, 查看所有的modules, , For Mac amp Windows, For Mac amp Windows, 进 modules.d 编辑相应的文件修改log路径, 日期 range, Metric 聚合找到最低的工资, Metric 聚合找到最高的工资, 多个 Metric 聚合找到最低最高和平均工资, 一个聚合输出多值, 对keword 进行聚合, 对 Text 字段进行 terms 聚合查询失败, 对 Text 字段打开 fielddata支持terms aggregation, 对 Text 字段进行 terms 分词。分词后的terms, 对job.keyword 和 job 进行 terms 聚合分桶的总数并不一样, 对 性别的 keyword 进行聚合, 指定size不同工种中年纪最大的3个员工的具体信息, 嵌套聚合1按照工作类型分桶并统计工资信息, 多次嵌套。根据工作类型分桶然后按照性别分桶计算工资的统计信息, 平均工资最低的工作类型, 平均工资最高的工作类型, 平均工资的平均工资, 平均工资的统计分析, 平均工资的百分位数, Query, 设置blog的 Mapping, 插入一条 Blog 信息, 查询 Blog 信息, 电影的Mapping信息, 写入一条电影信息, 查询电影信息, 创建 Nested 对象 Mapping, Nested 查询, Nested Aggregation, 普通 aggregation不工作, 设定 Parentx2FChild Mapping, 查询所有文档, Parent Id 查询, Has Child 查询返回父文档, Has Parent 查询返回相关的子文档, Data Modeling Example, Index 一本书的信息, Index 一本书的信息包含Content, Cookie Service, Nested 查询通过bool查询进行过滤, 在Mapping中加入元信息便于管理, 优化使用inner object, 通过 bool 查询, Not Null 解决聚合的问题, 修改 kibana.yml, Use your own email address, Assign the user to two roles read_only_orders and kibana_user, 生成证书, 为您的Elasticearch集群创建一个证书颁发机构。例如使用elasticsearch-certutil ca命令：, elasticsearch.yml 配置, 9.1-常见的集群部署方式.md, 常见的集群部署方式, 9.2-HotampWarm架构与ShardFiltering.md, Hot amp Warm 架构与 Shard Filtering, 课程代码, 9.3-如何对集群进行容量规划.md, 如何对集群进行容量规划, 代码Demo, 9.4-分片设计及管理.md, 分片设计及管理, 9.5-在私有云上管理与部署Elasticsearch集群.md, 在私有云上管理与部署 Elasticsearch 集群, 9.6-在公有云上管理与部署Elasticsearch集群.md, 在公有云上管理与部署 Elasticsearch 集群, result.md, 10.1-生产环境常用配置与上线清单.md, 生产环境查用配置与线上清单, 10.10-一些运维相关的建议.md, 一些运维相关的建议, 10.2-监控Elasticsearch集群.md, 监控 Elasticsearch 集群, 10.3-诊断集群的潜在问题.md, 诊断集群的潜在问题, 10.4-解决集群Yellow与Red的问题.md, 集群健康与问题排查, 10.5-提升集群写性能.md, 提升集群写性能, 10.6-提升集群读性能.md, 提升集群读性能, 10.7-集群压力测试.md, 集群压力测试, 10.9-缓存及使用Breaker限制内存使用.md, 缓存及使用Circuit Breaker限制内存使用, 补充阅读, 11.1-使用Shrink与RolloverAPI有效管理时间序列索引.md, 使用 shrink与rolloverAPI有效的管理索引, 11.2-索引全生命周期管理及工具介绍.md, 索引全生命周期管理及工具介绍, 12.1-Logstash入门及架构介绍.md, Logstash 入门及架构介绍, 12.2-利用JDBC插件导入数据到Elasticsearch.md, Logstash插件及文档介绍, 12.3-Beats介绍.md, Beats介绍, 13.1-使用IndexPattern配置数据.md, 13.2-使用KibanaDiscover探索数据.md, 使用Kibana Discovery 探索数据, 13.3-基本可视化组件介绍.md, 基本可视化组件介绍, 13.4-构建Dashboard.md, 构建Dashboard, 14.3用机器学习实现时序数据的异常检测-上.md, 14.5-用ELK进行日志管理.md, 用 ELK 来做日志管理, 14.6-用Canvas做数据演示.md, 4.1-基于词项和基于全文的搜索.md, 基于词项和基于全文的搜索, 4.10-综合排序：Function Score Query 优化算分.md, 综合排序：Function Score Query 优化算分, 4.12-自动补全与基于上下文的提示.md, 自动补全与基于上下文的提示, 4.13-跨集群搜索.md, 跨集群搜索, 4.2-结构化搜索.md, 结构化搜索, 4.3-搜索的相关性算分.md, 搜索的相关性算分, 4.4-QueryampFiltering实现多字符串多字段查询.md, Query amp Filtering 与多字符串多字段查询, 4.5-单字符串多字段查询-DisMaxQuery.md, 单字符串多字段查询：Dis Max Query, 4.6-单字符串多字段查询-Multi-Match.md, 单字符串多字段查询：Multi Match, 4.7-多语言及中文分词与检索.md, 多语言及中文分词与检索, 相关资源, 一些分词工具供参考：, 4.8-SpaceJam一个全文搜索的实例.md, Space Jam一次全文搜索的实例, 环境要求, 进入 tmdb-search目录, 相关, 4.9-使用SearchTemplate和IndexAlias进行查询.md, 使用 Search Template 和 Index Alias 查询, 5.1-集群分布式模型及选主与脑裂问题.md, 集群分布式模型及选主与脑裂问题, 5.2-分片与集群的故障转移.md, 分片与集群的故障转移, 5.3-文档分布式存储.md, 文档分布式存储, 5.4-分片及其生命周期.md, 分片及其生命周期, 5.5-剖析分布式查询及相关性评分.md, 剖析分布式查询及相关性评分, 5.6-排序及DocValuesampFielddata.md, 排序及Doc Values amp Fielddata, 5.7-分页与遍历-FromSizeampSearchAfterampScrollAPI.md, 分页与遍历 - From Size Search_after amp Scroll API, 5.8-处理并发读写.md, 处理并发读写操作, 6.1-BucketampMetric聚合分析及嵌套聚合.md, Bucket amp Metric Aggregation, demos, 6.2-Pipeline聚合分析.md, Pipeline 聚合分析, 6.3-作用范围与排序.md, 作用范围与排序, 6.4-聚合分析的原理及精准度问题.md, 聚合分析的原理及精准度问题, 7.1-对象及 Nested 对象.md, 对象及Nested对象, 7.2-文档的父子关系.md, 文档的父子关系, 7.5-Elasticsearch数据建模实例.md, Elasticsearch 数据建模实例, 7.6-Elasticsearch 数据建模最佳实践.md, Elasticsearch 数据建模最佳实践, 7.7-第二部分总结与测验.md, 第二部分总结与测验, 8.1-集群身份认证与用户鉴权.md, 集群身份认证与用户鉴权, 8.2-集群内部安全通信.md, , 8.3-集群与外部间的安全通信.md, 9.1-常见的集群部署方式.md, 常见的集群部署方式, 9.2-HotampWarm架构与ShardFiltering.md, Hot amp Warm 架构与 Shard Filtering, 课程代码以下是优化过的笔记已加入注释并调整格式使其更符合标准集群管理与优化笔记移动分片到另一个节点索引名称分片编号源节点目标节点强制分配未分配的分片带原因说明索引名称分片编号目标节点从集群中移除节点要排除的节点强制执行同步刷新调整集群平衡时移动的分片数量同时平衡的分片数调整每个节点同时恢复的分片数量每个节点并行恢复的分片数调整恢复速度恢复速率调整单节点恢复时并发流数量单节点恢复时的并发流数调整搜索队列大小搜索队列大小清除节点缓存调整断路器配置设置内存断路器的总内存限制监控集群节点统计集群统计索引统计查看待处理的集群任务查看所有任务支持取消任务查看节点的线程池信息设置索引慢日志设置索引慢日志阈值警告级别信息级别调试级别跟踪级别日志源的最大字符数设置查询慢日志查询慢日志警告级别查询慢日志信息级别查询慢日志调试级别查询慢日志跟踪级别获取慢日志警告级别获取慢日志信息级别获取慢日志调试级别获取慢日志跟踪级别解决集群与状态问题检查集群健康状态查看索引级别健康状态找出红色索引查看分片级别健康状态解释索引分片无法分配的原因删除并重新创建索引分片数副本数指定节点类型提升集群写性能设置优化写入性能的索引设置刷新间隔分片数每个节点的最大分片数事务日志同步间隔异步持久化副本数禁用动态映射提升集群读性能示例查询优化集群压力测试安装并配置执行简单的压力测试执行完整数据测试使用缓存与限制内存使用获取节点统计信息设置内存限制设置请求断路器内存限制使用与管理索引索引索引索引全生命周期管理及工具介绍索引全生命周期管理及工具介绍运行三个节点分片将设置成和具体参考下下的文件设置秒刷新次生产环境分种刷新一次设置设置索引模版创建索引对写入文档入门及架构介绍入门及架构介绍一个运行数据多行数据异常一个实例利用插件导入数据到插件及文档介绍新增用户查看所有的用户更新用户删除用户创建只显示没有被标记的用户通过查询查不到被标记成的用户介绍介绍查看模块设置的模块启动运行安装配置启动修改打开和监控查看所有模块查看所有的使用配置数据使用探索数据使用探索数据设置时间过滤器搜索你的数据根据字段进行过滤查看文档数据查看文档上下文暂时字段数据统计基本可视化组件介绍基本可视化组件介绍构建构建创建仪表潘加载仪表盘共享仪表盘用机器学习实现时序数据的异常检测上用进行日志管理用来做日志管理进编辑相应的文件修改路径用做数据演示基于词项和基于全文的搜索基于词项和基于全文的搜索设置综合排序优化算分综合排序优化算分自动补全与基于上下文的提示自动补全与基于上下文的提示跨集群搜索跨集群搜索启动个集群在每个集群上设置动态的设置创建测试数据查询结构化搜索结构化搜索结构化搜索精确匹配对布尔值查询有算分对布尔值通过转成没有算分数字类型数字类型数字查询日期查询处理多值字段处理多值字段查询是包含而不是等于字符类型对布尔数值搜索的相关性算分搜索的相关性算分实现多字符串多字段查询与多字符串多字段查询基本语法改变数据模型增加字段解决数组包含而不是精确匹配的问题有算分不参与算分结果的是嵌套实现了逻辑单字符串多字段查询单字符串多字段查询单字符串多字段查询单字符串多字段查询多语言及中文分词与检索多语言及中文分词与检索来到杨过曾经生活过的地方小龙女动情地说我也想过过过儿过过的生活你也想犯范范玮琪犯过的错吗校长说衣服上除了校徽别别别的这几天天天天气不好我背有点驼麻麻说你的背得背背背背佳虽然通过使用英语分析器使得匹配规则更加宽松我们也因此提高了召回率但却降低了精准匹配文档的能力为了获得两方面的优势我们可以使用多字段对字段建立两次索引一次使用英语分析器另一次使用标准分析器安装插件安装插件默认分词标准分词索引分词分词最短路分词最短路分词分词在已开始废弃极速词典分词剑桥分析公司多位高管对卧底记者说他们确保了唐纳德特朗普在总统大选中获胜刘德华张学友郭富城黎明四大天王相关资源分词插件分词插件分词算法综述一些分词工具供参考中科院计算所分词器哈工大的清华大学斯坦福分词器分词器结巴分词分词器字嵌入一个全文搜索的实例一次全文搜索的实例环境要求可以使用管理多个版本可选进入目录相关安装安装安装使用和进行查询使用和查询集群分布式模型及选主与脑裂问题集群分布式模型及选主与脑裂问题分片与集群的故障转移分片与集群的故障转移文档分布式存储文档分布式存储分片及其生命周期分片及其生命周期剖析分布式查询及相关性评分剖析分布式查询及相关性评分排序及排序及单字段排序多字段排序对字段进行排序默认会报错需打开打开的关闭的打开后查看数据查看整型字段的分页与遍历分页与遍历处理并发读写处理并发读写操作聚合分析及嵌套聚合聚合找到最低的工资聚合找到最高的工资多个聚合找到最低最高和平均工资一个聚合输出多值对进行聚合对字段进行聚合查询失败对字段打开支持对字段进行分词分词后的对和进行聚合分桶的总数并不一样对性别的进行聚合指定的指定不同工种中年纪最大的个员工的具体信息分桶可以自己定义工资到万以一个区间进行分桶嵌套聚合按照工作类型分桶并统计工资信息多次嵌套根据工作类型分桶然后按照性别分桶计算工资的统计信息聚合分析聚合分析平均工资最低的工作类型平均工资最高的工作类型平均工资的平均工资平均工资的统计分析平均工资的百分位数按照年龄对平均工资求导作用范围与排序作用范围与排序一条语句找出所有的类型还能找到聚合后符合条件的结果排序排序排序聚合分析的原理及精准度问题聚合分析的原理及精准度问题对象及对象对象及对象设置的插入一条信息查询信息电影的信息写入一条电影信息查询电影信息创建对象查询普通不工作文档的父子关系文档的父子关系设定索引父文档索引父文档索引子文档索引子文档索引子文档查询所有文档根据父文档查看查询查询返回父文档查询返回相关的子文档通过访问子文档通过和访问子文档更新子文档数据建模实例数据建模实例一本书的信息查询自动创建的优化字段类型设置成无法对该字段进行搜索设置成依然支持聚合分析新增字段数据量很大选择将关闭一本书的信息包含查询结果中不包含数据搜索通过字段显示数据同时高亮显示的内容数据建模最佳实践数据建模最佳实践索引数据会不断加入新增字段使用对象增加写入数据使用和合适类型的字段查询通过查询进行过滤在中加入元信息便于管理优化使用通过写入多个文档通过查询解决聚合的问题第二部分总结与测验第二部分总结与测验集群身份认证与用户鉴权集群身份认证与用户鉴权如何为集群启用如何为内置用户设置密码设置与通信鉴权使用安全创建对特定索引具有有限访问权限的用户启动单节点使用访问或者浏览器访问返回错误运行密码设定的命令设置内置用户及其初始密码修改启动使用用户名密码验证读权限可以执行验证写权限报错集群内部安全通信生成证书为您的集群创建一个证书颁发机构例如使用命令为群集中的每个节点生成证书和私钥例如使用命令将证书拷贝到目录下不提供证书的节点无法加入配置集群与外部间的安全通信启用连接为生成为配置生成后解压包含了和常见的集群部署方式常见的集群部署方式架构与架构与课程代码标记一个节点标记一个节点查看节点配置到节点配置到节点标记一个标记一个标记一个标记一个集群黄色副本无法分配如何对集群进行容量规划如何对集群进行容量规划代码分片设计及管理分片设计及管理在私有云上管理与部署集群在私有云上管理与部署集群在公有云上管理与部署集群在公有云上管理与部署集群生产环境常用配置与上线清单生产环境查用配置与线上清单一些运维相关的建议一些运维相关的建议移动一个分片从一个节点到另外一个节点监控集群监控集群查看所有的也支持设置设置查询诊断集群的潜在问题诊断集群的潜在问题解决集群与的问题集群健康与问题排查案例检查集群状态查看是否有节点丢失有多少分片无法分配查看索引级别找到红色的索引查看索引的分片变红的原因案例看上的提升集群写性能提升集群写性能提升集群读性能提升集群读性能集群压力测试集群压力测试只测试条数据测试完整数据缓存及使用限制内存使用缓存及使用限制内存使用补充阅读使用与有效管理时间序列索引使用与有效的管理索引打开关闭索引查看索引是否存在关闭索引索引存在无法查询打开索引在一个的集群上进行测试分片数会失败报错因为没有置成将设置为只读报错必须都在一个节点确保分片都在设置为只读状态为也只读必须是倍数必须是只读设置为只读不设定名字符合命名规范多次写入文档查看信息设置需要指定的名字查看信息索引全生命周期管理及工具介绍索引全生命周期管理及工具介绍运行三个节点分片将设置成和具体参考下下的文件设置秒刷新次生产环境分种刷新一次设置设置索引模版创建索引对写入文档入门及架构介绍入门及架构介绍一个运行数据多行数据异常一个实例利用插件导入数据到插件及文档介绍新增用户查看所有的用户更新用户删除用户创建只显示没有被标记的用户通过查询查不到被标记成的用户介绍介绍查看模块设置的模块启动运行安装配置启动修改打开和监控查看所有模块查看所有的使用配置数据使用探索数据使用探索数据设置时间过滤器搜索你的数据根据字段进行过滤查看文档数据查看文档上下文暂时字段数据统计基本可视化组件介绍基本可视化组件介绍构建构建创建仪表潘加载仪表盘共享仪表盘用机器学习实现时序数据的异常检测上用进行日志管理用来做日志管理进编辑相应的文件修改路径用做数据演示基于词项和基于全文的搜索基于词项和基于全文的搜索设置综合排序优化算分综合排序优化算分自动补全与基于上下文的提示自动补全与基于上下文的提示跨集群搜索跨集群搜索启动个集群在每个集群上设置动态的设置创建测试数据查询结构化搜索结构化搜索结构化搜索精确匹配对布尔值查询有算分对布尔值通过转成没有算分数字类型数字类型数字查询日期查询处理多值字段处理多值字段查询是包含而不是等于字符类型对布尔数值搜索的相关性算分搜索的相关性算分实现多字符串多字段查询与多字符串多字段查询基本语法改变数据模型增加字段解决数组包含而不是精确匹配的问题有算分不参与算分结果的是嵌套实现了逻辑单字符串多字段查询单字符串多字段查询单字符串多字段查询单字符串多字段查询多语言及中文分词与检索多语言及中文分词与检索来到杨过曾经生活过的地方小龙女动情地说我也想过过过儿过过的生活你也想犯范范玮琪犯过的错吗校长说衣服上除了校徽别别别的这几天天天天气不好我背有点驼麻麻说你的背得背背背背佳虽然通过使用英语分析器使得匹配规则更加宽松我们也因此提高了召回率但却降低了精准匹配文档的能力为了获得两方面的优势我们可以使用多字段对字段建立两次索引一次使用英语分析器另一次使用标准分析器安装插件安装插件默认分词标准分词索引分词分词最短路分词最短路分词分词在已开始废弃极速词典分词剑桥分析公司多位高管对卧底记者说他们确保了唐纳德特朗普在总统大选中获胜刘德华张学友郭富城黎明四大天王相关资源分词插件分词插件分词算法综述一些分词工具供参考中科院计算所分词器哈工大的清华大学斯坦福分词器分词器结巴分词分词器字嵌入一个全文搜索的实例一次全文搜索的实例环境要求可以使用管理多个版本可选进入目录相关安装安装安装使用和进行查询使用和查询集群分布式模型及选主与脑裂问题集群分布式模型及选主与脑裂问题分片与集群的故障转移分片与集群的故障转移文档分布式存储文档分布式存储分片及其生命周期分片及其生命周期剖析分布式查询及相关性评分剖析分布式查询及相关性评分排序及排序及单字段排序多字段排序对字段进行排序默认会报错需打开打开的关闭的打开后查看数据查看整型字段的分页与遍历分页与遍历处理并发读写处理并发读写操作聚合分析及嵌套聚合聚合找到最低的工资聚合找到最高的工资多个聚合找到最低最高和平均工资一个聚合输出多值对进行聚合对字段进行聚合查询失败对字段打开支持对字段进行分词分词后的对和进行聚合分桶的总数并不一样对性别的进行聚合指定的指定不同工种中年纪最大的个员工的具体信息分桶可以自己定义工资到万以一个区间进行分桶嵌套聚合按照工作类型分桶并统计工资信息多次嵌套根据工作类型分桶然后按照性别分桶计算工资的统计信息聚合分析聚合分析平均工资最低的工作类型平均工资最高的工作类型平均工资的平均工资平均工资的统计分析平均工资的百分位数按照年龄对平均工资求导作用范围与排序作用范围与排序一条语句找出所有的类型还能找到聚合后符合条件的结果排序排序排序聚合分析的原理及精准度问题聚合分析的原理及精准度问题对象及对象对象及对象设置的插入一条信息查询信息电影的信息写入一条电影信息查询电影信息创建对象查询普通不工作文档的父子关系文档的父子关系设定索引父文档索引父文档索引子文档索引子文档索引子文档查询所有文档根据父文档查看查询查询返回父文档查询返回相关的子文档通过访问子文档通过和访问子文档更新子文档数据建模实例数据建模实例一本书的信息查询自动创建的优化字段类型设置成无法对该字段进行搜索设置成依然支持聚合分析新增字段数据量很大选择将关闭一本书的信息包含查询结果中不包含数据搜索通过字段显示数据同时高亮显示的内容数据建模最佳实践数据建模最佳实践索引数据会不断加入新增字段使用对象增加写入数据使用和合适类型的字段查询通过查询进行过滤在中加入元信息便于管理优化使用通过写入多个文档通过查询解决聚合的问题第二部分总结与测验第二部分总结与测验集群身份认证与用户鉴权集群身份认证与用户鉴权如何为集群启用如何为内置用户设置密码设置与通信鉴权使用安全创建对特定索引具有有限访问权限的用户启动单节点使用访问或者浏览器访问返回错误运行密码设定的命令设置内置用户及其初始密码修改启动使用用户名密码验证读权限可以执行验证写权限报错集群内部安全通信生成证书为您的集群创建一个证书颁发机构例如使用命令为群集中的每个节点生成证书和私钥例如使用命令将证书拷贝到目录下不提供证书的节点无法加入配置集群与外部间的安全通信启用连接为生成为配置生成后解压包含了和常见的集群部署方式常见的集群部署方式架构与架构与课程代码标记一个节点标记一个节点查看节点配置到节点配置到节点标记一个标记一个标记一个标记一个集群黄色副本无法分配',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-02-27 16:42:54',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">点到为止</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/JNI/" style="font-size: 1.05rem;">JNI<sup>1</sup></a><a href="/tags/chrome/" style="font-size: 1.05rem;">chrome<sup>2</sup></a><a href="/tags/docker/" style="font-size: 1.05rem;">docker<sup>1</sup></a><a href="/tags/docker%E9%83%A8%E7%BD%B2/" style="font-size: 1.05rem;">docker部署<sup>1</sup></a><a href="/tags/git/" style="font-size: 1.05rem;">git<sup>1</sup></a><a href="/tags/k8s/" style="font-size: 1.05rem;">k8s<sup>1</sup></a><a href="/tags/lua%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 1.05rem;">lua表达式<sup>1</sup></a><a href="/tags/nginx/" style="font-size: 1.05rem;">nginx<sup>2</sup></a><a href="/tags/openvpn/" style="font-size: 1.05rem;">openvpn<sup>2</sup></a><a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 1.05rem;">事务<sup>1</sup></a><a href="/tags/%E4%BA%A4%E6%98%93%E7%AD%96%E7%95%A5/" style="font-size: 1.05rem;">交易策略<sup>1</sup></a><a href="/tags/%E5%91%BD%E4%BB%A4/" style="font-size: 1.05rem;">命令<sup>1</sup></a><a href="/tags/%E5%A4%87%E4%BB%BD/" style="font-size: 1.05rem;">备份<sup>2</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 1.05rem;">学习笔记<sup>2</sup></a><a href="/tags/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" style="font-size: 1.05rem;">常用命令<sup>1</sup></a><a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 1.05rem;">并发<sup>1</sup></a><a href="/tags/%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/" style="font-size: 1.05rem;">开机自启<sup>1</sup></a><a href="/tags/%E6%89%93%E5%8D%B0%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97/" style="font-size: 1.05rem;">打印异常日志<sup>1</sup></a><a href="/tags/%E6%89%A9%E5%AE%B9%E7%A3%81%E7%9B%98/" style="font-size: 1.05rem;">扩容磁盘<sup>2</sup></a><a href="/tags/%E6%8A%A5%E8%AD%A6/" style="font-size: 1.05rem;">报警<sup>1</sup></a><a href="/tags/%E6%9F%A5%E6%89%BE%E8%BF%9B%E7%A8%8B/" style="font-size: 1.05rem;">查找进程<sup>1</sup></a><a href="/tags/%E6%BC%8F%E6%B4%9E/" style="font-size: 1.05rem;">漏洞<sup>1</sup></a><a href="/tags/%E7%8A%B6%E6%80%81%E6%9C%BA/" style="font-size: 1.05rem;">状态机<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%AB%99%E8%B5%84%E6%BA%90/" style="font-size: 1.05rem;">网站资源<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>1</sup></a><a href="/tags/%E7%BF%BB%E5%A2%99/" style="font-size: 1.05rem;">翻墙<sup>1</sup></a><a href="/tags/%E8%87%AA%E5%AD%A6%E5%85%AC%E5%BC%8F/" style="font-size: 1.05rem;">自学公式<sup>1</sup></a><a href="/tags/%E8%B4%A6%E6%88%B7%E8%B5%84%E9%87%91/" style="font-size: 1.05rem;">账户资金<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">十月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/03/"><span class="card-archive-list-date">三月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/02/"><span class="card-archive-list-date">二月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/08/"><span class="card-archive-list-date">八月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/elasticsearch/" itemprop="url">elasticsearch</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>学习笔记</span></a></span></div></div><h1 class="post-title" itemprop="name headline">es高级命令</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-02-27T08:05:47.000Z" title="发表于 2025-02-27 16:05:47">2025-02-27</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-02-27T08:42:54.317Z" title="更新于 2025-02-27 16:42:54">2025-02-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://candyadmin.github.io/elasticsearch/es%E9%AB%98%E7%BA%A7%E5%91%BD%E4%BB%A4/"><header><a class="post-meta-categories" href="/categories/elasticsearch/" itemprop="url">elasticsearch</a><a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" tabindex="-1" itemprop="url">学习笔记</a><h1 id="CrawlerTitle" itemprop="name headline">es高级命令</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">candy</span><time itemprop="dateCreated datePublished" datetime="2025-02-27T08:05:47.000Z" title="发表于 2025-02-27 16:05:47">2025-02-27</time><time itemprop="dateCreated datePublished" datetime="2025-02-27T08:42:54.317Z" title="更新于 2025-02-27 16:42:54">2025-02-27</time></header><p>以下是优化过的笔记，已加入注释并调整格式，使其更符合Markdown标准：</p>
<hr>
<h1 id="Elasticsearch-集群管理与优化笔记"><a href="#Elasticsearch-集群管理与优化笔记" class="headerlink" title="Elasticsearch 集群管理与优化笔记"></a>Elasticsearch 集群管理与优化笔记</h1><h2 id="1-移动分片到另一个节点"><a href="#1-移动分片到另一个节点" class="headerlink" title="1. 移动分片到另一个节点"></a>1. 移动分片到另一个节点</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST _cluster/reroute</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;commands&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;move&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;index_name&quot;</span>,   <span class="comment"># 索引名称</span></span><br><span class="line">        <span class="string">&quot;shard&quot;</span>: 0,               <span class="comment"># 分片编号</span></span><br><span class="line">        <span class="string">&quot;from_node&quot;</span>: <span class="string">&quot;node_name_1&quot;</span>, <span class="comment"># 源节点</span></span><br><span class="line">        <span class="string">&quot;to_node&quot;</span>: <span class="string">&quot;node_name_2&quot;</span>   <span class="comment"># 目标节点</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-强制分配未分配的分片（带原因说明）"><a href="#2-强制分配未分配的分片（带原因说明）" class="headerlink" title="2. 强制分配未分配的分片（带原因说明）"></a>2. 强制分配未分配的分片（带原因说明）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST _cluster/reroute?explain</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;commands&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;allocate&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;index&quot;</span>: <span class="string">&quot;index_name&quot;</span>,   <span class="comment"># 索引名称</span></span><br><span class="line">        <span class="string">&quot;shard&quot;</span>: 0,              <span class="comment"># 分片编号</span></span><br><span class="line">        <span class="string">&quot;node&quot;</span>: <span class="string">&quot;nodename&quot;</span>       <span class="comment"># 目标节点</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-从集群中移除节点"><a href="#3-从集群中移除节点" class="headerlink" title="3. 从集群中移除节点"></a>3. 从集群中移除节点</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;transient&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.exclude._ip&quot;</span>: <span class="string">&quot;the_IP_of_your_node&quot;</span>   <span class="comment"># 要排除的节点IP</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-强制执行同步刷新"><a href="#4-强制执行同步刷新" class="headerlink" title="4. 强制执行同步刷新"></a>4. 强制执行同步刷新</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST _flush/synced</span><br></pre></td></tr></table></figure>

<h2 id="5-调整集群平衡时移动的分片数量"><a href="#5-调整集群平衡时移动的分片数量" class="headerlink" title="5. 调整集群平衡时移动的分片数量"></a>5. 调整集群平衡时移动的分片数量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;transient&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.cluster_concurrent_rebalance&quot;</span>: 2   <span class="comment"># 同时平衡的分片数</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-调整每个节点同时恢复的分片数量"><a href="#6-调整每个节点同时恢复的分片数量" class="headerlink" title="6. 调整每个节点同时恢复的分片数量"></a>6. 调整每个节点同时恢复的分片数量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;transient&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;cluster.routing.allocation.node_concurrent_recoveries&quot;</span>: 5   <span class="comment"># 每个节点并行恢复的分片数</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-调整恢复速度"><a href="#7-调整恢复速度" class="headerlink" title="7. 调整恢复速度"></a>7. 调整恢复速度</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;transient&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;indices.recovery.max_bytes_per_sec&quot;</span>: <span class="string">&quot;80mb&quot;</span>   <span class="comment"># 恢复速率</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8-调整单节点恢复时并发流数量"><a href="#8-调整单节点恢复时并发流数量" class="headerlink" title="8. 调整单节点恢复时并发流数量"></a>8. 调整单节点恢复时并发流数量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;transient&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;indices.recovery.concurrent_streams&quot;</span>: 6   <span class="comment"># 单节点恢复时的并发流数</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="9-调整搜索队列大小"><a href="#9-调整搜索队列大小" class="headerlink" title="9. 调整搜索队列大小"></a>9. 调整搜索队列大小</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;transient&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;threadpool.search.queue_size&quot;</span>: 2000   <span class="comment"># 搜索队列大小</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="10-清除节点缓存"><a href="#10-清除节点缓存" class="headerlink" title="10. 清除节点缓存"></a>10. 清除节点缓存</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST _cache/clear</span><br></pre></td></tr></table></figure>

<h2 id="11-调整断路器配置"><a href="#11-调整断路器配置" class="headerlink" title="11. 调整断路器配置"></a>11. 调整断路器配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;persistent&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;indices.breaker.total.limit&quot;</span>: <span class="string">&quot;40%&quot;</span>   <span class="comment"># 设置内存断路器的总内存限制</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="监控-Elasticsearch-集群"><a href="#监控-Elasticsearch-集群" class="headerlink" title="监控 Elasticsearch 集群"></a>监控 Elasticsearch 集群</h1><h2 id="1-节点统计"><a href="#1-节点统计" class="headerlink" title="1. 节点统计"></a>1. 节点统计</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _nodes/stats</span><br></pre></td></tr></table></figure>

<h2 id="2-集群统计"><a href="#2-集群统计" class="headerlink" title="2. 集群统计"></a>2. 集群统计</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cluster/stats</span><br></pre></td></tr></table></figure>

<h2 id="3-索引统计"><a href="#3-索引统计" class="headerlink" title="3. 索引统计"></a>3. 索引统计</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET kibana_sample_data_ecommerce/_stats</span><br></pre></td></tr></table></figure>

<h2 id="4-查看待处理的集群任务"><a href="#4-查看待处理的集群任务" class="headerlink" title="4. 查看待处理的集群任务"></a>4. 查看待处理的集群任务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cluster/pending_tasks</span><br></pre></td></tr></table></figure>

<h2 id="5-查看所有任务，支持取消任务"><a href="#5-查看所有任务，支持取消任务" class="headerlink" title="5. 查看所有任务，支持取消任务"></a>5. 查看所有任务，支持取消任务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _tasks</span><br></pre></td></tr></table></figure>

<h2 id="6-查看节点的线程池信息"><a href="#6-查看节点的线程池信息" class="headerlink" title="6. 查看节点的线程池信息"></a>6. 查看节点的线程池信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET _nodes/thread_pool</span><br><span class="line">GET _nodes/stats/thread_pool</span><br><span class="line">GET _cat/thread_pool?v</span><br><span class="line">GET _nodes/hot_threads</span><br><span class="line">GET _nodes/stats/thread_pool</span><br></pre></td></tr></table></figure>

<h2 id="7-设置索引慢日志（Slowlog）"><a href="#7-设置索引慢日志（Slowlog）" class="headerlink" title="7. 设置索引慢日志（Slowlog）"></a>7. 设置索引慢日志（Slowlog）</h2><ul>
<li><p>设置索引慢日志阈值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;index.indexing.slowlog&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;threshold.index&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;warn&quot;</span>: <span class="string">&quot;10s&quot;</span>,    <span class="comment"># 警告级别</span></span><br><span class="line">      <span class="string">&quot;info&quot;</span>: <span class="string">&quot;4s&quot;</span>,     <span class="comment"># 信息级别</span></span><br><span class="line">      <span class="string">&quot;debug&quot;</span>: <span class="string">&quot;2s&quot;</span>,    <span class="comment"># 调试级别</span></span><br><span class="line">      <span class="string">&quot;trace&quot;</span>: <span class="string">&quot;0s&quot;</span>     <span class="comment"># 跟踪级别</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;level&quot;</span>: <span class="string">&quot;trace&quot;</span>,</span><br><span class="line">    <span class="string">&quot;source&quot;</span>: 1000   <span class="comment"># 日志源的最大字符数</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置查询慢日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_index</span><br><span class="line">PUT my_index/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index.search.slowlog.threshold&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;query.warn&quot;</span>: <span class="string">&quot;10s&quot;</span>,   <span class="comment"># 查询慢日志警告级别</span></span><br><span class="line">      <span class="string">&quot;query.info&quot;</span>: <span class="string">&quot;3s&quot;</span>,    <span class="comment"># 查询慢日志信息级别</span></span><br><span class="line">      <span class="string">&quot;query.debug&quot;</span>: <span class="string">&quot;2s&quot;</span>,   <span class="comment"># 查询慢日志调试级别</span></span><br><span class="line">      <span class="string">&quot;query.trace&quot;</span>: <span class="string">&quot;0s&quot;</span>,   <span class="comment"># 查询慢日志跟踪级别</span></span><br><span class="line">      <span class="string">&quot;fetch.warn&quot;</span>: <span class="string">&quot;1s&quot;</span>,    <span class="comment"># 获取慢日志警告级别</span></span><br><span class="line">      <span class="string">&quot;fetch.info&quot;</span>: <span class="string">&quot;600ms&quot;</span>, <span class="comment"># 获取慢日志信息级别</span></span><br><span class="line">      <span class="string">&quot;fetch.debug&quot;</span>: <span class="string">&quot;400ms&quot;</span>,<span class="comment"># 获取慢日志调试级别</span></span><br><span class="line">      <span class="string">&quot;fetch.trace&quot;</span>: <span class="string">&quot;0s&quot;</span>    <span class="comment"># 获取慢日志跟踪级别</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h1 id="解决集群-Yellow-与-Red-状态问题"><a href="#解决集群-Yellow-与-Red-状态问题" class="headerlink" title="解决集群 Yellow 与 Red 状态问题"></a>解决集群 Yellow 与 Red 状态问题</h1><h2 id="1-检查集群健康状态"><a href="#1-检查集群健康状态" class="headerlink" title="1. 检查集群健康状态"></a>1. 检查集群健康状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cluster/health/</span><br></pre></td></tr></table></figure>

<h2 id="2-查看索引级别健康状态，找出红色索引"><a href="#2-查看索引级别健康状态，找出红色索引" class="headerlink" title="2. 查看索引级别健康状态，找出红色索引"></a>2. 查看索引级别健康状态，找出红色索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cluster/health?level=indices</span><br></pre></td></tr></table></figure>

<h2 id="3-查看分片级别健康状态"><a href="#3-查看分片级别健康状态" class="headerlink" title="3. 查看分片级别健康状态"></a>3. 查看分片级别健康状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET _cluster/health?level=shards</span><br></pre></td></tr></table></figure>

<h2 id="4-解释索引分片无法分配的原因"><a href="#4-解释索引分片无法分配的原因" class="headerlink" title="4. 解释索引分片无法分配的原因"></a>4. 解释索引分片无法分配的原因</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cluster/allocation/explain</span><br></pre></td></tr></table></figure>

<h2 id="5-删除并重新创建索引"><a href="#5-删除并重新创建索引" class="headerlink" title="5. 删除并重新创建索引"></a>5. 删除并重新创建索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELETE mytest</span><br><span class="line">PUT mytest</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;number_of_shards&quot;</span>: 3,    <span class="comment"># 分片数</span></span><br><span class="line">    <span class="string">&quot;number_of_replicas&quot;</span>: 0,   <span class="comment"># 副本数</span></span><br><span class="line">    <span class="string">&quot;index.routing.allocation.require.box_type&quot;</span>: <span class="string">&quot;hot&quot;</span>   <span class="comment"># 指定节点类型</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="提升集群写性能"><a href="#提升集群写性能" class="headerlink" title="提升集群写性能"></a>提升集群写性能</h1><h2 id="1-设置优化写入性能的索引设置"><a href="#1-设置优化写入性能的索引设置" class="headerlink" title="1. 设置优化写入性能的索引设置"></a>1. 设置优化写入性能的索引设置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">DELETE myindex</span><br><span class="line">PUT myindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;refresh_interval&quot;</span>: <span class="string">&quot;30s&quot;</span>,     <span class="comment"># 刷新间隔</span></span><br><span class="line">      <span class="string">&quot;number_of_shards&quot;</span>: <span class="string">&quot;2&quot;</span>        <span class="comment"># 分片数</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;allocation&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;total_shards_per_node&quot;</span>: <span class="string">&quot;3&quot;</span> <span class="comment"># 每个节点的最大分片数</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;translog&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;sync_interval&quot;</span>: <span class="string">&quot;30s&quot;</span>,         <span class="comment"># 事务日志同步间隔</span></span><br><span class="line">      <span class="string">&quot;durability&quot;</span>: <span class="string">&quot;async&quot;</span>           <span class="comment"># 异步持久化</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;number_of_replicas&quot;</span>: 0          <span class="comment"># 副本数</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;dynamic&quot;</span>: <span class="literal">false</span>,                <span class="comment"># 禁用动态映射</span></span><br><span class="line">    <span class="string">&quot;properties&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="提升集群读性能"><a href="#提升集群读性能" class="headerlink" title="提升集群读性能"></a>提升集群读性能</h1><h2 id="1-示例：查询优化"><a href="#1-示例：查询优化" class="headerlink" title="1. 示例：查询优化"></a>1. 示例：查询优化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">PUT blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;title&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;<span class="string">&quot;match&quot;</span>: &#123; <span class="string">&quot;title&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span> &#125;&#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;source&quot;</span>: <span class="string">&quot;doc[&#x27;title.keyword&#x27;].value.length()&gt;5&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">        &#123;<span class="string">&quot;match&quot;</span>: &#123;<span class="string">&quot;title&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span>&#125;&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;publish_date&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;gte&quot;</span>: 2017,</span><br><span class="line">              <span class="string">&quot;lte&quot;</span>: 2019</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="集群压力测试"><a href="#集群压力测试" class="headerlink" title="集群压力测试"></a>集群压力测试</h1><h2 id="1-安装并配置-esrally"><a href="#1-安装并配置-esrally" class="headerlink" title="1. 安装并配置 esrally"></a>1. 安装并配置 esrally</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install esrally</span><br><span class="line">esrally configure</span><br></pre></td></tr></table></figure>

<h2 id="2-执行简单的压力测试"><a href="#2-执行简单的压力测试" class="headerlink" title="2. 执行简单的压力测试"></a>2. 执行简单的压力测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esrally --distribution-version=7.1.0 --test-mode</span><br></pre></td></tr></table></figure>

<h2 id="3-执行完整数据测试"><a href="#3-执行完整数据测试" class="headerlink" title="3. 执行完整数据测试"></a>3. 执行完整数据测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esrally --distribution-version=7.1.0</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="使用缓存与-Breaker-限制内存使用"><a href="#使用缓存与-Breaker-限制内存使用" class="headerlink" title="使用缓存与 Breaker 限制内存使用"></a>使用缓存与 Breaker 限制内存使用</h1><h2 id="1-获取节点统计信息"><a href="#1-获取节点统计信息" class="headerlink" title="1. 获取节点统计信息"></a>1. 获取节点统计信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET _cat/nodes?v</span><br><span class="line">GET _nodes/stats/indices?pretty</span><br><span class="line">GET _cat/nodes?v&amp;h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,request_cache.miss_count</span><br></pre></td></tr></table></figure>

<h2 id="2-设置内存限制"><a href="#2-设置内存限制" class="headerlink" title="2. 设置内存限制"></a>2. 设置内存限制</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;persistent&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;indices.breaker.request.limit&quot;</span>: <span class="string">&quot;90%&quot;</span>   <span class="comment"># 设置请求断路器内存限制</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="使用-Shrink-与-Rollover-API-管理索引"><a href="#使用-Shrink-与-Rollover-API-管理索引" class="headerlink" title="使用 Shrink 与 Rollover API 管理索引"></a>使用 Shrink 与 Rollover API 管理索引</h1><h2 id="1-Shrink-索引"><a href="#1-Shrink-索引" class="headerlink" title="1. Shrink 索引"></a>1. Shrink 索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST my_source_index/_shrink/my_target_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;index.number_of_replicas&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;index.number_of_shards&quot;</span>: 2,</span><br><span class="line">    <span class="string">&quot;index.codec&quot;</span>: <span class="string">&quot;best_compression&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;aliases&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;my_search_indices&quot;</span>: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Rollover-索引"><a href="#2-Rollover-索引" class="headerlink" title="2. Rollover 索引"></a>2. Rollover 索引</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST nginx_logs_write/_rollover</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;conditions&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;max_age&quot;</span>: <span class="string">&quot;1d&quot;</span>,</span><br><span class="line">    <span class="string">&quot;max_docs&quot;</span>: 5,</span><br><span class="line">    <span class="string">&quot;max_size&quot;</span>: <span class="string">&quot;5gb&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 11.2-索引全生命周期管理及工具介绍.md</span><br><span class="line"></span><br><span class="line"># 索引全生命周期管理及工具介绍</span><br></pre></td></tr></table></figure>

<h1 id="运行三个节点，分片-将box-type设置成-hot，warm和cold"><a href="#运行三个节点，分片-将box-type设置成-hot，warm和cold" class="headerlink" title="运行三个节点，分片 将box_type设置成 hot，warm和cold"></a>运行三个节点，分片 将box_type设置成 hot，warm和cold</h1><h1 id="具体参考-github下，docker-hot-warm-cold-下的docker-compose-文件"><a href="#具体参考-github下，docker-hot-warm-cold-下的docker-compose-文件" class="headerlink" title="具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件"></a>具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件</h1><p>DELETE *</p>
<h1 id="设置-1秒刷新1次，生产环境10分种刷新一次"><a href="#设置-1秒刷新1次，生产环境10分种刷新一次" class="headerlink" title="设置 1秒刷新1次，生产环境10分种刷新一次"></a>设置 1秒刷新1次，生产环境10分种刷新一次</h1><p>PUT _cluster&#x2F;settings<br>{<br>  “persistent”: {<br>    “indices.lifecycle.poll_interval”:”1s”<br>  }<br>}</p>
<h1 id="设置-Policy"><a href="#设置-Policy" class="headerlink" title="设置 Policy"></a>设置 Policy</h1><p>PUT &#x2F;_ilm&#x2F;policy&#x2F;log_ilm_policy<br>{<br>  “policy”: {<br>    “phases”: {<br>      “hot”: {<br>        “actions”: {<br>          “rollover”: {<br>            “max_docs”: 5<br>          }<br>        }<br>      },<br>      “warm”: {<br>        “min_age”: “10s”,<br>        “actions”: {<br>          “allocate”: {<br>            “include”: {<br>              “box_type”: “warm”<br>            }<br>          }<br>        }<br>      },<br>      “cold”: {<br>        “min_age”: “15s”,<br>        “actions”: {<br>          “allocate”: {<br>            “include”: {<br>              “box_type”: “cold”<br>            }<br>          }<br>        }<br>      },<br>      “delete”: {<br>        “min_age”: “20s”,<br>        “actions”: {<br>          “delete”: {}<br>        }<br>      }<br>    }<br>  }<br>}</p>
<h1 id="设置索引模版"><a href="#设置索引模版" class="headerlink" title="设置索引模版"></a>设置索引模版</h1><p>PUT &#x2F;_template&#x2F;log_ilm_template<br>{<br>  “index_patterns” : [<br>      “ilm_index-*”<br>    ],<br>    “settings” : {<br>      “index” : {<br>        “lifecycle” : {<br>          “name” : “log_ilm_policy”,<br>          “rollover_alias” : “ilm_alias”<br>        },<br>        “routing” : {<br>          “allocation” : {<br>            “include” : {<br>              “box_type” : “hot”<br>            }<br>          }<br>        },<br>        “number_of_shards” : “1”,<br>        “number_of_replicas” : “0”<br>      }<br>    },<br>    “mappings” : { },<br>    “aliases” : { }<br>}</p>
<p>#创建索引<br>PUT ilm_index-000001<br>{<br>  “settings”: {<br>    “number_of_shards”: 1,<br>    “number_of_replicas”: 0,<br>    “index.lifecycle.name”: “log_ilm_policy”,<br>    “index.lifecycle.rollover_alias”: “ilm_alias”,<br>    “index.routing.allocation.include.box_type”:”hot”<br>  },<br>  “aliases”: {<br>    “ilm_alias”: {<br>      “is_write_index”: true<br>    }<br>  }<br>}</p>
<h1 id="对-Alias写入文档"><a href="#对-Alias写入文档" class="headerlink" title="对 Alias写入文档"></a>对 Alias写入文档</h1><p>POST  ilm_alias&#x2F;_doc<br>{<br>  “dfd”:”dfdsf”<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 12.1-Logstash入门及架构介绍.md</span><br><span class="line"></span><br><span class="line"># Logstash 入门及架构介绍</span><br></pre></td></tr></table></figure>


<h1 id="一个-Demo，-demo-运行"><a href="#一个-Demo，-demo-运行" class="headerlink" title="一个 Demo， demo 运行"></a>一个 Demo， demo 运行</h1><p>sudo bin&#x2F;logstash -f logstash-filter.conf</p>
<h1 id="demo数据"><a href="#demo数据" class="headerlink" title="demo数据"></a>demo数据</h1><p>127.0.0.1 - - [11&#x2F;Dec&#x2F;2013:00:01:45 -0800] “GET &#x2F;xampp&#x2F;status.php HTTP&#x2F;1.1” 200 3891 “<a target="_blank" rel="noopener" href="http://cadenza/xampp/navi.php">http://cadenza/xampp/navi.php</a>“ “Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko&#x2F;20100101 Firefox&#x2F;25.0”</p>
<h1 id="codec-demo"><a href="#codec-demo" class="headerlink" title="codec demo"></a>codec demo</h1><p>sudo bin&#x2F;logstash -e “input{stdin{codec&#x3D;&gt;line}}output{stdout{codec&#x3D;&gt; rubydebug}}”<br>sudo bin&#x2F;logstash -e “input{stdin{codec&#x3D;&gt;json}}output{stdout{codec&#x3D;&gt; rubydebug}}”<br>sudo bin&#x2F;logstash -e “input{stdin{codec&#x3D;&gt;line}}output{stdout{codec&#x3D;&gt; dots}}”</p>
<p>sudo bin&#x2F;logstash -f multiline-exception.conf</p>
<h1 id="多行数据，异常"><a href="#多行数据，异常" class="headerlink" title="多行数据，异常"></a>多行数据，异常</h1><p>Exception in thread “main” java.lang.NullPointerException<br>        at com.example.myproject.Book.getTitle(Book.java:16)<br>        at com.example.myproject.Author.getBookTitles(Author.java:25)<br>        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</p>
<h1 id="一个实例"><a href="#一个实例" class="headerlink" title="一个实例"></a>一个实例</h1><p><a target="_blank" rel="noopener" href="https://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf">https://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 12.2-利用JDBC插件导入数据到Elasticsearch.md</span><br><span class="line"></span><br><span class="line"># Logstash插件及文档介绍</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://spring.io/guides/gs/accessing-data-mysql/">https://spring.io/guides/gs/accessing-data-mysql/</a><br>create database db_example;<br>use db_example;<br>show tables;<br>drop table user;<br>select * from user;</p>
<h1 id="新增用户"><a href="#新增用户" class="headerlink" title="新增用户"></a>新增用户</h1><p>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Mike -d email&#x3D;<a href="mailto:&#x6d;&#x69;&#x6b;&#x65;&#x40;&#120;&#121;&#x7a;&#46;&#99;&#111;&#x6d;">&#x6d;&#x69;&#x6b;&#x65;&#x40;&#120;&#121;&#x7a;&#46;&#99;&#111;&#x6d;</a> -d tags&#x3D;Elasticsearch,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Jack -d email&#x3D;<a href="mailto:&#106;&#x61;&#99;&#x6b;&#x40;&#120;&#x79;&#x7a;&#x2e;&#x63;&#111;&#109;">&#106;&#x61;&#99;&#x6b;&#x40;&#120;&#x79;&#x7a;&#x2e;&#x63;&#111;&#109;</a> -d tags&#x3D;Mysql,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Bob -d email&#x3D;<a href="mailto:&#98;&#111;&#x62;&#x40;&#120;&#x79;&#x7a;&#46;&#x63;&#111;&#109;">&#98;&#111;&#x62;&#x40;&#120;&#x79;&#x7a;&#46;&#x63;&#111;&#109;</a> -d tags&#x3D;Mysql,IntelliJ</p>
<p>#查看所有的用户<br>curl ‘localhost:8080&#x2F;demo&#x2F;all’</p>
<h1 id="更新用户"><a href="#更新用户" class="headerlink" title="更新用户"></a>更新用户</h1><p>curl -X PUT localhost:8080&#x2F;demo&#x2F;update -d id&#x3D;16 -d name&#x3D;Bob2 -d email&#x3D;<a href="mailto:&#98;&#111;&#x62;&#x32;&#x40;&#120;&#121;&#122;&#46;&#99;&#111;&#109;">&#98;&#111;&#x62;&#x32;&#x40;&#120;&#121;&#122;&#46;&#99;&#111;&#109;</a> -d tags&#x3D;Mysql,IntelliJ</p>
<h1 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h1><p>curl -X DELETE localhost:8080&#x2F;demo&#x2F;delete -d id&#x3D;15</p>
<p>mysql-demo.conf</p>
<h1 id="创建-alias，只显示没有被标记-deleted的用户"><a href="#创建-alias，只显示没有被标记-deleted的用户" class="headerlink" title="创建 alias，只显示没有被标记 deleted的用户"></a>创建 alias，只显示没有被标记 deleted的用户</h1><p>POST &#x2F;_aliases<br>{<br>  “actions”: [<br>    {<br>      “add”: {<br>        “index”: “users”,<br>        “alias”: “view_users”,<br>         “filter” : { “term” : { “is_deleted” : false } }<br>      }<br>    }<br>  ]<br>}</p>
<h1 id="通过-Alias查询，查不到被标记成-deleted的用户"><a href="#通过-Alias查询，查不到被标记成-deleted的用户" class="headerlink" title="通过 Alias查询，查不到被标记成 deleted的用户"></a>通过 Alias查询，查不到被标记成 deleted的用户</h1><p>POST view_users&#x2F;_search<br>{</p>
<p>}</p>
<p>POST view_users&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “name.keyword”: {<br>        “value”: “Jack”<br>      }<br>    }<br>  }<br>}</p>
<p>POST users&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “name.keyword”: {<br>        “value”: “Jack”<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 12.3-Beats介绍.md</span><br><span class="line"></span><br><span class="line"># Beats介绍</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h1 id="查看-packetbeat-模块"><a href="#查看-packetbeat-模块" class="headerlink" title="查看 packetbeat 模块"></a>查看 packetbeat 模块</h1><h1 id="设置-packetbeat-的mysql-模块"><a href="#设置-packetbeat-的mysql-模块" class="headerlink" title="设置 packetbeat 的mysql 模块"></a>设置 packetbeat 的mysql 模块</h1><h1 id="启动运行"><a href="#启动运行" class="headerlink" title="启动运行"></a>启动运行</h1><h1 id="-1"><a href="#-1" class="headerlink" title=""></a></h1><p>.&#x2F;metricbeat modules list<br>.&#x2F;metricbeat modules enable mysql<br>.&#x2F;metricbeat setup –dashboards</p>
<h1 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h1><p>create database db_example<br>use db_example;<br>show tables;<br>select * from user</p>
<p>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Mike -d email&#x3D;<a href="mailto:&#x6d;&#105;&#x6b;&#101;&#64;&#120;&#121;&#x7a;&#x2e;&#x63;&#111;&#x6d;">&#x6d;&#105;&#x6b;&#101;&#64;&#120;&#121;&#x7a;&#x2e;&#x63;&#111;&#x6d;</a> -d tags&#x3D;Elasticsearch,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Jack -d email&#x3D;<a href="mailto:&#x6a;&#97;&#x63;&#x6b;&#64;&#x78;&#121;&#122;&#x2e;&#x63;&#111;&#109;">&#x6a;&#97;&#x63;&#x6b;&#64;&#x78;&#121;&#122;&#x2e;&#x63;&#111;&#109;</a> -d tags&#x3D;Mysql,IntelliJ<br>curl localhost:8080&#x2F;demo&#x2F;add -d name&#x3D;Bob -d email&#x3D;<a href="mailto:&#98;&#x6f;&#x62;&#64;&#120;&#121;&#x7a;&#46;&#99;&#x6f;&#x6d;">&#98;&#x6f;&#x62;&#64;&#120;&#121;&#x7a;&#46;&#99;&#x6f;&#x6d;</a> -d tags&#x3D;Mysql,IntelliJ</p>
<p>curl ‘localhost:8080&#x2F;demo&#x2F;all’</p>
<h1 id="配置-packetbeat"><a href="#配置-packetbeat" class="headerlink" title="配置 packetbeat"></a>配置 packetbeat</h1><h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><p>修改 packetbeat，打开 http 5601 9200 和 mysql 3306监控</p>
<p>sudo chown root packetbeat.yml<br>sudo .&#x2F;packetbeat setup –dashboards<br>sudo .&#x2F;packetbeat</p>
<h1 id="查看所有-Filebeat-模块"><a href="#查看所有-Filebeat-模块" class="headerlink" title="查看所有 Filebeat 模块"></a>查看所有 Filebeat 模块</h1><h1 id="查看所有的modules"><a href="#查看所有的modules" class="headerlink" title="查看所有的modules"></a>查看所有的modules</h1><p>.&#x2F;filebeat modules list</p>
<h1 id="-2"><a href="#-2" class="headerlink" title=""></a></h1><p>.&#x2F;filebeat modules enable mysql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 13.1-使用IndexPattern配置数据.md</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>localhost:5601&#x2F;status</p>
<p>PUT &#x2F;logstash-2015.05.18<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “geo”: {<br>        “properties”: {<br>          “coordinates”: {<br>            “type”: “geo_point”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>PUT &#x2F;logstash-2015.05.19<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “geo”: {<br>        “properties”: {<br>          “coordinates”: {<br>            “type”: “geo_point”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>PUT &#x2F;logstash-2015.05.20<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “geo”: {<br>        “properties”: {<br>          “coordinates”: {<br>            “type”: “geo_point”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<h1 id="For-Mac-Windows"><a href="#For-Mac-Windows" class="headerlink" title="For Mac &amp; Windows"></a>For Mac &amp; Windows</h1><p>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;_bulk?pretty’ –data-binary @logs.jsonl</p>
<p>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;bank&#x2F;account&#x2F;_bulk?pretty’ –data-binary @accounts.json</p>
<p>#For Windows<br>Invoke-RestMethod “<a target="_blank" rel="noopener" href="http://localhost:9200/_bulk?pretty">http://localhost:9200/_bulk?pretty</a>“ -Method Post -ContentType ‘application&#x2F;x-ndjson’ -InFile “logs.jsonl”</p>
<p>GET &#x2F;_cat&#x2F;indices?v</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 13.2-使用KibanaDiscover探索数据.md</span><br><span class="line"></span><br><span class="line"># 使用Kibana Discovery 探索数据</span><br></pre></td></tr></table></figure>

<p>设置时间过滤器<br>搜索你的数据<br>根据字段进行过滤<br>查看文档数据<br>查看文档上下文<br>暂时字段数据统计<br>Save Query</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 13.3-基本可视化组件介绍.md</span><br><span class="line"></span><br><span class="line"># 基本可视化组件介绍</span><br></pre></td></tr></table></figure>

<p>PUT &#x2F;shakespeare<br>{<br>  “mappings”: {<br>    “properties”: {<br>    “speaker”: {“type”: “keyword”},<br>    “play_name”: {“type”: “keyword”},<br>    “line_id”: {“type”: “integer”},<br>    “speech_number”: {“type”: “integer”}<br>    }<br>  }<br>}</p>
<h1 id="For-Mac-Windows-1"><a href="#For-Mac-Windows-1" class="headerlink" title="For Mac &amp; Windows"></a>For Mac &amp; Windows</h1><p>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;bank&#x2F;account&#x2F;_bulk?pretty’ –data-binary @accounts.json<br>curl -H ‘Content-Type: application&#x2F;x-ndjson’ -XPOST ‘localhost:9200&#x2F;shakespeare&#x2F;_bulk?pretty’ –data-binary @shakespeare.json</p>
<p>#For Windows<br>Invoke-RestMethod “<a target="_blank" rel="noopener" href="http://localhost:9200/bank/account/_bulk?pretty">http://localhost:9200/bank/account/_bulk?pretty</a>“ -Method Post -ContentType ‘application&#x2F;x-ndjson’ -InFile “accounts.json”<br>Invoke-RestMethod “<a target="_blank" rel="noopener" href="http://localhost:9200/shakespeare/_bulk?pretty">http://localhost:9200/shakespeare/_bulk?pretty</a>“ -Method Post -ContentType ‘application&#x2F;x-ndjson’ -InFile “shakespeare.json”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 13.4-构建Dashboard.md</span><br><span class="line"></span><br><span class="line"># 构建Dashboard</span><br></pre></td></tr></table></figure>
<ul>
<li>创建仪表潘</li>
<li>加载仪表盘</li>
<li>共享仪表盘</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 14.3用机器学习实现时序数据的异常检测-上.md</span><br><span class="line"></span><br><span class="line">mkdir server_metrics</span><br><span class="line">cd server_metrics</span><br><span class="line">wget https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz</span><br><span class="line">tar -xvf server_metrics.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 14.5-用ELK进行日志管理.md</span><br><span class="line"></span><br><span class="line"># 用 ELK 来做日志管理</span><br></pre></td></tr></table></figure>
<p>.&#x2F;filebeat modules list<br>.&#x2F;filebeat modules enable system<br>.&#x2F;filebeat modules enable elasticsearch</p>
<h2 id="进-modules-d-编辑相应的文件，修改log路径"><a href="#进-modules-d-编辑相应的文件，修改log路径" class="headerlink" title="进 modules.d 编辑相应的文件，修改log路径"></a>进 modules.d 编辑相应的文件，修改log路径</h2><p>.&#x2F;filebeat setup –dashboards</p>
<p>.&#x2F;filebeat export template | more</p>
<p>.&#x2F;filebeat -e</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 14.6-用Canvas做数据演示.md</span><br><span class="line"></span><br><span class="line">POST elasticoffee/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0, </span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;by&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;beverage.keyword&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 4.1-基于词项和基于全文的搜索.md</span><br><span class="line"></span><br><span class="line"># 基于词项和基于全文的搜索</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>DELETE products<br>PUT products<br>{<br>  “settings”: {<br>    “number_of_shards”: 1<br>  }<br>}</p>
<p>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “productID” : “XHDK-A-1293-#fJ3”,”desc”:”iPhone” }<br>{ “index”: { “_id”: 2 }}<br>{ “productID” : “KDKE-B-9947-#kL5”,”desc”:”iPad” }<br>{ “index”: { “_id”: 3 }}<br>{ “productID” : “JODL-X-1937-#pV7”,”desc”:”MBP” }</p>
<p>GET &#x2F;products</p>
<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “desc”: {<br>        &#x2F;&#x2F;“value”: “iPhone”<br>        “value”:”iphone”<br>      }<br>    }<br>  }<br>}</p>
<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “desc.keyword”: {<br>        &#x2F;&#x2F;“value”: “iPhone”<br>        &#x2F;&#x2F;“value”:”iphone”<br>      }<br>    }<br>  }<br>}</p>
<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “productID”: {<br>        “value”: “XHDK-A-1293-#fJ3”<br>      }<br>    }<br>  }<br>}</p>
<p>POST &#x2F;products&#x2F;_search<br>{<br>  &#x2F;&#x2F;“explain”: true,<br>  “query”: {<br>    “term”: {<br>      “productID.keyword”: {<br>        “value”: “XHDK-A-1293-#fJ3”<br>      }<br>    }<br>  }<br>}</p>
<p>POST &#x2F;products&#x2F;_search<br>{<br>  “explain”: true,<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “productID.keyword”: “XHDK-A-1293-#fJ3”<br>        }<br>      }</p>
<pre><code>&#125;
</code></pre>
<p>  }<br>}</p>
<p>#设置 position_increment_gap<br>DELETE groups<br>PUT groups<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “names”:{<br>        “type”: “text”,<br>        “position_increment_gap”: 0<br>      }<br>    }<br>  }<br>}</p>
<p>GET groups&#x2F;_mapping</p>
<p>POST groups&#x2F;_doc<br>{<br>  “names”: [ “John Water”, “Water Smith”]<br>}</p>
<p>POST groups&#x2F;_search<br>{<br>  “query”: {<br>    “match_phrase”: {<br>      “names”: {<br>        “query”: “Water Water”,<br>        “slop”: 100<br>      }<br>    }<br>  }<br>}</p>
<p>POST groups&#x2F;_search<br>{<br>  “query”: {<br>    “match_phrase”: {<br>      “names”: “Water Smith”<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 4.10-综合排序：Function Score Query 优化算分.md</span><br><span class="line"></span><br><span class="line"># 综合排序：Function Score Query 优化算分</span><br></pre></td></tr></table></figure>
<p>DELETE blogs<br>PUT &#x2F;blogs&#x2F;_doc&#x2F;1<br>{<br>  “title”:   “About popularity”,<br>  “content”: “In this post we will talk about…”,<br>  “votes”:   0<br>}</p>
<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;2<br>{<br>  “title”:   “About popularity”,<br>  “content”: “In this post we will talk about…”,<br>  “votes”:   100<br>}</p>
<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;3<br>{<br>  “title”:   “About popularity”,<br>  “content”: “In this post we will talk about…”,<br>  “votes”:   1000000<br>}</p>
<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”<br>      }<br>    }<br>  }<br>}</p>
<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”,<br>        “modifier”: “log1p”<br>      }<br>    }<br>  }<br>}</p>
<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”,<br>        “modifier”: “log1p” ,<br>        “factor”: 0.1<br>      }<br>    }<br>  }<br>}</p>
<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “query”: {<br>        “multi_match”: {<br>          “query”:    “popularity”,<br>          “fields”: [ “title”, “content” ]<br>        }<br>      },<br>      “field_value_factor”: {<br>        “field”: “votes”,<br>        “modifier”: “log1p” ,<br>        “factor”: 0.1<br>      },<br>      “boost_mode”: “sum”,<br>      “max_boost”: 3<br>    }<br>  }<br>}</p>
<p>POST &#x2F;blogs&#x2F;_search<br>{<br>  “query”: {<br>    “function_score”: {<br>      “random_score”: {<br>        “seed”: 911119<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 4.12-自动补全与基于上下文的提示.md</span><br><span class="line"></span><br><span class="line"># 自动补全与基于上下文的提示</span><br></pre></td></tr></table></figure>
<p>DELETE articles<br>PUT articles<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “title_completion”:{<br>        “type”: “completion”<br>      }<br>    }<br>  }<br>}</p>
<p>POST articles&#x2F;_bulk<br>{ “index” : { } }<br>{ “title_completion”: “lucene is very cool”}<br>{ “index” : { } }<br>{ “title_completion”: “Elasticsearch builds on top of lucene”}<br>{ “index” : { } }<br>{ “title_completion”: “Elasticsearch rocks”}<br>{ “index” : { } }<br>{ “title_completion”: “elastic is the company behind ELK stack”}<br>{ “index” : { } }<br>{ “title_completion”: “Elk stack rocks”}<br>{ “index” : {} }</p>
<p>POST articles&#x2F;_search?pretty<br>{<br>  “size”: 0,<br>  “suggest”: {<br>    “article-suggester”: {<br>      “prefix”: “elk “,<br>      “completion”: {<br>        “field”: “title_completion”<br>      }<br>    }<br>  }<br>}</p>
<p>DELETE comments<br>PUT comments<br>PUT comments&#x2F;_mapping<br>{<br>  “properties”: {<br>    “comment_autocomplete”:{<br>      “type”: “completion”,<br>      “contexts”:[{<br>        “type”:”category”,<br>        “name”:”comment_category”<br>      }]<br>    }<br>  }<br>}</p>
<p>POST comments&#x2F;_doc<br>{<br>  “comment”:”I love the star war movies”,<br>  “comment_autocomplete”:{<br>    “input”:[“star wars”],<br>    “contexts”:{<br>      “comment_category”:”movies”<br>    }<br>  }<br>}</p>
<p>POST comments&#x2F;_doc<br>{<br>  “comment”:”Where can I find a Starbucks”,<br>  “comment_autocomplete”:{<br>    “input”:[“starbucks”],<br>    “contexts”:{<br>      “comment_category”:”coffee”<br>    }<br>  }<br>}</p>
<p>POST comments&#x2F;_search<br>{<br>  “suggest”: {<br>    “MY_SUGGESTION”: {<br>      “prefix”: “sta”,<br>      “completion”:{<br>        “field”:”comment_autocomplete”,<br>        “contexts”:{<br>          “comment_category”:”coffee”<br>        }<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 4.13-跨集群搜索.md</span><br><span class="line"></span><br><span class="line"># 跨集群搜索</span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F;启动3个集群</p>
<p>bin&#x2F;elasticsearch -E node.name&#x3D;cluster0node -E cluster.name&#x3D;cluster0 -E path.data&#x3D;cluster0_data -E discovery.type&#x3D;single-node -E http.port&#x3D;9200 -E transport.port&#x3D;9300<br>bin&#x2F;elasticsearch -E node.name&#x3D;cluster1node -E cluster.name&#x3D;cluster1 -E path.data&#x3D;cluster1_data -E discovery.type&#x3D;single-node -E http.port&#x3D;9201 -E transport.port&#x3D;9301<br>bin&#x2F;elasticsearch -E node.name&#x3D;cluster2node -E cluster.name&#x3D;cluster2 -E path.data&#x3D;cluster2_data -E discovery.type&#x3D;single-node -E http.port&#x3D;9202 -E transport.port&#x3D;9302</p>
<p>&#x2F;&#x2F;在每个集群上设置动态的设置<br>PUT _cluster&#x2F;settings<br>{<br>  “persistent”: {<br>    “cluster”: {<br>      “remote”: {<br>        “cluster0”: {<br>          “seeds”: [<br>            “127.0.0.1:9300”<br>          ],<br>          “transport.ping_schedule”: “30s”<br>        },<br>        “cluster1”: {<br>          “seeds”: [<br>            “127.0.0.1:9301”<br>          ],<br>          “transport.compress”: true,<br>          “skip_unavailable”: true<br>        },<br>        “cluster2”: {<br>          “seeds”: [<br>            “127.0.0.1:9302”<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>#cURL<br>curl -XPUT “<a target="_blank" rel="noopener" href="http://localhost:9200/_cluster/settings">http://localhost:9200/_cluster/settings</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“persistent”:{“cluster”:{“remote”:{“cluster0”:{“seeds”:[“127.0.0.1:9300”],”transport.ping_schedule”:”30s”},”cluster1”:{“seeds”:[“127.0.0.1:9301”],”transport.compress”:true,”skip_unavailable”:true},”cluster2”:{“seeds”:[“127.0.0.1:9302”]}}}}}’</p>
<p>curl -XPUT “<a target="_blank" rel="noopener" href="http://localhost:9201/_cluster/settings">http://localhost:9201/_cluster/settings</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“persistent”:{“cluster”:{“remote”:{“cluster0”:{“seeds”:[“127.0.0.1:9300”],”transport.ping_schedule”:”30s”},”cluster1”:{“seeds”:[“127.0.0.1:9301”],”transport.compress”:true,”skip_unavailable”:true},”cluster2”:{“seeds”:[“127.0.0.1:9302”]}}}}}’</p>
<p>curl -XPUT “<a target="_blank" rel="noopener" href="http://localhost:9202/_cluster/settings">http://localhost:9202/_cluster/settings</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“persistent”:{“cluster”:{“remote”:{“cluster0”:{“seeds”:[“127.0.0.1:9300”],”transport.ping_schedule”:”30s”},”cluster1”:{“seeds”:[“127.0.0.1:9301”],”transport.compress”:true,”skip_unavailable”:true},”cluster2”:{“seeds”:[“127.0.0.1:9302”]}}}}}’</p>
<p>#创建测试数据<br>curl -XPOST “<a target="_blank" rel="noopener" href="http://localhost:9200/users/_doc">http://localhost:9200/users/_doc</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“name”:”user1”,”age”:10}’</p>
<p>curl -XPOST “<a target="_blank" rel="noopener" href="http://localhost:9201/users/_doc">http://localhost:9201/users/_doc</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“name”:”user2”,”age”:20}’</p>
<p>curl -XPOST “<a target="_blank" rel="noopener" href="http://localhost:9202/users/_doc">http://localhost:9202/users/_doc</a>“ -H ‘Content-Type: application&#x2F;json’ -d’<br>{“name”:”user3”,”age”:30}’</p>
<p>#查询<br>GET &#x2F;users,cluster1:users,cluster2:users&#x2F;_search<br>{<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 20,<br>        “lte”: 40<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 4.2-结构化搜索.md</span><br><span class="line"></span><br><span class="line"># 结构化搜索</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>#结构化搜索，精确匹配<br>DELETE products<br>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “price” : 10,”avaliable”:true,”date”:”2018-01-01”, “productID” : “XHDK-A-1293-#fJ3” }<br>{ “index”: { “_id”: 2 }}<br>{ “price” : 20,”avaliable”:true,”date”:”2019-01-01”, “productID” : “KDKE-B-9947-#kL5” }<br>{ “index”: { “_id”: 3 }}<br>{ “price” : 30,”avaliable”:true, “productID” : “JODL-X-1937-#pV7” }<br>{ “index”: { “_id”: 4 }}<br>{ “price” : 30,”avaliable”:false, “productID” : “QQPX-R-3956-#aD8” }</p>
<p>GET products&#x2F;_mapping</p>
<p>#对布尔值 match 查询，有算分<br>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “avaliable”: true<br>    }<br>  }<br>}</p>
<p>#对布尔值，通过constant score 转成 filtering，没有算分<br>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “avaliable”: true<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>#数字类型 Term<br>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “price”: 30<br>    }<br>  }<br>}</p>
<p>#数字类型 terms<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “terms”: {<br>          “price”: [<br>            “20”,<br>            “30”<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>#数字 Range 查询<br>GET products&#x2F;_search<br>{<br>    “query” : {<br>        “constant_score” : {<br>            “filter” : {<br>                “range” : {<br>                    “price” : {<br>                        “gte” : 20,<br>                        “lte”  : 30<br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</p>
<h1 id="日期-range"><a href="#日期-range" class="headerlink" title="日期 range"></a>日期 range</h1><p>POST products&#x2F;_search<br>{<br>    “query” : {<br>        “constant_score” : {<br>            “filter” : {<br>                “range” : {<br>                    “date” : {<br>                      “gte” : “now-1y”<br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</p>
<p>#exists查询<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “exists”: {<br>          “field”: “date”<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>#处理多值字段<br>POST &#x2F;movies&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title” : “Father of the Bridge Part II”,”year”:1995, “genre”:”Comedy”}<br>{ “index”: { “_id”: 2 }}<br>{ “title” : “Dave”,”year”:1993,”genre”:[“Comedy”,”Romance”] }</p>
<p>#处理多值字段，term 查询是包含，而不是等于<br>POST movies&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “genre.keyword”: “Comedy”<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>#字符类型 terms<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “terms”: {<br>          “productID.keyword”: [<br>            “QQPX-R-3956-#aD8”,<br>            “JODL-X-1937-#pV7”<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “match”: {<br>      “price”: 30<br>    }<br>  }<br>}</p>
<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “date”: “2019-01-01”<br>    }<br>  }<br>}</p>
<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “match”: {<br>      “date”: “2019-01-01”<br>    }<br>  }<br>}</p>
<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “productID.keyword”: “XHDK-A-1293-#fJ3”<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “productID.keyword”: “XHDK-A-1293-#fJ3”<br>    }<br>  }<br>}</p>
<p>#对布尔数值<br>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “term”: {<br>          “avaliable”: “false”<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “avaliable”: {<br>        “value”: “false”<br>      }<br>    }<br>  }<br>}</p>
<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “price”: {<br>        “value”: “20”<br>      }<br>    }<br>  }<br>}</p>
<p>POST products&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “explain”: true,<br>  “query”: {<br>    “match”: {<br>      “price”: “20”<br>    }<br>    }<br>  }<br>}</p>
<p>POST products&#x2F;_search<br>{<br>  “query”: {<br>    “constant_score”: {<br>      “filter”: {<br>        “bool”: {<br>          “must_not”: {<br>            “exists”: {<br>              “field”: “date”<br>            }<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 4.3-搜索的相关性算分.md</span><br><span class="line"></span><br><span class="line"># 搜索的相关性算分</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>PUT testscore<br>{<br>  “settings”: {<br>    “number_of_shards”: 1<br>  },<br>  “mappings”: {<br>    “properties”: {<br>      “content”: {<br>        “type”: “text”<br>      }<br>    }<br>  }<br>}</p>
<p>PUT testscore&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “content”:”we use Elasticsearch to power the search” }<br>{ “index”: { “_id”: 2 }}<br>{ “content”:”we like elasticsearch” }<br>{ “index”: { “_id”: 3 }}<br>{ “content”:”The scoring of documents is caculated by the scoring formula” }<br>{ “index”: { “_id”: 4 }}<br>{ “content”:”you know, for search” }</p>
<p>POST &#x2F;testscore&#x2F;_search<br>{<br>  &#x2F;&#x2F;“explain”: true,<br>  “query”: {<br>    “match”: {<br>      “content”:”you”<br>      &#x2F;&#x2F;“content”: “elasticsearch”<br>      &#x2F;&#x2F;“content”:”the”<br>      &#x2F;&#x2F;“content”: “the elasticsearch”<br>    }<br>  }<br>}</p>
<p>POST testscore&#x2F;_search<br>{<br>    “query”: {<br>        “boosting” : {<br>            “positive” : {<br>                “term” : {<br>                    “content” : “elasticsearch”<br>                }<br>            },<br>            “negative” : {<br>                 “term” : {<br>                     “content” : “like”<br>                }<br>            },<br>            “negative_boost” : 0.2<br>        }<br>    }<br>}</p>
<p>POST tmdb&#x2F;_search<br>{<br>  “_source”: [“title”,”overview”],<br>  “query”: {<br>    “more_like_this”: {<br>      “fields”: [<br>        “title^10”,”overview”<br>      ],<br>      “like”: [{“_id”:”14191”}],<br>      “min_term_freq”: 1,<br>      “max_query_terms”: 12<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 4.4-Query&amp;Filtering实现多字符串多字段查询.md</span><br><span class="line"></span><br><span class="line"># Query &amp; Filtering 与多字符串多字段查询</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “price” : 10,”avaliable”:true,”date”:”2018-01-01”, “productID” : “XHDK-A-1293-#fJ3” }<br>{ “index”: { “_id”: 2 }}<br>{ “price” : 20,”avaliable”:true,”date”:”2019-01-01”, “productID” : “KDKE-B-9947-#kL5” }<br>{ “index”: { “_id”: 3 }}<br>{ “price” : 30,”avaliable”:true, “productID” : “JODL-X-1937-#pV7” }<br>{ “index”: { “_id”: 4 }}<br>{ “price” : 30,”avaliable”:false, “productID” : “QQPX-R-3956-#aD8” }</p>
<p>#基本语法<br>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “bool” : {<br>      “must” : {<br>        “term” : { “price” : “30” }<br>      },<br>      “filter”: {<br>        “term” : { “avaliable” : “true” }<br>      },<br>      “must_not” : {<br>        “range” : {<br>          “price” : { “lte” : 10 }<br>        }<br>      },<br>      “should” : [<br>        { “term” : { “productID.keyword” : “JODL-X-1937-#pV7” } },<br>        { “term” : { “productID.keyword” : “XHDK-A-1293-#fJ3” } }<br>      ],<br>      “minimum_should_match” :1<br>    }<br>  }<br>}</p>
<p>#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题<br>POST &#x2F;newmovies&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title” : “Father of the Bridge Part II”,”year”:1995, “genre”:”Comedy”,”genre_count”:1 }<br>{ “index”: { “_id”: 2 }}<br>{ “title” : “Dave”,”year”:1993,”genre”:[“Comedy”,”Romance”],”genre_count”:2 }</p>
<p>#must，有算分<br>POST &#x2F;newmovies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“term”: {“genre.keyword”: {“value”: “Comedy”}}},<br>        {“term”: {“genre_count”: {“value”: 1}}}</p>
<pre><code>  ]
&#125;
</code></pre>
<p>  }<br>}</p>
<p>#Filter。不参与算分，结果的score是0<br>POST &#x2F;newmovies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “filter”: [<br>        {“term”: {“genre.keyword”: {“value”: “Comedy”}}},<br>        {“term”: {“genre_count”: {“value”: 1}}}<br>        ]</p>
<pre><code>&#125;
</code></pre>
<p>  }<br>}</p>
<p>#Filtering Context<br>POST _search<br>{<br>  “query”: {<br>    “bool” : {</p>
<pre><code>  &quot;filter&quot;: &#123;
    &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;
  &#125;,
  &quot;must_not&quot; : &#123;
    &quot;range&quot; : &#123;
      &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<p>  }<br>}</p>
<p>#Query Context<br>POST &#x2F;products&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “price” : 10,”avaliable”:true,”date”:”2018-01-01”, “productID” : “XHDK-A-1293-#fJ3” }<br>{ “index”: { “_id”: 2 }}<br>{ “price” : 20,”avaliable”:true,”date”:”2019-01-01”, “productID” : “KDKE-B-9947-#kL5” }<br>{ “index”: { “_id”: 3 }}<br>{ “price” : 30,”avaliable”:true, “productID” : “JODL-X-1937-#pV7” }<br>{ “index”: { “_id”: 4 }}<br>{ “price” : 30,”avaliable”:false, “productID” : “QQPX-R-3956-#aD8” }</p>
<p>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        {<br>          “term”: {<br>            “productID.keyword”: {<br>              “value”: “JODL-X-1937-#pV7”}}<br>        },<br>        {“term”: {“avaliable”: {“value”: true}}<br>        }<br>      ]<br>    }<br>  }<br>}</p>
<p>#嵌套，实现了 should not 逻辑<br>POST &#x2F;products&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: {<br>        “term”: {<br>          “price”: “30”<br>        }<br>      },<br>      “should”: [<br>        {<br>          “bool”: {<br>            “must_not”: {<br>              “term”: {<br>                “avaliable”: “false”<br>              }<br>            }<br>          }<br>        }<br>      ],<br>      “minimum_should_match”: 1<br>    }<br>  }<br>}</p>
<p>#Controll the Precision<br>POST _search<br>{<br>  “query”: {<br>    “bool” : {<br>      “must” : {<br>        “term” : { “price” : “30” }<br>      },<br>      “filter”: {<br>        “term” : { “avaliable” : “true” }<br>      },<br>      “must_not” : {<br>        “range” : {<br>          “price” : { “lte” : 10 }<br>        }<br>      },<br>      “should” : [<br>        { “term” : { “productID.keyword” : “JODL-X-1937-#pV7” } },<br>        { “term” : { “productID.keyword” : “XHDK-A-1293-#fJ3” } }<br>      ],<br>      “minimum_should_match” :2<br>    }<br>  }<br>}</p>
<p>POST &#x2F;animals&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        { “term”: { “text”: “brown” }},<br>        { “term”: { “text”: “red” }},<br>        { “term”: { “text”: “quick”   }},<br>        { “term”: { “text”: “dog”   }}<br>      ]<br>    }<br>  }<br>}</p>
<p>POST &#x2F;animals&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        { “term”: { “text”: “quick” }},<br>        { “term”: { “text”: “dog”   }},<br>        {<br>          “bool”:{<br>            “should”:[<br>               { “term”: { “text”: “brown” }},<br>                 { “term”: { “text”: “brown” }},<br>            ]<br>          }</p>
<pre><code>    &#125;
  ]
&#125;
</code></pre>
<p>  }<br>}</p>
<p>DELETE blogs<br>POST &#x2F;blogs&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{“title”:”Apple iPad”, “content”:”Apple iPad,Apple iPad” }<br>{ “index”: { “_id”: 2 }}<br>{“title”:”Apple iPad,Apple iPad”, “content”:”Apple iPad” }</p>
<p>POST blogs&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “should”: [<br>        {“match”: {<br>          “title”: {<br>            “query”: “apple,ipad”,<br>            “boost”: 1.1<br>          }<br>        }},</p>
<pre><code>    &#123;&quot;match&quot;: &#123;
      &quot;content&quot;: &#123;
        &quot;query&quot;: &quot;apple,ipad&quot;,
        &quot;boost&quot;:
      &#125;
    &#125;&#125;
  ]
&#125;
</code></pre>
<p>  }<br>}</p>
<p>DELETE news<br>POST &#x2F;news&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “content”:”Apple Mac” }<br>{ “index”: { “_id”: 2 }}<br>{ “content”:”Apple iPad” }<br>{ “index”: { “_id”: 3 }}<br>{ “content”:”Apple employee like Apple Pie and Apple Juice” }</p>
<p>POST news&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: {<br>        “match”:{“content”:”apple”}<br>      }<br>    }<br>  }<br>}</p>
<p>POST news&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: {<br>        “match”:{“content”:”apple”}<br>      },<br>      “must_not”: {<br>        “match”:{“content”:”pie”}<br>      }<br>    }<br>  }<br>}</p>
<p>POST news&#x2F;_search<br>{<br>  “query”: {<br>    “boosting”: {<br>      “positive”: {<br>        “match”: {<br>          “content”: “apple”<br>        }<br>      },<br>      “negative”: {<br>        “match”: {<br>          “content”: “pie”<br>        }<br>      },<br>      “negative_boost”: 0.5<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 4.5-单字符串多字段查询-DisMaxQuery.md</span><br><span class="line"></span><br><span class="line"># 单字符串多字段查询：Dis Max Query</span><br></pre></td></tr></table></figure>

<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;1<br>{<br>    “title”: “Quick brown rabbits”,<br>    “body”:  “Brown rabbits are commonly seen.”<br>}</p>
<p>PUT &#x2F;blogs&#x2F;_doc&#x2F;2<br>{<br>    “title”: “Keeping pets healthy”,<br>    “body”:  “My quick brown fox eats rabbits on a regular basis.”<br>}</p>
<p>POST &#x2F;blogs&#x2F;_search<br>{<br>    “query”: {<br>        “bool”: {<br>            “should”: [<br>                { “match”: { “title”: “Brown fox” }},<br>                { “match”: { “body”:  “Brown fox” }}<br>            ]<br>        }<br>    }<br>}</p>
<p>POST blogs&#x2F;_search<br>{<br>    “query”: {<br>        “dis_max”: {<br>            “queries”: [<br>                { “match”: { “title”: “Quick pets” }},<br>                { “match”: { “body”:  “Quick pets” }}<br>            ]<br>        }<br>    }<br>}</p>
<p>POST blogs&#x2F;_search<br>{<br>    “query”: {<br>        “dis_max”: {<br>            “queries”: [<br>                { “match”: { “title”: “Quick pets” }},<br>                { “match”: { “body”:  “Quick pets” }}<br>            ],<br>            “tie_breaker”: 0.2<br>        }<br>    }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 4.6-单字符串多字段查询-Multi-Match.md</span><br><span class="line"></span><br><span class="line"># 单字符串多字段查询：Multi Match</span><br></pre></td></tr></table></figure>
<p>POST blogs&#x2F;_search<br>{<br>    “query”: {<br>        “dis_max”: {<br>            “queries”: [<br>                { “match”: { “title”: “Quick pets” }},<br>                { “match”: { “body”:  “Quick pets” }}<br>            ],<br>            “tie_breaker”: 0.2<br>        }<br>    }<br>}</p>
<p>POST blogs&#x2F;_search<br>{<br>  “query”: {<br>    “multi_match”: {<br>      “type”: “best_fields”,<br>      “query”: “Quick pets”,<br>      “fields”: [“title”,”body”],<br>      “tie_breaker”: 0.2,<br>      “minimum_should_match”: “20%”<br>    }<br>  }<br>}</p>
<p>POST books&#x2F;_search<br>{<br>    “multi_match”: {<br>        “query”:  “Quick brown fox”,<br>        “fields”: “*_title”<br>    }<br>}</p>
<p>POST books&#x2F;_search<br>{<br>    “multi_match”: {<br>        “query”:  “Quick brown fox”,<br>        “fields”: [ “*_title”, “chapter_title^2” ]<br>    }<br>}</p>
<p>DELETE &#x2F;titles<br>PUT &#x2F;titles<br>{<br>    “settings”: { “number_of_shards”: 1 },<br>    “mappings”: {<br>        “my_type”: {<br>            “properties”: {<br>                “title”: {<br>                    “type”:     “string”,<br>                    “analyzer”: “english”,<br>                    “fields”: {<br>                        “std”:   {<br>                            “type”:     “string”,<br>                            “analyzer”: “standard”<br>                        }<br>                    }<br>                }<br>            }<br>        }<br>    }<br>}</p>
<p>PUT &#x2F;titles<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “title”: {<br>        “type”: “text”,<br>        “analyzer”: “english”<br>      }<br>    }<br>  }<br>}</p>
<p>POST titles&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title”: “My dog barks” }<br>{ “index”: { “_id”: 2 }}<br>{ “title”: “I see a lot of barking dogs on the road “ }</p>
<p>GET titles&#x2F;_search<br>{<br>  “query”: {<br>    “match”: {<br>      “title”: “barking dogs”<br>    }<br>  }<br>}</p>
<p>DELETE &#x2F;titles<br>PUT &#x2F;titles<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “title”: {<br>        “type”: “text”,<br>        “analyzer”: “english”,<br>        “fields”: {“std”: {“type”: “text”,”analyzer”: “standard”}}<br>      }<br>    }<br>  }<br>}</p>
<p>POST titles&#x2F;_bulk<br>{ “index”: { “_id”: 1 }}<br>{ “title”: “My dog barks” }<br>{ “index”: { “_id”: 2 }}<br>{ “title”: “I see a lot of barking dogs on the road “ }</p>
<p>GET &#x2F;titles&#x2F;_search<br>{<br>   “query”: {<br>        “multi_match”: {<br>            “query”:  “barking dogs”,<br>            “type”:   “most_fields”,<br>            “fields”: [ “title”, “title.std” ]<br>        }<br>    }<br>}</p>
<p>GET &#x2F;titles&#x2F;_search<br>{<br>   “query”: {<br>        “multi_match”: {<br>            “query”:  “barking dogs”,<br>            “type”:   “most_fields”,<br>            “fields”: [ “title^10”, “title.std” ]<br>        }<br>    }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 4.7-多语言及中文分词与检索.md</span><br><span class="line"></span><br><span class="line"># 多语言及中文分词与检索</span><br><span class="line"></span><br><span class="line">- 来到杨过曾经生活过的地方，小龙女动情地说：“我也想过过过儿过过的生活。”</span><br><span class="line"></span><br><span class="line">- 你也想犯范范玮琪犯过的错吗</span><br><span class="line">- 校长说衣服上除了校徽别别别的</span><br><span class="line">- 这几天天天天气不好</span><br><span class="line">- 我背有点驼，麻麻说“你的背得背背背背佳</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>#stop word</p>
<p>DELETE my_index<br>PUT &#x2F;my_index&#x2F;_doc&#x2F;1<br>{ “title”: “I’m happy for this fox” }</p>
<p>PUT &#x2F;my_index&#x2F;_doc&#x2F;2<br>{ “title”: “I’m not happy about my fox problem” }</p>
<p>POST my_index&#x2F;_search<br>{<br>  “query”: {<br>    “match”: {<br>      “title”: “not happy fox”<br>    }<br>  }<br>}</p>
<p>#虽然通过使用 english （英语）分析器，使得匹配规则更加宽松，我们也因此提高了召回率，但却降低了精准匹配文档的能力。为了获得两方面的优势，我们可以使用multifields（多字段）对 title 字段建立两次索引： 一次使用 <code>english</code>（英语）分析器，另一次使用 <code>standard</code>（标准）分析器:</p>
<p>DELETE my_index</p>
<p>PUT &#x2F;my_index<br>{<br>  “mappings”: {<br>    “blog”: {<br>      “properties”: {<br>        “title”: {<br>          “type”: “string”,<br>          “analyzer”: “english”<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>PUT &#x2F;my_index<br>{<br>  “mappings”: {<br>    “blog”: {<br>      “properties”: {<br>        “title”: {<br>          “type”: “string”,<br>          “fields”: {<br>            “english”: {<br>              “type”:     “string”,<br>              “analyzer”: “english”<br>            }<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>PUT &#x2F;my_index&#x2F;blog&#x2F;1<br>{ “title”: “I’m happy for this fox” }</p>
<p>PUT &#x2F;my_index&#x2F;blog&#x2F;2<br>{ “title”: “I’m not happy about my fox problem” }</p>
<p>GET &#x2F;_search<br>{<br>  “query”: {<br>    “multi_match”: {<br>      “type”:     “most_fields”,<br>      “query”:    “not happy foxes”,<br>      “fields”: [ “title”, “title.english” ]<br>    }<br>  }<br>}</p>
<p>#安装插件<br>.&#x2F;elasticsearch-plugin install <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip</a><br>#安装插件<br>bin&#x2F;elasticsearch install <a target="_blank" rel="noopener" href="https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip">https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip</a></p>
<p>#ik_max_word<br>#ik_smart<br>#hanlp: hanlp默认分词<br>#hanlp_standard: 标准分词<br>#hanlp_index: 索引分词<br>#hanlp_nlp: NLP分词<br>#hanlp_n_short: N-最短路分词<br>#hanlp_dijkstra: 最短路分词<br>#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）<br>#hanlp_speed: 极速词典分词</p>
<p>POST _analyze<br>{<br>  “analyzer”: “hanlp_standard”,<br>  “text”: [“剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜”]</p>
<p>}     </p>
<p>#Pinyin<br>PUT &#x2F;artists&#x2F;<br>{<br>    “settings” : {<br>        “analysis” : {<br>            “analyzer” : {<br>                “user_name_analyzer” : {<br>                    “tokenizer” : “whitespace”,<br>                    “filter” : “pinyin_first_letter_and_full_pinyin_filter”<br>                }<br>            },<br>            “filter” : {<br>                “pinyin_first_letter_and_full_pinyin_filter” : {<br>                    “type” : “pinyin”,<br>                    “keep_first_letter” : true,<br>                    “keep_full_pinyin” : false,<br>                    “keep_none_chinese” : true,<br>                    “keep_original” : false,<br>                    “limit_first_letter_length” : 16,<br>                    “lowercase” : true,<br>                    “trim_whitespace” : true,<br>                    “keep_none_chinese_in_first_letter” : true<br>                }<br>            }<br>        }<br>    }<br>}</p>
<p>GET &#x2F;artists&#x2F;_analyze<br>{<br>  “text”: [“刘德华 张学友 郭富城 黎明 四大天王”],<br>  “analyzer”: “user_name_analyzer”<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 相关资源</span><br><span class="line">- Elasticsearch IK分词插件 https://github.com/medcl/elasticsearch-analysis-ik/releases</span><br><span class="line">- Elasticsearch hanlp 分词插件 https://github.com/KennFalcon/elasticsearch-analysis-hanlp</span><br><span class="line"></span><br><span class="line">- 分词算法综述 https://zhuanlan.zhihu.com/p/50444885</span><br><span class="line"></span><br><span class="line">### 一些分词工具，供参考：</span><br><span class="line">- 中科院计算所NLPIR http://ictclas.nlpir.org/nlpir/</span><br><span class="line">- ansj分词器 https://github.com/NLPchina/ansj_seg</span><br><span class="line">- 哈工大的LTP https://github.com/HIT-SCIR/ltp</span><br><span class="line">- 清华大学THULAC https://github.com/thunlp/THULAC</span><br><span class="line">- 斯坦福分词器 https://nlp.stanford.edu/software/segmenter.shtml</span><br><span class="line">- Hanlp分词器 https://github.com/hankcs/HanLP</span><br><span class="line">- 结巴分词 https://github.com/yanyiwu/cppjieba</span><br><span class="line">- KCWS分词器(字嵌入+Bi-LSTM+CRF) https://github.com/koth/kcws</span><br><span class="line">- ZPar https://github.com/frcchang/zpar/releases</span><br><span class="line">- IKAnalyzer https://github.com/wks/ik-analyzer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 4.8-SpaceJam一个全文搜索的实例.md</span><br><span class="line"></span><br><span class="line"># Space Jam，一次全文搜索的实例</span><br><span class="line"></span><br><span class="line">## 环境要求</span><br><span class="line">- Python 2.7.15</span><br><span class="line">- 可以使用pyenv管理多个python版本（可选）</span><br><span class="line"></span><br><span class="line">## 进入 tmdb-search目录</span><br><span class="line">Run</span><br><span class="line">pip install -r requirements.txt</span><br><span class="line">Run python ./ingest_tmdb_from_file.py</span><br></pre></td></tr></table></figure>
<p>POST tmdb&#x2F;_search<br>{<br>“_source”: [“title”,”overview”],<br> “query”: {<br>   “match_all”: {}<br> }<br>}</p>
<p>POST tmdb&#x2F;_search<br>{<br>  “_source”: [“title”,”overview”],<br>  “query”: {<br>    “multi_match”: {<br>      “query”: “basketball with cartoon aliens”,<br>      “fields”: [“title”,”overview”]<br>    }<br>  },<br>  “highlight” : {<br>        “fields” : {<br>            “overview” : { “pre_tags” : [“\033[0;32;40m”], “post_tags” : [“\033[0m”] },<br>            “title” : { “pre_tags” : [“\033[0;32;40m”], “post_tags” : [“\033[0m”] }</p>
<pre><code>    &#125;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 相关</span><br><span class="line">- Windows 安装 pyenv https://github.com/pyenv-win/pyenv-win</span><br><span class="line">- Mac 安装pyenv https://segmentfault.com/a/1190000017403221</span><br><span class="line">- Linux 安装 pyenv https://blog.csdn.net/GX_1_11_real/article/details/80237064</span><br><span class="line">- Python.org https://www.python.org/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 4.9-使用SearchTemplate和IndexAlias进行查询.md</span><br><span class="line"></span><br><span class="line"># 使用 Search Template 和 Index Alias 查询</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>POST _scripts&#x2F;tmdb<br>{<br>  “script”: {<br>    “lang”: “mustache”,<br>    “source”: {<br>      “_source”: [<br>        “title”,”overview”<br>      ],<br>      “size”: 20,<br>      “query”: {<br>        “multi_match”: {<br>          “query”: ““,<br>          “fields”: [“title”,”overview”]<br>        }<br>      }<br>    }<br>  }<br>}<br>DELETE _scripts&#x2F;tmdb</p>
<p>GET _scripts&#x2F;tmdb</p>
<p>POST tmdb&#x2F;_search&#x2F;template<br>{<br>    “id”:”tmdb”,<br>    “params”: {<br>        “q”: “basketball with cartoon aliens”<br>    }<br>}</p>
<p>PUT movies-2019&#x2F;_doc&#x2F;1<br>{<br>  “name”:”the matrix”,<br>  “rating”:5<br>}</p>
<p>PUT movies-2019&#x2F;_doc&#x2F;2<br>{<br>  “name”:”Speed”,<br>  “rating”:3<br>}</p>
<p>POST _aliases<br>{<br>  “actions”: [<br>    {<br>      “add”: {<br>        “index”: “movies-2019”,<br>        “alias”: “movies-latest”<br>      }<br>    }<br>  ]<br>}</p>
<p>POST movies-latest&#x2F;_search<br>{<br>  “query”: {<br>    “match_all”: {}<br>  }<br>}</p>
<p>POST _aliases<br>{<br>  “actions”: [<br>    {<br>      “add”: {<br>        “index”: “movies-2019”,<br>        “alias”: “movies-lastest-highrate”,<br>        “filter”: {<br>          “range”: {<br>            “rating”: {<br>              “gte”: 4<br>            }<br>          }<br>        }<br>      }<br>    }<br>  ]<br>}</p>
<p>POST movies-lastest-highrate&#x2F;_search<br>{<br>  “query”: {<br>    “match_all”: {}<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 5.1-集群分布式模型及选主与脑裂问题.md</span><br><span class="line"></span><br><span class="line"># 集群分布式模型及选主与脑裂问题</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>bin&#x2F;elasticsearch -E node.name&#x3D;node1 -E cluster.name&#x3D;geektime -E path.data&#x3D;node1_data<br>bin&#x2F;elasticsearch -E node.name&#x3D;node2 -E cluster.name&#x3D;geektime -E path.data&#x3D;node2_data<br>bin&#x2F;elasticsearch -E node.name&#x3D;node3 -E cluster.name&#x3D;geektime -E path.data&#x3D;node3_data</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 5.2-分片与集群的故障转移.md</span><br><span class="line"></span><br><span class="line"># 分片与集群的故障转移</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 5.3-文档分布式存储.md</span><br><span class="line"></span><br><span class="line"># 文档分布式存储</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 5.4-分片及其生命周期.md</span><br><span class="line"></span><br><span class="line"># 分片及其生命周期</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 5.5-剖析分布式查询及相关性评分.md</span><br><span class="line"></span><br><span class="line"># 剖析分布式查询及相关性评分</span><br></pre></td></tr></table></figure>
<p>DELETE message<br>PUT message<br>{<br>  “settings”: {<br>    “number_of_shards”: 20<br>  }<br>}</p>
<p>GET message</p>
<p>POST message&#x2F;_doc?routing&#x3D;1<br>{<br>  “content”:”good”<br>}</p>
<p>POST message&#x2F;_doc?routing&#x3D;2<br>{<br>  “content”:”good morning”<br>}</p>
<p>POST message&#x2F;_doc?routing&#x3D;3<br>{<br>  “content”:”good morning everyone”<br>}</p>
<p>POST message&#x2F;_search<br>{<br>  “explain”: true,<br>  “query”: {<br>    “match_all”: {}<br>  }<br>}</p>
<p>POST message&#x2F;_search<br>{<br>  “explain”: true,<br>  “query”: {<br>    “term”: {<br>      “content”: {<br>        “value”: “good”<br>      }<br>    }<br>  }<br>}</p>
<p>POST message&#x2F;_search?search_type&#x3D;dfs_query_then_fetch<br>{</p>
<p>  “query”: {<br>    “term”: {<br>      “content”: {<br>        “value”: “good”<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 5.6-排序及DocValues&amp;Fielddata.md</span><br><span class="line"></span><br><span class="line"># 排序及Doc Values &amp; Fielddata</span><br></pre></td></tr></table></figure>
<p>#单字段排序<br>POST &#x2F;kibana_sample_data_ecommerce&#x2F;_search<br>{<br>  “size”: 5,<br>  “query”: {<br>    “match_all”: {</p>
<pre><code>&#125;
</code></pre>
<p>  },<br>  “sort”: [<br>    {“order_date”: {“order”: “desc”}}<br>  ]<br>}</p>
<p>#多字段排序<br>POST &#x2F;kibana_sample_data_ecommerce&#x2F;_search<br>{<br>  “size”: 5,<br>  “query”: {<br>    “match_all”: {</p>
<pre><code>&#125;
</code></pre>
<p>  },<br>  “sort”: [<br>    {“order_date”: {“order”: “desc”}},<br>    {“_doc”:{“order”: “asc”}},<br>    {“_score”:{ “order”: “desc”}}<br>  ]<br>}</p>
<p>GET kibana_sample_data_ecommerce&#x2F;_mapping</p>
<p>#对 text 字段进行排序。默认会报错，需打开fielddata<br>POST &#x2F;kibana_sample_data_ecommerce&#x2F;_search<br>{<br>  “size”: 5,<br>  “query”: {<br>    “match_all”: {</p>
<pre><code>&#125;
</code></pre>
<p>  },<br>  “sort”: [<br>    {“customer_full_name”: {“order”: “desc”}}<br>  ]<br>}</p>
<p>#打开 text的 fielddata<br>PUT kibana_sample_data_ecommerce&#x2F;_mapping<br>{<br>  “properties”: {<br>    “customer_full_name” : {<br>          “type” : “text”,<br>          “fielddata”: true,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 256<br>            }<br>          }<br>        }<br>  }<br>}</p>
<p>#关闭 keyword的 doc values<br>PUT test_keyword<br>PUT test_keyword&#x2F;_mapping<br>{<br>  “properties”: {<br>    “user_name”:{<br>      “type”: “keyword”,<br>      “doc_values”:false<br>    }<br>  }<br>}</p>
<p>DELETE test_keyword</p>
<p>PUT test_text<br>PUT test_text&#x2F;_mapping<br>{<br>  “properties”: {<br>    “intro”:{<br>      “type”: “text”,<br>      “doc_values”:true<br>    }<br>  }<br>}</p>
<p>DELETE test_text</p>
<p>DELETE temp_users<br>PUT temp_users<br>PUT temp_users&#x2F;_mapping<br>{<br>  “properties”: {<br>    “name”:{“type”: “text”,”fielddata”: true},<br>    “desc”:{“type”: “text”,”fielddata”: true}<br>  }<br>}</p>
<p>Post temp_users&#x2F;_doc<br>{“name”:”Jack”,”desc”:”Jack is a good boy!”,”age”:10}</p>
<p>#打开fielddata 后，查看 docvalue_fields数据<br>POST  temp_users&#x2F;_search<br>{<br>  “docvalue_fields”: [<br>    “name”,”desc”<br>    ]<br>}</p>
<p>#查看整型字段的docvalues<br>POST  temp_users&#x2F;_search<br>{<br>  “docvalue_fields”: [<br>    “age”<br>    ]<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 5.7-分页与遍历-FromSize&amp;SearchAfter&amp;ScrollAPI.md</span><br><span class="line"></span><br><span class="line"># 分页与遍历 - From, Size, Search_after &amp; Scroll API</span><br></pre></td></tr></table></figure>

<p>POST tmdb&#x2F;_search<br>{<br>  “from”: 10000,<br>  “size”: 1,<br>  “query”: {<br>    “match_all”: {</p>
<pre><code>&#125;
</code></pre>
<p>  }<br>}</p>
<p>#Scroll API<br>DELETE users</p>
<p>POST users&#x2F;_doc<br>{“name”:”user1”,”age”:10}</p>
<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:11}</p>
<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:12}</p>
<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:13}</p>
<p>POST users&#x2F;_count</p>
<p>POST users&#x2F;_search<br>{<br>    “size”: 1,<br>    “query”: {<br>        “match_all”: {}<br>    },<br>    “sort”: [<br>        {“age”: “desc”} ,<br>        {“_id”: “asc”}<br>    ]<br>}</p>
<p>POST users&#x2F;_search<br>{<br>    “size”: 1,<br>    “query”: {<br>        “match_all”: {}<br>    },<br>    “search_after”:<br>        [<br>          10,<br>          “ZQ0vYGsBrR8X3IP75QqX”],<br>    “sort”: [<br>        {“age”: “desc”} ,<br>        {“_id”: “asc”}<br>    ]<br>}</p>
<p>#Scroll API<br>DELETE users<br>POST users&#x2F;_doc<br>{“name”:”user1”,”age”:10}</p>
<p>POST users&#x2F;_doc<br>{“name”:”user2”,”age”:20}</p>
<p>POST users&#x2F;_doc<br>{“name”:”user3”,”age”:30}</p>
<p>POST users&#x2F;_doc<br>{“name”:”user4”,”age”:40}</p>
<p>POST &#x2F;users&#x2F;_search?scroll&#x3D;5m<br>{<br>    “size”: 1,<br>    “query”: {<br>        “match_all” : {<br>        }<br>    }<br>}</p>
<p>POST users&#x2F;_doc<br>{“name”:”user5”,”age”:50}<br>POST &#x2F;_search&#x2F;scroll<br>{<br>    “scroll” : “1m”,<br>    “scroll_id” : “DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ&#x3D;&#x3D;”<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 5.8-处理并发读写.md</span><br><span class="line"></span><br><span class="line"># 处理并发读写操作</span><br></pre></td></tr></table></figure>

<p>DELETE products<br>PUT products</p>
<p>PUT products&#x2F;_doc&#x2F;1<br>{<br>  “title”:”iphone”,<br>  “count”:100<br>}</p>
<p>GET products&#x2F;_doc&#x2F;1</p>
<p>PUT products&#x2F;_doc&#x2F;1?if_seq_no&#x3D;1&amp;if_primary_term&#x3D;1<br>{<br>  “title”:”iphone”,<br>  “count”:100<br>}</p>
<p>PUT products&#x2F;_doc&#x2F;1?version&#x3D;30000&amp;version_type&#x3D;external<br>{<br>  “title”:”iphone”,<br>  “count”:100<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 6.1-Bucket&amp;Metric聚合分析及嵌套聚合.md</span><br><span class="line"></span><br><span class="line"># Bucket &amp; Metric Aggregation</span><br><span class="line">## demos</span><br></pre></td></tr></table></figure>
<p>DELETE &#x2F;employees<br>PUT &#x2F;employees&#x2F;<br>{<br>  “mappings” : {<br>      “properties” : {<br>        “age” : {<br>          “type” : “integer”<br>        },<br>        “gender” : {<br>          “type” : “keyword”<br>        },<br>        “job” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 50<br>            }<br>          }<br>        },<br>        “name” : {<br>          “type” : “keyword”<br>        },<br>        “salary” : {<br>          “type” : “integer”<br>        }<br>      }<br>    }<br>}</p>
<p>PUT &#x2F;employees&#x2F;_bulk<br>{ “index” : {  “_id” : “1” } }<br>{ “name” : “Emma”,”age”:32,”job”:”Product Manager”,”gender”:”female”,”salary”:35000 }<br>{ “index” : {  “_id” : “2” } }<br>{ “name” : “Underwood”,”age”:41,”job”:”Dev Manager”,”gender”:”male”,”salary”: 50000}<br>{ “index” : {  “_id” : “3” } }<br>{ “name” : “Tran”,”age”:25,”job”:”Web Designer”,”gender”:”male”,”salary”:18000 }<br>{ “index” : {  “_id” : “4” } }<br>{ “name” : “Rivera”,”age”:26,”job”:”Web Designer”,”gender”:”female”,”salary”: 22000}<br>{ “index” : {  “_id” : “5” } }<br>{ “name” : “Rose”,”age”:25,”job”:”QA”,”gender”:”female”,”salary”:18000 }<br>{ “index” : {  “_id” : “6” } }<br>{ “name” : “Lucy”,”age”:31,”job”:”QA”,”gender”:”female”,”salary”: 25000}<br>{ “index” : {  “_id” : “7” } }<br>{ “name” : “Byrd”,”age”:27,”job”:”QA”,”gender”:”male”,”salary”:20000 }<br>{ “index” : {  “_id” : “8” } }<br>{ “name” : “Foster”,”age”:27,”job”:”Java Programmer”,”gender”:”male”,”salary”: 20000}<br>{ “index” : {  “_id” : “9” } }<br>{ “name” : “Gregory”,”age”:32,”job”:”Java Programmer”,”gender”:”male”,”salary”:22000 }<br>{ “index” : {  “_id” : “10” } }<br>{ “name” : “Bryant”,”age”:20,”job”:”Java Programmer”,”gender”:”male”,”salary”: 9000}<br>{ “index” : {  “_id” : “11” } }<br>{ “name” : “Jenny”,”age”:36,”job”:”Java Programmer”,”gender”:”female”,”salary”:38000 }<br>{ “index” : {  “_id” : “12” } }<br>{ “name” : “Mcdonald”,”age”:31,”job”:”Java Programmer”,”gender”:”male”,”salary”: 32000}<br>{ “index” : {  “_id” : “13” } }<br>{ “name” : “Jonthna”,”age”:30,”job”:”Java Programmer”,”gender”:”female”,”salary”:30000 }<br>{ “index” : {  “_id” : “14” } }<br>{ “name” : “Marshall”,”age”:32,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 25000}<br>{ “index” : {  “_id” : “15” } }<br>{ “name” : “King”,”age”:33,”job”:”Java Programmer”,”gender”:”male”,”salary”:28000 }<br>{ “index” : {  “_id” : “16” } }<br>{ “name” : “Mccarthy”,”age”:21,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “17” } }<br>{ “name” : “Goodwin”,”age”:25,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “18” } }<br>{ “name” : “Catherine”,”age”:29,”job”:”Javascript Programmer”,”gender”:”female”,”salary”: 20000}<br>{ “index” : {  “_id” : “19” } }<br>{ “name” : “Boone”,”age”:30,”job”:”DBA”,”gender”:”male”,”salary”: 30000}<br>{ “index” : {  “_id” : “20” } }<br>{ “name” : “Kathy”,”age”:29,”job”:”DBA”,”gender”:”female”,”salary”: 20000}</p>
<h1 id="Metric-聚合，找到最低的工资"><a href="#Metric-聚合，找到最低的工资" class="headerlink" title="Metric 聚合，找到最低的工资"></a>Metric 聚合，找到最低的工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “min_salary”: {<br>      “min”: {<br>        “field”:”salary”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="Metric-聚合，找到最高的工资"><a href="#Metric-聚合，找到最高的工资" class="headerlink" title="Metric 聚合，找到最高的工资"></a>Metric 聚合，找到最高的工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “max_salary”: {<br>      “max”: {<br>        “field”:”salary”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="多个-Metric-聚合，找到最低最高和平均工资"><a href="#多个-Metric-聚合，找到最低最高和平均工资" class="headerlink" title="多个 Metric 聚合，找到最低最高和平均工资"></a>多个 Metric 聚合，找到最低最高和平均工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “max_salary”: {<br>      “max”: {<br>        “field”: “salary”<br>      }<br>    },<br>    “min_salary”: {<br>      “min”: {<br>        “field”: “salary”<br>      }<br>    },<br>    “avg_salary”: {<br>      “avg”: {<br>        “field”: “salary”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="一个聚合，输出多值"><a href="#一个聚合，输出多值" class="headerlink" title="一个聚合，输出多值"></a>一个聚合，输出多值</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “stats_salary”: {<br>      “stats”: {<br>        “field”:”salary”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="对keword-进行聚合"><a href="#对keword-进行聚合" class="headerlink" title="对keword 进行聚合"></a>对keword 进行聚合</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="对-Text-字段进行-terms-聚合查询，失败"><a href="#对-Text-字段进行-terms-聚合查询，失败" class="headerlink" title="对 Text 字段进行 terms 聚合查询，失败"></a>对 Text 字段进行 terms 聚合查询，失败</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="对-Text-字段打开-fielddata，支持terms-aggregation"><a href="#对-Text-字段打开-fielddata，支持terms-aggregation" class="headerlink" title="对 Text 字段打开 fielddata，支持terms aggregation"></a>对 Text 字段打开 fielddata，支持terms aggregation</h1><p>PUT employees&#x2F;_mapping<br>{<br>  “properties” : {<br>    “job”:{<br>       “type”:     “text”,<br>       “fielddata”: true<br>    }<br>  }<br>}</p>
<h1 id="对-Text-字段进行-terms-分词。分词后的terms"><a href="#对-Text-字段进行-terms-分词。分词后的terms" class="headerlink" title="对 Text 字段进行 terms 分词。分词后的terms"></a>对 Text 字段进行 terms 分词。分词后的terms</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job”<br>      }<br>    }<br>  }<br>}</p>
<p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="对job-keyword-和-job-进行-terms-聚合，分桶的总数并不一样"><a href="#对job-keyword-和-job-进行-terms-聚合，分桶的总数并不一样" class="headerlink" title="对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样"></a>对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “cardinate”: {<br>      “cardinality”: {<br>        “field”: “job”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="对-性别的-keyword-进行聚合"><a href="#对-性别的-keyword-进行聚合" class="headerlink" title="对 性别的 keyword 进行聚合"></a>对 性别的 keyword 进行聚合</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “gender”: {<br>      “terms”: {<br>        “field”:”gender”<br>      }<br>    }<br>  }<br>}</p>
<p>#指定 bucket 的 size<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “ages_5”: {<br>      “terms”: {<br>        “field”:”age”,<br>        “size”:3<br>      }<br>    }<br>  }<br>}</p>
<h1 id="指定size，不同工种中，年纪最大的3个员工的具体信息"><a href="#指定size，不同工种中，年纪最大的3个员工的具体信息" class="headerlink" title="指定size，不同工种中，年纪最大的3个员工的具体信息"></a>指定size，不同工种中，年纪最大的3个员工的具体信息</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”<br>      },<br>      “aggs”:{<br>        “old_employee”:{<br>          “top_hits”:{<br>            “size”:3,<br>            “sort”:[<br>              {<br>                “age”:{<br>                  “order”:”desc”<br>                }<br>              }<br>            ]<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>#Salary Ranges 分桶，可以自己定义 key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “salary_range”: {<br>      “range”: {<br>        “field”:”salary”,<br>        “ranges”:[<br>          {<br>            “to”:10000<br>          },<br>          {<br>            “from”:10000,<br>            “to”:20000<br>          },<br>          {<br>            “key”:”&gt;20000”,<br>            “from”:20000<br>          }<br>        ]<br>      }<br>    }<br>  }<br>}</p>
<p>#Salary Histogram,工资0到10万，以 5000一个区间进行分桶<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “salary_histrogram”: {<br>      “histogram”: {<br>        “field”:”salary”,<br>        “interval”:5000,<br>        “extended_bounds”:{<br>          “min”:0,<br>          “max”:100000</p>
<pre><code>    &#125;
  &#125;
&#125;
</code></pre>
<p>  }<br>}</p>
<h1 id="嵌套聚合1，按照工作类型分桶，并统计工资信息"><a href="#嵌套聚合1，按照工作类型分桶，并统计工资信息" class="headerlink" title="嵌套聚合1，按照工作类型分桶，并统计工资信息"></a>嵌套聚合1，按照工作类型分桶，并统计工资信息</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “Job_salary_stats”: {<br>      “terms”: {<br>        “field”: “job.keyword”<br>      },<br>      “aggs”: {<br>        “salary”: {<br>          “stats”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<h1 id="多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息"><a href="#多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息" class="headerlink" title="多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息"></a>多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “Job_gender_stats”: {<br>      “terms”: {<br>        “field”: “job.keyword”<br>      },<br>      “aggs”: {<br>        “gender_stats”: {<br>          “terms”: {<br>            “field”: “gender”<br>          },<br>          “aggs”: {<br>            “salary_stats”: {<br>              “stats”: {<br>                “field”: “salary”<br>              }<br>            }<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 6.2-Pipeline聚合分析.md</span><br><span class="line"></span><br><span class="line"># Pipeline 聚合分析</span><br></pre></td></tr></table></figure>
<p>DELETE employees<br>PUT &#x2F;employees&#x2F;_bulk<br>{ “index” : {  “_id” : “1” } }<br>{ “name” : “Emma”,”age”:32,”job”:”Product Manager”,”gender”:”female”,”salary”:35000 }<br>{ “index” : {  “_id” : “2” } }<br>{ “name” : “Underwood”,”age”:41,”job”:”Dev Manager”,”gender”:”male”,”salary”: 50000}<br>{ “index” : {  “_id” : “3” } }<br>{ “name” : “Tran”,”age”:25,”job”:”Web Designer”,”gender”:”male”,”salary”:18000 }<br>{ “index” : {  “_id” : “4” } }<br>{ “name” : “Rivera”,”age”:26,”job”:”Web Designer”,”gender”:”female”,”salary”: 22000}<br>{ “index” : {  “_id” : “5” } }<br>{ “name” : “Rose”,”age”:25,”job”:”QA”,”gender”:”female”,”salary”:18000 }<br>{ “index” : {  “_id” : “6” } }<br>{ “name” : “Lucy”,”age”:31,”job”:”QA”,”gender”:”female”,”salary”: 25000}<br>{ “index” : {  “_id” : “7” } }<br>{ “name” : “Byrd”,”age”:27,”job”:”QA”,”gender”:”male”,”salary”:20000 }<br>{ “index” : {  “_id” : “8” } }<br>{ “name” : “Foster”,”age”:27,”job”:”Java Programmer”,”gender”:”male”,”salary”: 20000}<br>{ “index” : {  “_id” : “9” } }<br>{ “name” : “Gregory”,”age”:32,”job”:”Java Programmer”,”gender”:”male”,”salary”:22000 }<br>{ “index” : {  “_id” : “10” } }<br>{ “name” : “Bryant”,”age”:20,”job”:”Java Programmer”,”gender”:”male”,”salary”: 9000}<br>{ “index” : {  “_id” : “11” } }<br>{ “name” : “Jenny”,”age”:36,”job”:”Java Programmer”,”gender”:”female”,”salary”:38000 }<br>{ “index” : {  “_id” : “12” } }<br>{ “name” : “Mcdonald”,”age”:31,”job”:”Java Programmer”,”gender”:”male”,”salary”: 32000}<br>{ “index” : {  “_id” : “13” } }<br>{ “name” : “Jonthna”,”age”:30,”job”:”Java Programmer”,”gender”:”female”,”salary”:30000 }<br>{ “index” : {  “_id” : “14” } }<br>{ “name” : “Marshall”,”age”:32,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 25000}<br>{ “index” : {  “_id” : “15” } }<br>{ “name” : “King”,”age”:33,”job”:”Java Programmer”,”gender”:”male”,”salary”:28000 }<br>{ “index” : {  “_id” : “16” } }<br>{ “name” : “Mccarthy”,”age”:21,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “17” } }<br>{ “name” : “Goodwin”,”age”:25,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “18” } }<br>{ “name” : “Catherine”,”age”:29,”job”:”Javascript Programmer”,”gender”:”female”,”salary”: 20000}<br>{ “index” : {  “_id” : “19” } }<br>{ “name” : “Boone”,”age”:30,”job”:”DBA”,”gender”:”male”,”salary”: 30000}<br>{ “index” : {  “_id” : “20” } }<br>{ “name” : “Kathy”,”age”:29,”job”:”DBA”,”gender”:”female”,”salary”: 20000}</p>
<h1 id="平均工资最低的工作类型"><a href="#平均工资最低的工作类型" class="headerlink" title="平均工资最低的工作类型"></a>平均工资最低的工作类型</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “min_salary_by_job”:{<br>      “min_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="平均工资最高的工作类型"><a href="#平均工资最高的工作类型" class="headerlink" title="平均工资最高的工作类型"></a>平均工资最高的工作类型</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “max_salary_by_job”:{<br>      “max_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="平均工资的平均工资"><a href="#平均工资的平均工资" class="headerlink" title="平均工资的平均工资"></a>平均工资的平均工资</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “avg_salary_by_job”:{<br>      “avg_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="平均工资的统计分析"><a href="#平均工资的统计分析" class="headerlink" title="平均工资的统计分析"></a>平均工资的统计分析</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “stats_salary_by_job”:{<br>      “stats_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>
<h1 id="平均工资的百分位数"><a href="#平均工资的百分位数" class="headerlink" title="平均工资的百分位数"></a>平均工资的百分位数</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”,<br>        “size”: 10<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        }<br>      }<br>    },<br>    “percentiles_salary_by_job”:{<br>      “percentiles_bucket”: {<br>        “buckets_path”: “jobs&gt;avg_salary”<br>      }<br>    }<br>  }<br>}</p>
<p>#按照年龄对平均工资求导<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “age”: {<br>      “histogram”: {<br>        “field”: “age”,<br>        “min_doc_count”: 1,<br>        “interval”: 1<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        },<br>        “derivative_avg_salary”:{<br>          “derivative”: {<br>            “buckets_path”: “avg_salary”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>#Cumulative_sum<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “age”: {<br>      “histogram”: {<br>        “field”: “age”,<br>        “min_doc_count”: 1,<br>        “interval”: 1<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        },<br>        “cumulative_salary”:{<br>          “cumulative_sum”: {<br>            “buckets_path”: “avg_salary”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>#Moving Function<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “age”: {<br>      “histogram”: {<br>        “field”: “age”,<br>        “min_doc_count”: 1,<br>        “interval”: 1<br>      },<br>      “aggs”: {<br>        “avg_salary”: {<br>          “avg”: {<br>            “field”: “salary”<br>          }<br>        },<br>        “moving_avg_salary”:{<br>          “moving_fn”: {<br>            “buckets_path”: “avg_salary”,<br>            “window”:10,<br>            “script”: “MovingFunctions.min(values)”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 6.3-作用范围与排序.md</span><br><span class="line"></span><br><span class="line"># 作用范围与排序</span><br></pre></td></tr></table></figure>
<p>DELETE &#x2F;employees<br>PUT &#x2F;employees&#x2F;<br>{<br>  “mappings” : {<br>      “properties” : {<br>        “age” : {<br>          “type” : “integer”<br>        },<br>        “gender” : {<br>          “type” : “keyword”<br>        },<br>        “job” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 50<br>            }<br>          }<br>        },<br>        “name” : {<br>          “type” : “keyword”<br>        },<br>        “salary” : {<br>          “type” : “integer”<br>        }<br>      }<br>    }<br>}</p>
<p>PUT &#x2F;employees&#x2F;_bulk<br>{ “index” : {  “_id” : “1” } }<br>{ “name” : “Emma”,”age”:32,”job”:”Product Manager”,”gender”:”female”,”salary”:35000 }<br>{ “index” : {  “_id” : “2” } }<br>{ “name” : “Underwood”,”age”:41,”job”:”Dev Manager”,”gender”:”male”,”salary”: 50000}<br>{ “index” : {  “_id” : “3” } }<br>{ “name” : “Tran”,”age”:25,”job”:”Web Designer”,”gender”:”male”,”salary”:18000 }<br>{ “index” : {  “_id” : “4” } }<br>{ “name” : “Rivera”,”age”:26,”job”:”Web Designer”,”gender”:”female”,”salary”: 22000}<br>{ “index” : {  “_id” : “5” } }<br>{ “name” : “Rose”,”age”:25,”job”:”QA”,”gender”:”female”,”salary”:18000 }<br>{ “index” : {  “_id” : “6” } }<br>{ “name” : “Lucy”,”age”:31,”job”:”QA”,”gender”:”female”,”salary”: 25000}<br>{ “index” : {  “_id” : “7” } }<br>{ “name” : “Byrd”,”age”:27,”job”:”QA”,”gender”:”male”,”salary”:20000 }<br>{ “index” : {  “_id” : “8” } }<br>{ “name” : “Foster”,”age”:27,”job”:”Java Programmer”,”gender”:”male”,”salary”: 20000}<br>{ “index” : {  “_id” : “9” } }<br>{ “name” : “Gregory”,”age”:32,”job”:”Java Programmer”,”gender”:”male”,”salary”:22000 }<br>{ “index” : {  “_id” : “10” } }<br>{ “name” : “Bryant”,”age”:20,”job”:”Java Programmer”,”gender”:”male”,”salary”: 9000}<br>{ “index” : {  “_id” : “11” } }<br>{ “name” : “Jenny”,”age”:36,”job”:”Java Programmer”,”gender”:”female”,”salary”:38000 }<br>{ “index” : {  “_id” : “12” } }<br>{ “name” : “Mcdonald”,”age”:31,”job”:”Java Programmer”,”gender”:”male”,”salary”: 32000}<br>{ “index” : {  “_id” : “13” } }<br>{ “name” : “Jonthna”,”age”:30,”job”:”Java Programmer”,”gender”:”female”,”salary”:30000 }<br>{ “index” : {  “_id” : “14” } }<br>{ “name” : “Marshall”,”age”:32,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 25000}<br>{ “index” : {  “_id” : “15” } }<br>{ “name” : “King”,”age”:33,”job”:”Java Programmer”,”gender”:”male”,”salary”:28000 }<br>{ “index” : {  “_id” : “16” } }<br>{ “name” : “Mccarthy”,”age”:21,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “17” } }<br>{ “name” : “Goodwin”,”age”:25,”job”:”Javascript Programmer”,”gender”:”male”,”salary”: 16000}<br>{ “index” : {  “_id” : “18” } }<br>{ “name” : “Catherine”,”age”:29,”job”:”Javascript Programmer”,”gender”:”female”,”salary”: 20000}<br>{ “index” : {  “_id” : “19” } }<br>{ “name” : “Boone”,”age”:30,”job”:”DBA”,”gender”:”male”,”salary”: 30000}<br>{ “index” : {  “_id” : “20” } }<br>{ “name” : “Kathy”,”age”:29,”job”:”DBA”,”gender”:”female”,”salary”: 20000}</p>
<h1 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h1><p>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 20<br>      }<br>    }<br>  },<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”</p>
<pre><code>  &#125;
&#125;
</code></pre>
<p>  }<br>}</p>
<p>#Filter<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “older_person”: {<br>      “filter”:{<br>        “range”:{<br>          “age”:{<br>            “from”:35<br>          }<br>        }<br>      },<br>      “aggs”:{<br>         “jobs”:{<br>           “terms”: {<br>        “field”:”job.keyword”<br>      }<br>      }<br>    }},<br>    “all_jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”</p>
<pre><code>  &#125;
&#125;
</code></pre>
<p>  }<br>}</p>
<p>#Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果<br>POST employees&#x2F;_search<br>{<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”: “job.keyword”<br>      }<br>    }<br>  },<br>  “post_filter”: {<br>    “match”: {<br>      “job.keyword”: “Dev Manager”<br>    }<br>  }<br>}</p>
<p>#global<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 40<br>      }<br>    }<br>  },<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”</p>
<pre><code>  &#125;
&#125;,

&quot;all&quot;:&#123;
  &quot;global&quot;:&#123;&#125;,
  &quot;aggs&quot;:&#123;
    &quot;salary_avg&quot;:&#123;
      &quot;avg&quot;:&#123;
        &quot;field&quot;:&quot;salary&quot;
      &#125;
    &#125;
  &#125;
&#125;
</code></pre>
<p>  }<br>}</p>
<p>#排序 order<br>#count and key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “query”: {<br>    “range”: {<br>      “age”: {<br>        “gte”: 20<br>      }<br>    }<br>  },<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”,<br>        “order”:[<br>          {“_count”:”asc”},<br>          {“_key”:”desc”}<br>          ]</p>
<pre><code>  &#125;
&#125;
</code></pre>
<p>  }<br>}</p>
<p>#排序 order<br>#count and key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”,<br>        “order”:[  {<br>            “avg_salary”:”desc”<br>          }]</p>
<pre><code>  &#125;,
&quot;aggs&quot;: &#123;
  &quot;avg_salary&quot;: &#123;
    &quot;avg&quot;: &#123;
      &quot;field&quot;:&quot;salary&quot;
    &#125;
  &#125;
&#125;
&#125;
</code></pre>
<p>  }<br>}</p>
<p>#排序 order<br>#count and key<br>POST employees&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “jobs”: {<br>      “terms”: {<br>        “field”:”job.keyword”,<br>        “order”:[  {<br>            “stats_salary.min”:”desc”<br>          }]</p>
<pre><code>  &#125;,
&quot;aggs&quot;: &#123;
  &quot;stats_salary&quot;: &#123;
    &quot;stats&quot;: &#123;
      &quot;field&quot;:&quot;salary&quot;
    &#125;
  &#125;
&#125;
&#125;
</code></pre>
<p>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 6.4-聚合分析的原理及精准度问题.md</span><br><span class="line"></span><br><span class="line"># 聚合分析的原理及精准度问题</span><br></pre></td></tr></table></figure>
<p>DELETE my_flights<br>PUT my_flights<br>{<br>  “settings”: {<br>    “number_of_shards”: 20<br>  },<br>  “mappings” : {<br>      “properties” : {<br>        “AvgTicketPrice” : {<br>          “type” : “float”<br>        },<br>        “Cancelled” : {<br>          “type” : “boolean”<br>        },<br>        “Carrier” : {<br>          “type” : “keyword”<br>        },<br>        “Dest” : {<br>          “type” : “keyword”<br>        },<br>        “DestAirportID” : {<br>          “type” : “keyword”<br>        },<br>        “DestCityName” : {<br>          “type” : “keyword”<br>        },<br>        “DestCountry” : {<br>          “type” : “keyword”<br>        },<br>        “DestLocation” : {<br>          “type” : “geo_point”<br>        },<br>        “DestRegion” : {<br>          “type” : “keyword”<br>        },<br>        “DestWeather” : {<br>          “type” : “keyword”<br>        },<br>        “DistanceKilometers” : {<br>          “type” : “float”<br>        },<br>        “DistanceMiles” : {<br>          “type” : “float”<br>        },<br>        “FlightDelay” : {<br>          “type” : “boolean”<br>        },<br>        “FlightDelayMin” : {<br>          “type” : “integer”<br>        },<br>        “FlightDelayType” : {<br>          “type” : “keyword”<br>        },<br>        “FlightNum” : {<br>          “type” : “keyword”<br>        },<br>        “FlightTimeHour” : {<br>          “type” : “keyword”<br>        },<br>        “FlightTimeMin” : {<br>          “type” : “float”<br>        },<br>        “Origin” : {<br>          “type” : “keyword”<br>        },<br>        “OriginAirportID” : {<br>          “type” : “keyword”<br>        },<br>        “OriginCityName” : {<br>          “type” : “keyword”<br>        },<br>        “OriginCountry” : {<br>          “type” : “keyword”<br>        },<br>        “OriginLocation” : {<br>          “type” : “geo_point”<br>        },<br>        “OriginRegion” : {<br>          “type” : “keyword”<br>        },<br>        “OriginWeather” : {<br>          “type” : “keyword”<br>        },<br>        “dayOfWeek” : {<br>          “type” : “integer”<br>        },<br>        “timestamp” : {<br>          “type” : “date”<br>        }<br>      }<br>    }<br>}</p>
<p>POST _reindex<br>{<br>  “source”: {<br>    “index”: “kibana_sample_data_flights”<br>  },<br>  “dest”: {<br>    “index”: “my_flights”<br>  }<br>}</p>
<p>GET kibana_sample_data_flights&#x2F;_count<br>GET my_flights&#x2F;_count</p>
<p>get kibana_sample_data_flights&#x2F;_search</p>
<p>GET kibana_sample_data_flights&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “weather”: {<br>      “terms”: {<br>        “field”:”OriginWeather”,<br>        “size”:5,<br>        “show_term_doc_count_error”:true<br>      }<br>    }<br>  }<br>}</p>
<p>GET my_flights&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “weather”: {<br>      “terms”: {<br>        “field”:”OriginWeather”,<br>        “size”:1,<br>        “shard_size”:1,<br>        “show_term_doc_count_error”:true<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 7.1-对象及 Nested 对象.md</span><br><span class="line"></span><br><span class="line"># 对象及Nested对象</span><br></pre></td></tr></table></figure>
<p>DELETE blog</p>
<h1 id="设置blog的-Mapping"><a href="#设置blog的-Mapping" class="headerlink" title="设置blog的 Mapping"></a>设置blog的 Mapping</h1><p>PUT &#x2F;blog<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “content”: {<br>        “type”: “text”<br>      },<br>      “time”: {<br>        “type”: “date”<br>      },<br>      “user”: {<br>        “properties”: {<br>          “city”: {<br>            “type”: “text”<br>          },<br>          “userid”: {<br>            “type”: “long”<br>          },<br>          “username”: {<br>            “type”: “keyword”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<h1 id="插入一条-Blog-信息"><a href="#插入一条-Blog-信息" class="headerlink" title="插入一条 Blog 信息"></a>插入一条 Blog 信息</h1><p>PUT blog&#x2F;_doc&#x2F;1<br>{<br>  “content”:”I like Elasticsearch”,<br>  “time”:”2019-01-01T00:00:00”,<br>  “user”:{<br>    “userid”:1,<br>    “username”:”Jack”,<br>    “city”:”Shanghai”<br>  }<br>}</p>
<h1 id="查询-Blog-信息"><a href="#查询-Blog-信息" class="headerlink" title="查询 Blog 信息"></a>查询 Blog 信息</h1><p>POST blog&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“match”: {“content”: “Elasticsearch”}},<br>        {“match”: {“user.username”: “Jack”}}<br>      ]<br>    }<br>  }<br>}</p>
<p>DELETE my_movies</p>
<h1 id="电影的Mapping信息"><a href="#电影的Mapping信息" class="headerlink" title="电影的Mapping信息"></a>电影的Mapping信息</h1><p>PUT my_movies<br>{<br>      “mappings” : {<br>      “properties” : {<br>        “actors” : {<br>          “properties” : {<br>            “first_name” : {<br>              “type” : “keyword”<br>            },<br>            “last_name” : {<br>              “type” : “keyword”<br>            }<br>          }<br>        },<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 256<br>            }<br>          }<br>        }<br>      }<br>    }<br>}</p>
<h1 id="写入一条电影信息"><a href="#写入一条电影信息" class="headerlink" title="写入一条电影信息"></a>写入一条电影信息</h1><p>POST my_movies&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Speed”,<br>  “actors”:[<br>    {<br>      “first_name”:”Keanu”,<br>      “last_name”:”Reeves”<br>    },</p>
<pre><code>&#123;
  &quot;first_name&quot;:&quot;Dennis&quot;,
  &quot;last_name&quot;:&quot;Hopper&quot;
&#125;
</code></pre>
<p>  ]<br>}</p>
<h1 id="查询电影信息"><a href="#查询电影信息" class="headerlink" title="查询电影信息"></a>查询电影信息</h1><p>POST my_movies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“match”: {“actors.first_name”: “Keanu”}},<br>        {“match”: {“actors.last_name”: “Hopper”}}<br>      ]<br>    }<br>  }</p>
<p>}</p>
<p>DELETE my_movies</p>
<h1 id="创建-Nested-对象-Mapping"><a href="#创建-Nested-对象-Mapping" class="headerlink" title="创建 Nested 对象 Mapping"></a>创建 Nested 对象 Mapping</h1><p>PUT my_movies<br>{<br>      “mappings” : {<br>      “properties” : {<br>        “actors” : {<br>          “type”: “nested”,<br>          “properties” : {<br>            “first_name” : {“type” : “keyword”},<br>            “last_name” : {“type” : “keyword”}<br>          }},<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {“keyword”:{“type”:”keyword”,”ignore_above”:256}}<br>        }<br>      }<br>    }<br>}</p>
<p>POST my_movies&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Speed”,<br>  “actors”:[<br>    {<br>      “first_name”:”Keanu”,<br>      “last_name”:”Reeves”<br>    },</p>
<pre><code>&#123;
  &quot;first_name&quot;:&quot;Dennis&quot;,
  &quot;last_name&quot;:&quot;Hopper&quot;
&#125;
</code></pre>
<p>  ]<br>}</p>
<h1 id="Nested-查询"><a href="#Nested-查询" class="headerlink" title="Nested 查询"></a>Nested 查询</h1><p>POST my_movies&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “must”: [<br>        {“match”: {“title”: “Speed”}},<br>        {<br>          “nested”: {<br>            “path”: “actors”,<br>            “query”: {<br>              “bool”: {<br>                “must”: [<br>                  {“match”: {<br>                    “actors.first_name”: “Keanu”<br>                  }},</p>
<pre><code>              &#123;&quot;match&quot;: &#123;
                &quot;actors.last_name&quot;: &quot;Hopper&quot;
              &#125;&#125;
            ]
          &#125;
        &#125;
      &#125;
    &#125;
  ]
&#125;
</code></pre>
<p>  }<br>}</p>
<h1 id="Nested-Aggregation"><a href="#Nested-Aggregation" class="headerlink" title="Nested Aggregation"></a>Nested Aggregation</h1><p>POST my_movies&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “actors”: {<br>      “nested”: {<br>        “path”: “actors”<br>      },<br>      “aggs”: {<br>        “actor_name”: {<br>          “terms”: {<br>            “field”: “actors.first_name”,<br>            “size”: 10<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<h1 id="普通-aggregation不工作"><a href="#普通-aggregation不工作" class="headerlink" title="普通 aggregation不工作"></a>普通 aggregation不工作</h1><p>POST my_movies&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “NAME”: {<br>      “terms”: {<br>        “field”: “actors.first_name”,<br>        “size”: 10<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 7.2-文档的父子关系.md</span><br><span class="line"></span><br><span class="line"># 文档的父子关系</span><br></pre></td></tr></table></figure>
<p>DELETE my_blogs</p>
<h1 id="设定-Parent-Child-Mapping"><a href="#设定-Parent-Child-Mapping" class="headerlink" title="设定 Parent&#x2F;Child Mapping"></a>设定 Parent&#x2F;Child Mapping</h1><p>PUT my_blogs<br>{<br>  “settings”: {<br>    “number_of_shards”: 2<br>  },<br>  “mappings”: {<br>    “properties”: {<br>      “blog_comments_relation”: {<br>        “type”: “join”,<br>        “relations”: {<br>          “blog”: “comment”<br>        }<br>      },<br>      “content”: {<br>        “type”: “text”<br>      },<br>      “title”: {<br>        “type”: “keyword”<br>      }<br>    }<br>  }<br>}</p>
<p>#索引父文档<br>PUT my_blogs&#x2F;_doc&#x2F;blog1<br>{<br>  “title”:”Learning Elasticsearch”,<br>  “content”:”learning ELK @ geektime”,<br>  “blog_comments_relation”:{<br>    “name”:”blog”<br>  }<br>}</p>
<p>#索引父文档<br>PUT my_blogs&#x2F;_doc&#x2F;blog2<br>{<br>  “title”:”Learning Hadoop”,<br>  “content”:”learning Hadoop”,<br>    “blog_comments_relation”:{<br>    “name”:”blog”<br>  }<br>}</p>
<p>#索引子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment1?routing&#x3D;blog1<br>{<br>  “comment”:”I am learning ELK”,<br>  “username”:”Jack”,<br>  “blog_comments_relation”:{<br>    “name”:”comment”,<br>    “parent”:”blog1”<br>  }<br>}</p>
<p>#索引子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment2?routing&#x3D;blog2<br>{<br>  “comment”:”I like Hadoop!!!!!”,<br>  “username”:”Jack”,<br>  “blog_comments_relation”:{<br>    “name”:”comment”,<br>    “parent”:”blog2”<br>  }<br>}</p>
<p>#索引子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment3?routing&#x3D;blog2<br>{<br>  “comment”:”Hello Hadoop”,<br>  “username”:”Bob”,<br>  “blog_comments_relation”:{<br>    “name”:”comment”,<br>    “parent”:”blog2”<br>  }<br>}</p>
<h1 id="查询所有文档"><a href="#查询所有文档" class="headerlink" title="查询所有文档"></a>查询所有文档</h1><p>POST my_blogs&#x2F;_search<br>{</p>
<p>}</p>
<p>#根据父文档ID查看<br>GET my_blogs&#x2F;_doc&#x2F;blog2</p>
<h1 id="Parent-Id-查询"><a href="#Parent-Id-查询" class="headerlink" title="Parent Id 查询"></a>Parent Id 查询</h1><p>POST my_blogs&#x2F;_search<br>{<br>  “query”: {<br>    “parent_id”: {<br>      “type”: “comment”,<br>      “id”: “blog2”<br>    }<br>  }<br>}</p>
<h1 id="Has-Child-查询-返回父文档"><a href="#Has-Child-查询-返回父文档" class="headerlink" title="Has Child 查询,返回父文档"></a>Has Child 查询,返回父文档</h1><p>POST my_blogs&#x2F;_search<br>{<br>  “query”: {<br>    “has_child”: {<br>      “type”: “comment”,<br>      “query” : {<br>                “match”: {<br>                    “username” : “Jack”<br>                }<br>            }<br>    }<br>  }<br>}</p>
<h1 id="Has-Parent-查询，返回相关的子文档"><a href="#Has-Parent-查询，返回相关的子文档" class="headerlink" title="Has Parent 查询，返回相关的子文档"></a>Has Parent 查询，返回相关的子文档</h1><p>POST my_blogs&#x2F;_search<br>{<br>  “query”: {<br>    “has_parent”: {<br>      “parent_type”: “blog”,<br>      “query” : {<br>                “match”: {<br>                    “title” : “Learning Hadoop”<br>                }<br>            }<br>    }<br>  }<br>}</p>
<p>#通过ID ，访问子文档<br>GET my_blogs&#x2F;_doc&#x2F;comment3<br>#通过ID和routing ，访问子文档<br>GET my_blogs&#x2F;_doc&#x2F;comment3?routing&#x3D;blog2</p>
<p>#更新子文档<br>PUT my_blogs&#x2F;_doc&#x2F;comment3?routing&#x3D;blog2<br>{<br>    “comment”: “Hello Hadoop??”,<br>    “blog_comments_relation”: {<br>      “name”: “comment”,<br>      “parent”: “blog2”<br>    }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 7.5-Elasticsearch数据建模实例.md</span><br><span class="line"></span><br><span class="line"># Elasticsearch 数据建模实例</span><br></pre></td></tr></table></figure>
<h6 id="Data-Modeling-Example"><a href="#Data-Modeling-Example" class="headerlink" title="Data Modeling Example"></a>Data Modeling Example</h6><h1 id="Index-一本书的信息"><a href="#Index-一本书的信息" class="headerlink" title="Index 一本书的信息"></a>Index 一本书的信息</h1><p>PUT books&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Mastering ElasticSearch 5.0”,<br>  “description”:”Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins”,<br>  “author”:”Bharvi Dixit”,<br>  “public_date”:”2017”,<br>  “cover_url”:”<a target="_blank" rel="noopener" href="https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg">https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg</a>“<br>}</p>
<p>#查询自动创建的Mapping<br>GET books&#x2F;_mapping</p>
<p>DELETE books</p>
<p>#优化字段类型<br>PUT books<br>{<br>      “mappings” : {<br>      “properties” : {<br>        “author” : {“type” : “keyword”},<br>        “cover_url” : {“type” : “keyword”,”index”: false},<br>        “description” : {“type” : “text”},<br>        “public_date” : {“type” : “date”},<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 100<br>            }<br>          }<br>        }<br>      }<br>    }<br>}</p>
<p>#Cover URL index 设置成false，无法对该字段进行搜索<br>POST books&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “cover_url”: {<br>        “value”: “<a target="_blank" rel="noopener" href="https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg">https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg</a>“<br>      }<br>    }<br>  }<br>}</p>
<p>#Cover URL index 设置成false，依然支持聚合分析<br>POST books&#x2F;_search<br>{<br>  “aggs”: {<br>    “cover”: {<br>      “terms”: {<br>        “field”: “cover_url”,<br>        “size”: 10<br>      }<br>    }<br>  }<br>}</p>
<p>DELETE books<br>#新增 Content字段。数据量很大。选择将Source 关闭<br>PUT books<br>{<br>      “mappings” : {<br>      “_source”: {“enabled”: false},<br>      “properties” : {<br>        “author” : {“type” : “keyword”,”store”: true},<br>        “cover_url” : {“type” : “keyword”,”index”: false,”store”: true},<br>        “description” : {“type” : “text”,”store”: true},<br>         “content” : {“type” : “text”,”store”: true},<br>        “public_date” : {“type” : “date”,”store”: true},<br>        “title” : {<br>          “type” : “text”,<br>          “fields” : {<br>            “keyword” : {<br>              “type” : “keyword”,<br>              “ignore_above” : 100<br>            }<br>          },<br>          “store”: true<br>        }<br>      }<br>    }<br>}</p>
<h1 id="Index-一本书的信息-包含Content"><a href="#Index-一本书的信息-包含Content" class="headerlink" title="Index 一本书的信息,包含Content"></a>Index 一本书的信息,包含Content</h1><p>PUT books&#x2F;_doc&#x2F;1<br>{<br>  “title”:”Mastering ElasticSearch 5.0”,<br>  “description”:”Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins”,<br>  “content”:”The content of the book……Indexing data, aggregation, searching.    something else. something in the way…………”,<br>  “author”:”Bharvi Dixit”,<br>  “public_date”:”2017”,<br>  “cover_url”:”<a target="_blank" rel="noopener" href="https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg">https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg</a>“<br>}</p>
<p>#查询结果中，Source不包含数据<br>POST books&#x2F;_search<br>{}</p>
<p>#搜索，通过store 字段显示数据，同时高亮显示 conent的内容<br>POST books&#x2F;_search<br>{<br>  “stored_fields”: [“title”,”author”,”public_date”],<br>  “query”: {<br>    “match”: {<br>      “content”: “searching”<br>    }<br>  },</p>
<p>  “highlight”: {<br>    “fields”: {<br>      “content”:{}<br>    }<br>  }</p>
<p>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 7.6-Elasticsearch 数据建模最佳实践.md</span><br><span class="line"></span><br><span class="line"># Elasticsearch 数据建模最佳实践</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="Cookie-Service"><a href="#Cookie-Service" class="headerlink" title="Cookie Service"></a>Cookie Service</h6><p>##索引数据，dynamic mapping 会不断加入新增字段<br>PUT cookie_service&#x2F;_doc&#x2F;1<br>{<br> “url”:”<a target="_blank" rel="noopener" href="http://www.google.com/">www.google.com</a>“,<br> “cookies”:{<br>   “username”:”tom”,<br>   “age”:32<br> }<br>}</p>
<p>PUT cookie_service&#x2F;_doc&#x2F;2<br>{<br> “url”:”<a target="_blank" rel="noopener" href="http://www.amazon.com/">www.amazon.com</a>“,<br> “cookies”:{<br>   “login”:”2019-01-01”,<br>   “email”:”<a href="mailto:&#120;&#x79;&#122;&#64;&#x61;&#98;&#x63;&#x2e;&#x63;&#111;&#109;">&#120;&#x79;&#122;&#64;&#x61;&#98;&#x63;&#x2e;&#x63;&#111;&#109;</a>“<br> }<br>}</p>
<p>DELETE cookie_service<br>#使用 Nested 对象，增加key&#x2F;value<br>PUT cookie_service<br>{<br>  “mappings”: {<br>    “properties”: {<br>      “cookies”: {<br>        “type”: “nested”,<br>        “properties”: {<br>          “name”: {<br>            “type”: “keyword”<br>          },<br>          “dateValue”: {<br>            “type”: “date”<br>          },<br>          “keywordValue”: {<br>            “type”: “keyword”<br>          },<br>          “IntValue”: {<br>            “type”: “integer”<br>          }<br>        }<br>      },<br>      “url”: {<br>        “type”: “text”,<br>        “fields”: {<br>          “keyword”: {<br>            “type”: “keyword”,<br>            “ignore_above”: 256<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>##写入数据，使用key和合适类型的value字段<br>PUT cookie_service&#x2F;_doc&#x2F;1<br>{<br> “url”:”<a target="_blank" rel="noopener" href="http://www.google.com/">www.google.com</a>“,<br> “cookies”:[<br>    {<br>      “name”:”username”,<br>      “keywordValue”:”tom”<br>    },<br>    {<br>       “name”:”age”,<br>      “intValue”:32</p>
<pre><code>&#125;
</code></pre>
<p>   ]<br> }</p>
<p>PUT cookie_service&#x2F;_doc&#x2F;2<br>{<br> “url”:”<a target="_blank" rel="noopener" href="http://www.amazon.com/">www.amazon.com</a>“,<br> “cookies”:[<br>    {<br>      “name”:”login”,<br>      “dateValue”:”2019-01-01”<br>    },<br>    {<br>       “name”:”email”,<br>      “IntValue”:32</p>
<pre><code>&#125;
</code></pre>
<p>   ]<br> }</p>
<h1 id="Nested-查询，通过bool查询进行过滤"><a href="#Nested-查询，通过bool查询进行过滤" class="headerlink" title="Nested 查询，通过bool查询进行过滤"></a>Nested 查询，通过bool查询进行过滤</h1><p>POST cookie_service&#x2F;_search<br>{<br>  “query”: {<br>    “nested”: {<br>      “path”: “cookies”,<br>      “query”: {<br>        “bool”: {<br>          “filter”: [<br>            {<br>            “term”: {<br>              “cookies.name”: “age”<br>            }},<br>            {<br>              “range”:{<br>                “cookies.intValue”:{<br>                  “gte”:30<br>                }<br>              }<br>            }<br>          ]<br>        }<br>      }<br>    }<br>  }<br>}</p>
<h1 id="在Mapping中加入元信息，便于管理"><a href="#在Mapping中加入元信息，便于管理" class="headerlink" title="在Mapping中加入元信息，便于管理"></a>在Mapping中加入元信息，便于管理</h1><p>PUT softwares&#x2F;<br>{<br>  “mappings”: {<br>    “_meta”: {<br>      “software_version_mapping”: “1.0”<br>    }<br>  }<br>}</p>
<p>GET softwares&#x2F;_mapping<br>PUT softwares&#x2F;_doc&#x2F;1<br>{<br>  “software_version”:”7.1.0”<br>}</p>
<p>DELETE softwares</p>
<h1 id="优化-使用inner-object"><a href="#优化-使用inner-object" class="headerlink" title="优化,使用inner object"></a>优化,使用inner object</h1><p>PUT softwares&#x2F;<br>{<br>  “mappings”: {<br>    “_meta”: {<br>      “software_version_mapping”: “1.1”<br>    },<br>    “properties”: {<br>      “version”: {<br>        “properties”: {<br>          “display_name”: {<br>            “type”: “keyword”<br>          },<br>          “hot_fix”: {<br>            “type”: “byte”<br>          },<br>          “marjor”: {<br>            “type”: “byte”<br>          },<br>          “minor”: {<br>            “type”: “byte”<br>          }<br>        }<br>      }<br>    }<br>  }<br>}</p>
<p>#通过 Inner Object 写入多个文档<br>PUT softwares&#x2F;_doc&#x2F;1<br>{<br>  “version”:{<br>  “display_name”:”7.1.0”,<br>  “marjor”:7,<br>  “minor”:1,<br>  “hot_fix”:0<br>  }</p>
<p>}</p>
<p>PUT softwares&#x2F;_doc&#x2F;2<br>{<br>  “version”:{<br>  “display_name”:”7.2.0”,<br>  “marjor”:7,<br>  “minor”:2,<br>  “hot_fix”:0<br>  }<br>}</p>
<p>PUT softwares&#x2F;_doc&#x2F;3<br>{<br>  “version”:{<br>  “display_name”:”7.2.1”,<br>  “marjor”:7,<br>  “minor”:2,<br>  “hot_fix”:1<br>  }<br>}</p>
<h1 id="通过-bool-查询，"><a href="#通过-bool-查询，" class="headerlink" title="通过 bool 查询，"></a>通过 bool 查询，</h1><p>POST softwares&#x2F;_search<br>{<br>  “query”: {<br>    “bool”: {<br>      “filter”: [<br>        {<br>          “match”:{<br>            “version.marjor”:7<br>          }<br>        },<br>        {<br>          “match”:{<br>            “version.minor”:2<br>          }<br>        }</p>
<pre><code>  ]
&#125;
</code></pre>
<p>  }<br>}</p>
<h1 id="Not-Null-解决聚合的问题"><a href="#Not-Null-解决聚合的问题" class="headerlink" title="Not Null 解决聚合的问题"></a>Not Null 解决聚合的问题</h1><p>DELETE ratings<br>PUT ratings<br>{<br>  “mappings”: {<br>      “properties”: {<br>        “rating”: {<br>          “type”: “float”,<br>          “null_value”: 1.0<br>        }<br>      }<br>    }<br>}</p>
<p>PUT ratings&#x2F;_doc&#x2F;1<br>{<br> “rating”:5<br>}<br>PUT ratings&#x2F;_doc&#x2F;2<br>{<br> “rating”:null<br>}</p>
<p>POST ratings&#x2F;_search<br>POST ratings&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “avg”: {<br>      “avg”: {<br>        “field”: “rating”<br>      }<br>    }<br>  }<br>}</p>
<p>POST ratings&#x2F;_search<br>{<br>  “query”: {<br>    “term”: {<br>      “rating”: {<br>        “value”: 1<br>      }<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 7.7-第二部分总结与测验.md</span><br><span class="line"></span><br><span class="line"># 第二部分总结与测验</span><br></pre></td></tr></table></figure>
<p>DELETE test<br>PUT test&#x2F;_doc&#x2F;1<br>{<br>  “content”:”Hello World”<br>}</p>
<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content”: “Hello World”<br>    }<br>  }<br>}</p>
<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content”: “hello world”<br>    }<br>  }<br>}</p>
<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content.keyword”: “Hello World”<br>    }<br>  }<br>}</p>
<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “match”: {<br>      “content.keyword”: “hello world”<br>    }<br>  }<br>}</p>
<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “term”: {<br>      “content”: “Hello World”<br>    }<br>  }<br>}</p>
<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “term”: {<br>      “content”: “hello world”<br>    }<br>  }<br>}</p>
<p>POST test&#x2F;_search<br>{<br>  “profile”: “true”,<br>  “query”: {<br>    “term”: {<br>      “content.keyword”: “Hello World”<br>    }<br>  }<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 8.1-集群身份认证与用户鉴权.md</span><br><span class="line"></span><br><span class="line"># 集群身份认证与用户鉴权</span><br><span class="line">- 如何为集群启用X-Pack Security</span><br><span class="line">- 如何为内置用户设置密码</span><br><span class="line">- 设置 Kibana与ElasticSearch通信鉴权</span><br><span class="line">- 使用安全API创建对特定索引具有有限访问权限的用户</span><br><span class="line"></span><br><span class="line">This tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:</span><br><span class="line"></span><br><span class="line">discovery.type: single-node</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>#启动单节点<br>bin&#x2F;elasticsearch -E node.name&#x3D;node0 -E cluster.name&#x3D;geektime -E path.data&#x3D;node0_data -E http.port&#x3D;9200 -E xpack.security.enabled&#x3D;true</p>
<p>#使用Curl访问ES，或者浏览器访问 “localhost:9200&#x2F;_cat&#x2F;nodes?pretty”。返回401错误<br>curl ‘localhost:9200&#x2F;_cat&#x2F;nodes?pretty’</p>
<p>#运行密码设定的命令，设置ES内置用户及其初始密码。<br>bin&#x2F;elasticsearch-setup-passwords interactive</p>
<p>curl -u elastic ‘localhost:9200&#x2F;_cat&#x2F;nodes?pretty’</p>
<h1 id="修改-kibana-yml"><a href="#修改-kibana-yml" class="headerlink" title="修改 kibana.yml"></a>修改 kibana.yml</h1><p>elasticsearch.username: “kibana”<br>elasticsearch.password: “changeme”</p>
<p>#启动。使用用户名，elastic，密码elastic<br>.&#x2F;bin&#x2F;kibana</p>
<p>POST orders&#x2F;_bulk<br>{“index”:{}}<br>{“product” : “1”,”price” : 18,”payment” : “master”,”card” : “9876543210123456”,”name” : “jack”}<br>{“index”:{}}<br>{“product” : “2”,”price” : 99,”payment” : “visa”,”card” : “1234567890123456”,”name” : “bob”}</p>
<p>#create a new role named read_only_orders, that satisfies the following criteria:<br>#The role has no cluster privileges<br>#The role only has access to indices that match the pattern sales_record<br>#The index privileges are read, and view_index_metadata</p>
<p>#create sales_user that satisfies the following criteria:</p>
<h1 id="Use-your-own-email-address"><a href="#Use-your-own-email-address" class="headerlink" title="Use your own email address"></a>Use your own email address</h1><h1 id="Assign-the-user-to-two-roles-read-only-orders-and-kibana-user"><a href="#Assign-the-user-to-two-roles-read-only-orders-and-kibana-user" class="headerlink" title="Assign the user to two roles: read_only_orders and kibana_user"></a>Assign the user to two roles: read_only_orders and kibana_user</h1><p>#验证读权限,可以执行<br>POST orders&#x2F;_search<br>{}</p>
<p>#验证写权限,报错<br>POST orders&#x2F;_bulk<br>{“index”:{}}<br>{“product” : “1”,”price” : 18,”payment” : “master”,”card” : “9876543210123456”,”name” : “jack”}<br>{“index”:{}}<br>{“product” : “2”,”price” : 99,”payment” : “visa”,”card” : “1234567890123456”,”name” : “bob”}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 8.2-集群内部安全通信.md</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h1><h1 id="为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil-ca命令："><a href="#为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil-ca命令：" class="headerlink" title="为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令："></a>为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：</h1><p>bin&#x2F;elasticsearch-certutil ca</p>
<p>#为群集中的每个节点生成证书和私钥。例如，使用elasticsearch-certutil cert 命令：<br>bin&#x2F;elasticsearch-certutil cert –ca elastic-stack-ca.p12</p>
<p>#将证书拷贝到 config&#x2F;certs目录下<br>elastic-certificates.p12</p>
<p>bin&#x2F;elasticsearch -E node.name&#x3D;node0 -E cluster.name&#x3D;geektime -E path.data&#x3D;node0_data -E http.port&#x3D;9200 -E xpack.security.enabled&#x3D;true -E xpack.security.transport.ssl.enabled&#x3D;true -E xpack.security.transport.ssl.verification_mode&#x3D;certificate -E xpack.security.transport.ssl.keystore.path&#x3D;certs&#x2F;elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path&#x3D;certs&#x2F;elastic-certificates.p12</p>
<p>bin&#x2F;elasticsearch -E node.name&#x3D;node1 -E cluster.name&#x3D;geektime -E path.data&#x3D;node1_data -E http.port&#x3D;9201 -E xpack.security.enabled&#x3D;true -E xpack.security.transport.ssl.enabled&#x3D;true -E xpack.security.transport.ssl.verification_mode&#x3D;certificate -E xpack.security.transport.ssl.keystore.path&#x3D;certs&#x2F;elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path&#x3D;certs&#x2F;elastic-certificates.p12</p>
<p>#不提供证书的节点，无法加入<br>bin&#x2F;elasticsearch -E node.name&#x3D;node2 -E cluster.name&#x3D;geektime -E path.data&#x3D;node2_data -E http.port&#x3D;9202 -E xpack.security.enabled&#x3D;true -E xpack.security.transport.ssl.enabled&#x3D;true -E xpack.security.transport.ssl.verification_mode&#x3D;certificate</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="elasticsearch-yml-配置"><a href="#elasticsearch-yml-配置" class="headerlink" title="elasticsearch.yml 配置"></a>elasticsearch.yml 配置</h2><p>#xpack.security.transport.ssl.enabled: true<br>#xpack.security.transport.ssl.verification_mode: certificate</p>
<p>#xpack.security.transport.ssl.keystore.path: certs&#x2F;elastic-certificates.p12<br>#xpack.security.transport.ssl.truststore.path: certs&#x2F;elastic-certificates.p12</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 8.3-集群与外部间的安全通信.md</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>xpack.security.http.ssl.enabled: true<br>xpack.security.http.ssl.keystore.path: certs&#x2F;elastic-certificates.p12<br>xpack.security.http.ssl.truststore.path: certs&#x2F;elastic-certificates.p12</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># ES 启用 https</span><br><span class="line">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#Kibana 连接 ES https</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 为kibana生成pem</span><br><span class="line">openssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elasticsearch.hosts: [&quot;https://localhost:9200&quot;]</span><br><span class="line">elasticsearch.ssl.certificateAuthorities: [ &quot;/Users/yiruan/geektime/kibana-7.1.0/config/certs/elastic-ca.pem&quot; ]</span><br><span class="line">elasticsearch.ssl.verificationMode: certificate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 为 Kibna 配置 HTTPS</span><br><span class="line"># 生成后解压，包含了instance.crt 和 instance.key</span><br><span class="line">bin/elasticsearch-certutil ca --pem</span><br><span class="line"></span><br><span class="line">server.ssl.enabled: true</span><br><span class="line">server.ssl.certificate: config/certs/instance.crt</span><br><span class="line">server.ssl.key: config/certs/instance.key</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="9-1-常见的集群部署方式-md"><a href="#9-1-常见的集群部署方式-md" class="headerlink" title="9.1-常见的集群部署方式.md"></a>9.1-常见的集群部署方式.md</h1><h1 id="常见的集群部署方式"><a href="#常见的集群部署方式" class="headerlink" title="常见的集群部署方式"></a>常见的集群部署方式</h1><h1 id="9-2-Hot-Warm架构与ShardFiltering-md"><a href="#9-2-Hot-Warm架构与ShardFiltering-md" class="headerlink" title="9.2-Hot&amp;Warm架构与ShardFiltering.md"></a>9.2-Hot&amp;Warm架构与ShardFiltering.md</h1><h1 id="Hot-Warm-架构与-Shard-Filtering"><a href="#Hot-Warm-架构与-Shard-Filtering" class="headerlink" title="Hot &amp; Warm 架构与 Shard Filtering"></a>Hot &amp; Warm 架构与 Shard Filtering</h1><h2 id="课程代码"><a href="#课程代码" class="headerlink" title="课程代码"></a>课程代码</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"># 标记一个 Hot 节点</span><br><span class="line">bin/elasticsearch  -E node.name=hotnode -E cluster.name=geektime -E path.data=hot_data -E node.attr.my_node_type=hot</span><br><span class="line"></span><br><span class="line"># 标记一个 warm 节点</span><br><span class="line">bin/elasticsearch  -E node.name=warmnode -E cluster.name=geektime -E path.data=warm_data -E node.attr.my_node_type=warm</span><br><span class="line"></span><br><span class="line"># 查看节点</span><br><span class="line">GET /_cat/nodeattrs?v</span><br><span class="line"></span><br><span class="line"># 配置到 Hot节点</span><br><span class="line">PUT logs-2019-06-27</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;:&#123;</span><br><span class="line">    &quot;number_of_shards&quot;:2,</span><br><span class="line">    &quot;number_of_replicas&quot;:0,</span><br><span class="line">    &quot;index.routing.allocation.require.my_node_type&quot;:&quot;hot&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT my_index1/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET _cat/shards?v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置到 warm 节点</span><br><span class="line">PUT PUT logs-2019-06-27/_settings</span><br><span class="line">&#123;  </span><br><span class="line">  &quot;index.routing.allocation.require.my_node_type&quot;:&quot;warm&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 标记一个 rack 1</span><br><span class="line">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class="line"></span><br><span class="line"># 标记一个 rack 2</span><br><span class="line">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack2</span><br><span class="line"></span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;:&#123;</span><br><span class="line">    &quot;number_of_shards&quot;:2,</span><br><span class="line">    &quot;number_of_replicas&quot;:1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index1/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET _cat/shards?v</span><br><span class="line">DELETE my_index1/_doc/1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Fore awareness</span><br><span class="line"># 标记一个 rack 1</span><br><span class="line">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class="line"></span><br><span class="line"># 标记一个 rack 2</span><br><span class="line">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;,</span><br><span class="line">    &quot;cluster.routing.allocation.awareness.force.my_rack_id.values&quot;: &quot;rack1,rack2&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET _cluster/settings</span><br><span class="line"></span><br><span class="line"># 集群黄色</span><br><span class="line">GET _cluster/health</span><br><span class="line"></span><br><span class="line"># 副本无法分配</span><br><span class="line">GET _cat/shards?v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET _cluster/allocation/explain?pretty</span><br></pre></td></tr></table></figure>
<h1 id="9-3-如何对集群进行容量规划-md"><a href="#9-3-如何对集群进行容量规划-md" class="headerlink" title="9.3-如何对集群进行容量规划.md"></a>9.3-如何对集群进行容量规划.md</h1><h1 id="如何对集群进行容量规划"><a href="#如何对集群进行容量规划" class="headerlink" title="如何对集群进行容量规划"></a>如何对集群进行容量规划</h1><h2 id="代码Demo"><a href="#代码Demo" class="headerlink" title="代码Demo"></a>代码Demo</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PUT logs_2019-06-27</span><br><span class="line">PUT logs_2019-06-26</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;logs_2019-06-27&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;logs_write&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;remove&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;logs_2019-06-26&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;logs_write&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># POST /&lt;logs-&#123;now/d&#125;/_search</span><br><span class="line">POST /%3Clogs-%7Bnow%2Fd%7D%3E/_search</span><br><span class="line"></span><br><span class="line"># POST /&lt;logs-&#123;now/w&#125;/_search</span><br><span class="line">POST /%3Clogs-%7Bnow%2Fw%7D%3E/_search</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="9-4-分片设计及管理-md"><a href="#9-4-分片设计及管理-md" class="headerlink" title="9.4-分片设计及管理.md"></a>9.4-分片设计及管理.md</h1><h1 id="分片设计及管理"><a href="#分片设计及管理" class="headerlink" title="分片设计及管理"></a>分片设计及管理</h1><h1 id="9-5-在私有云上管理与部署Elasticsearch集群-md"><a href="#9-5-在私有云上管理与部署Elasticsearch集群-md" class="headerlink" title="9.5-在私有云上管理与部署Elasticsearch集群.md"></a>9.5-在私有云上管理与部署Elasticsearch集群.md</h1><h1 id="在私有云上管理与部署-Elasticsearch-集群"><a href="#在私有云上管理与部署-Elasticsearch-集群" class="headerlink" title="在私有云上管理与部署 Elasticsearch 集群"></a>在私有云上管理与部署 Elasticsearch 集群</h1><h1 id="9-6-在公有云上管理与部署Elasticsearch集群-md"><a href="#9-6-在公有云上管理与部署Elasticsearch集群-md" class="headerlink" title="9.6-在公有云上管理与部署Elasticsearch集群.md"></a>9.6-在公有云上管理与部署Elasticsearch集群.md</h1><h1 id="在公有云上管理与部署-Elasticsearch-集群"><a href="#在公有云上管理与部署-Elasticsearch-集群" class="headerlink" title="在公有云上管理与部署 Elasticsearch 集群"></a>在公有云上管理与部署 Elasticsearch 集群</h1><h1 id="result-md"><a href="#result-md" class="headerlink" title="result.md"></a>result.md</h1><h1 id="10-1-生产环境常用配置与上线清单-md"><a href="#10-1-生产环境常用配置与上线清单-md" class="headerlink" title="10.1-生产环境常用配置与上线清单.md"></a>10.1-生产环境常用配置与上线清单.md</h1><h1 id="生产环境查用配置与线上清单"><a href="#生产环境查用配置与线上清单" class="headerlink" title="生产环境查用配置与线上清单"></a>生产环境查用配置与线上清单</h1><h1 id="10-10-一些运维相关的建议-md"><a href="#10-10-一些运维相关的建议-md" class="headerlink" title="10.10-一些运维相关的建议.md"></a>10.10-一些运维相关的建议.md</h1><h1 id="一些运维相关的建议"><a href="#一些运维相关的建议" class="headerlink" title="一些运维相关的建议"></a>一些运维相关的建议</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"># 移动一个分片从一个节点到另外一个节点</span><br><span class="line"></span><br><span class="line">POST _cluster/reroute</span><br><span class="line">&#123;</span><br><span class="line">  &quot;commands&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;move&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;index_name&quot;,</span><br><span class="line">        &quot;shard&quot;: 0,</span><br><span class="line">        &quot;from_node&quot;: &quot;node_name_1&quot;,</span><br><span class="line">        &quot;to_node&quot;: &quot;node_name_2&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Fore the allocation of an unassinged shard with a reason</span><br><span class="line"></span><br><span class="line">POST _cluster/reroute?explain</span><br><span class="line">&#123;</span><br><span class="line">  &quot;commands&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;allocate&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;index_name&quot;,</span><br><span class="line">        &quot;shard&quot;: 0,</span><br><span class="line">        &quot;node&quot;: &quot;nodename&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># remove the nodes from cluster </span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.exclude._ip&quot;:&quot;the_IP_of_your_node&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Force a synced flush</span><br><span class="line">POST _flush/synced</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># change the number of moving shards to balance the cluster</span><br><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;&quot;cluster.routing.allocation.cluster_concurrent_rebalance&quot;:2&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># change the number of shards being recovered simultanceously per node</span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;&quot;cluster.routing.allocation.node_concurrent_recoveries&quot;:5&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Change the recovery speed</span><br><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;&quot;indices.recovery.max_bytes_per_sec&quot;: &quot;80mb&quot;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Change the number of concurrent streams for a recovery on a single node</span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;&quot;indices.recovery.concurrent_streams&quot;:6&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Change the sinze of the search queue</span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;</span><br><span class="line">    &quot;threadpool.search.queue_size&quot;:2000</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Clear the cache on a node</span><br><span class="line">POST _cache/clear</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Adjust the circuit breakers</span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;indices.breaker.total.limit&quot;:&quot;40%&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="10-2-监控Elasticsearch集群-md"><a href="#10-2-监控Elasticsearch集群-md" class="headerlink" title="10.2-监控Elasticsearch集群.md"></a>10.2-监控Elasticsearch集群.md</h1><h1 id="监控-Elasticsearch-集群-1"><a href="#监控-Elasticsearch-集群-1" class="headerlink" title="监控 Elasticsearch 集群"></a>监控 Elasticsearch 集群</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"># Node Stats：</span><br><span class="line">GET _nodes/stats</span><br><span class="line"></span><br><span class="line">#Cluster Stats:</span><br><span class="line">GET _cluster/stats</span><br><span class="line"></span><br><span class="line">#Index Stats:</span><br><span class="line">GET kibana_sample_data_ecommerce/_stats</span><br><span class="line"></span><br><span class="line">#Pending Cluster Tasks API:</span><br><span class="line">GET _cluster/pending_tasks</span><br><span class="line"></span><br><span class="line"># 查看所有的 tasks，也支持 cancel task</span><br><span class="line">GET _tasks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET _nodes/thread_pool</span><br><span class="line">GET _nodes/stats/thread_pool</span><br><span class="line">GET _cat/thread_pool?v</span><br><span class="line">GET _nodes/hot_threads</span><br><span class="line">GET _nodes/stats/thread_pool</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置 Index Slowlogs</span><br><span class="line"># the first 1000 characters of the doc&#x27;s source will be logged</span><br><span class="line">PUT my_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index.indexing.slowlog&quot;:&#123;</span><br><span class="line">    &quot;threshold.index&quot;:&#123;</span><br><span class="line">      &quot;warn&quot;:&quot;10s&quot;,</span><br><span class="line">      &quot;info&quot;: &quot;4s&quot;,</span><br><span class="line">      &quot;debug&quot;:&quot;2s&quot;,</span><br><span class="line">      &quot;trace&quot;:&quot;0s&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;level&quot;:&quot;trace&quot;,</span><br><span class="line">    &quot;source&quot;:1000  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 设置查询</span><br><span class="line">DELETE my_index</span><br><span class="line">//&quot;0&quot; logs all queries</span><br><span class="line">PUT my_index/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.search.slowlog.threshold&quot;: &#123;</span><br><span class="line">      &quot;query.warn&quot;: &quot;10s&quot;,</span><br><span class="line">      &quot;query.info&quot;: &quot;3s&quot;,</span><br><span class="line">      &quot;query.debug&quot;: &quot;2s&quot;,</span><br><span class="line">      &quot;query.trace&quot;: &quot;0s&quot;,</span><br><span class="line">      &quot;fetch.warn&quot;: &quot;1s&quot;,</span><br><span class="line">      &quot;fetch.info&quot;: &quot;600ms&quot;,</span><br><span class="line">      &quot;fetch.debug&quot;: &quot;400ms&quot;,</span><br><span class="line">      &quot;fetch.trace&quot;: &quot;0s&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_index</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="10-3-诊断集群的潜在问题-md"><a href="#10-3-诊断集群的潜在问题-md" class="headerlink" title="10.3-诊断集群的潜在问题.md"></a>10.3-诊断集群的潜在问题.md</h1><h1 id="诊断集群的潜在问题"><a href="#诊断集群的潜在问题" class="headerlink" title="诊断集群的潜在问题"></a>诊断集群的潜在问题</h1><h1 id="10-4-解决集群Yellow与Red的问题-md"><a href="#10-4-解决集群Yellow与Red的问题-md" class="headerlink" title="10.4-解决集群Yellow与Red的问题.md"></a>10.4-解决集群Yellow与Red的问题.md</h1><h1 id="集群健康与问题排查"><a href="#集群健康与问题排查" class="headerlink" title="集群健康与问题排查"></a>集群健康与问题排查</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">#案例1</span><br><span class="line">DELETE mytest</span><br><span class="line">PUT mytest</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;:&#123;</span><br><span class="line">    &quot;number_of_shards&quot;:3,</span><br><span class="line">    &quot;number_of_replicas&quot;:0,</span><br><span class="line">    &quot;index.routing.allocation.require.box_type&quot;:&quot;hott&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 检查集群状态，查看是否有节点丢失，有多少分片无法分配</span><br><span class="line">GET /_cluster/health/</span><br><span class="line"></span><br><span class="line"># 查看索引级别,找到红色的索引</span><br><span class="line">GET /_cluster/health?level=indices</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查看索引的分片</span><br><span class="line">GET _cluster/health?level=shards</span><br><span class="line"></span><br><span class="line"># Explain 变红的原因</span><br><span class="line">GET /_cluster/allocation/explain</span><br><span class="line"></span><br><span class="line">GET /_cat/shards/mytest</span><br><span class="line">GET _cat/nodeattrs</span><br><span class="line"></span><br><span class="line">DELETE mytest</span><br><span class="line">GET /_cluster/health/</span><br><span class="line"></span><br><span class="line">PUT mytest</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;:&#123;</span><br><span class="line">    &quot;number_of_shards&quot;:3,</span><br><span class="line">    &quot;number_of_replicas&quot;:0,</span><br><span class="line">    &quot;index.routing.allocation.require.box_type&quot;:&quot;hot&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_cluster/health/</span><br><span class="line"></span><br><span class="line">#案例2, Explain 看 hot 上的 explain</span><br><span class="line">DELETE mytest</span><br><span class="line">PUT mytest</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;:&#123;</span><br><span class="line">    &quot;number_of_shards&quot;:2,</span><br><span class="line">    &quot;number_of_replicas&quot;:1,</span><br><span class="line">    &quot;index.routing.allocation.require.box_type&quot;:&quot;hot&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _cluster/health</span><br><span class="line">GET _cat/shards/mytest</span><br><span class="line">GET /_cluster/allocation/explain</span><br><span class="line"></span><br><span class="line">PUT mytest/_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;number_of_replicas&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="10-5-提升集群写性能-md"><a href="#10-5-提升集群写性能-md" class="headerlink" title="10.5-提升集群写性能.md"></a>10.5-提升集群写性能.md</h1><h1 id="提升集群写性能-1"><a href="#提升集群写性能-1" class="headerlink" title="提升集群写性能"></a>提升集群写性能</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">DELETE myindex</span><br><span class="line">PUT myindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &#123;</span><br><span class="line">      &quot;refresh_interval&quot;: &quot;30s&quot;,</span><br><span class="line">      &quot;number_of_shards&quot;: &quot;2&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;routing&quot;: &#123;</span><br><span class="line">      &quot;allocation&quot;: &#123;</span><br><span class="line">        &quot;total_shards_per_node&quot;: &quot;3&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;translog&quot;: &#123;</span><br><span class="line">      &quot;sync_interval&quot;: &quot;30s&quot;,</span><br><span class="line">      &quot;durability&quot;: &quot;async&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;number_of_replicas&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;dynamic&quot;: false,</span><br><span class="line">    &quot;properties&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="10-6-提升集群读性能-md"><a href="#10-6-提升集群读性能-md" class="headerlink" title="10.6-提升集群读性能.md"></a>10.6-提升集群读性能.md</h1><h1 id="提升集群读性能-1"><a href="#提升集群读性能-1" class="headerlink" title="提升集群读性能"></a>提升集群读性能</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">PUT blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;elasticsearch&quot;</span><br><span class="line">&#125;</span><br><span class="line">GET blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &quot;elasticsearch&quot;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ],</span><br><span class="line">      </span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;script&quot;: &#123;</span><br><span class="line">          &quot;script&quot;: &#123;</span><br><span class="line">            &quot;source&quot;: &quot;doc[&#x27;title.keyword&#x27;].value.length()&gt;5&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;&quot;title&quot;: &quot;elasticsearch&quot;&#125;&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;publish_date&quot;: &#123;</span><br><span class="line">              &quot;gte&quot;: 2017,</span><br><span class="line">              &quot;lte&quot;: 2019</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="10-7-集群压力测试-md"><a href="#10-7-集群压力测试-md" class="headerlink" title="10.7-集群压力测试.md"></a>10.7-集群压力测试.md</h1><h1 id="集群压力测试-1"><a href="#集群压力测试-1" class="headerlink" title="集群压力测试"></a>集群压力测试</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pip3 install esrally</span><br><span class="line"></span><br><span class="line">esrally configure</span><br><span class="line"></span><br><span class="line"># 只测试 1000条数据</span><br><span class="line">esrally --distribution-version=7.1.0 --test-mode</span><br><span class="line"></span><br><span class="line"># 测试完整数据</span><br><span class="line">esrally --distribution-version=7.1.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/elastic/rally-tracks">https://github.com/elastic/rally-tracks</a></li>
<li><a target="_blank" rel="noopener" href="https://logz.io/blog/rally/">https://logz.io/blog/rally/</a></li>
</ul>
<h1 id="10-9-缓存及使用Breaker限制内存使用-md"><a href="#10-9-缓存及使用Breaker限制内存使用-md" class="headerlink" title="10.9-缓存及使用Breaker限制内存使用.md"></a>10.9-缓存及使用Breaker限制内存使用.md</h1><h1 id="缓存及使用Circuit-Breaker限制内存使用"><a href="#缓存及使用Circuit-Breaker限制内存使用" class="headerlink" title="缓存及使用Circuit Breaker限制内存使用"></a>缓存及使用Circuit Breaker限制内存使用</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET _cat/nodes?v</span><br><span class="line"></span><br><span class="line">GET _nodes/stats/indices?pretty</span><br><span class="line"></span><br><span class="line">GET _cat/nodes?v&amp;h=name,queryCacheMemory,queryCacheEvictions,requestCacheMemory,requestCacheHitCount,request_cache.miss_count</span><br><span class="line"></span><br><span class="line">GET _cat/nodes?h=name,port,segments.memory,segments.index_writer_memory,fielddata.memory_size,query_cache.memory_size,request_cache.memory_size&amp;v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;persistent&quot; : &#123;</span><br><span class="line">       &quot;indices.breaker.request.limit&quot; : &quot;90%&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="补充阅读"><a href="#补充阅读" class="headerlink" title="补充阅读"></a>补充阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/blog/improving-node-resiliency-with-the-real-memory-circuit-breaker">https://www.elastic.co/blog/improving-node-resiliency-with-the-real-memory-circuit-breaker</a></li>
</ul>
<h1 id="11-1-使用Shrink与RolloverAPI有效管理时间序列索引-md"><a href="#11-1-使用Shrink与RolloverAPI有效管理时间序列索引-md" class="headerlink" title="11.1-使用Shrink与RolloverAPI有效管理时间序列索引.md"></a>11.1-使用Shrink与RolloverAPI有效管理时间序列索引.md</h1><h1 id="使用-shrink与rolloverAPI有效的管理索引"><a href="#使用-shrink与rolloverAPI有效的管理索引" class="headerlink" title="使用 shrink与rolloverAPI有效的管理索引"></a>使用 shrink与rolloverAPI有效的管理索引</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 打开关闭索引</span><br><span class="line">DELETE test</span><br><span class="line">#查看索引是否存在</span><br><span class="line">HEAD test</span><br><span class="line"></span><br><span class="line">PUT test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#关闭索引</span><br><span class="line">POST /test/_close</span><br><span class="line">#索引存在</span><br><span class="line">HEAD test</span><br><span class="line"># 无法查询</span><br><span class="line">POST test/_count</span><br><span class="line"></span><br><span class="line">#打开索引</span><br><span class="line">POST /test/_open</span><br><span class="line">POST test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">POST test/_count</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在一个 hot-warm-cold的集群上进行测试</span><br><span class="line">GET _cat/nodes</span><br><span class="line">GET _cat/nodeattrs</span><br><span class="line"></span><br><span class="line">DELETE my_source_index</span><br><span class="line">DELETE my_target_index</span><br><span class="line">PUT my_source_index</span><br><span class="line">&#123;</span><br><span class="line"> &quot;settings&quot;: &#123;</span><br><span class="line">   &quot;number_of_shards&quot;: 4,</span><br><span class="line">   &quot;number_of_replicas&quot;: 0</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_source_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _cat/shards/my_source_index</span><br><span class="line"></span><br><span class="line"># 分片数3，会失败</span><br><span class="line">POST my_source_index/_shrink/my_target_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class="line">    &quot;index.number_of_shards&quot;: 3,</span><br><span class="line">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 报错，因为没有置成 readonly</span><br><span class="line">POST my_source_index/_shrink/my_target_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class="line">    &quot;index.number_of_shards&quot;: 2,</span><br><span class="line">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#将 my_source_index 设置为只读</span><br><span class="line">PUT /my_source_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.blocks.write&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 报错，必须都在一个节点</span><br><span class="line">POST my_source_index/_shrink/my_target_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class="line">    &quot;index.number_of_shards&quot;: 2,</span><br><span class="line">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE my_source_index</span><br><span class="line">## 确保分片都在 hot</span><br><span class="line">PUT my_source_index</span><br><span class="line">&#123;</span><br><span class="line"> &quot;settings&quot;: &#123;</span><br><span class="line">   &quot;number_of_shards&quot;: 4,</span><br><span class="line">   &quot;number_of_replicas&quot;: 0,</span><br><span class="line">   &quot;index.routing.allocation.include.box_type&quot;:&quot;hot&quot;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_source_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _cat/shards/my_source_index</span><br><span class="line"></span><br><span class="line">#设置为只读</span><br><span class="line">PUT /my_source_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.blocks.write&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST my_source_index/_shrink/my_target_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.number_of_replicas&quot;: 0,</span><br><span class="line">    &quot;index.number_of_shards&quot;: 2,</span><br><span class="line">    &quot;index.codec&quot;: &quot;best_compression&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;my_search_indices&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET _cat/shards/my_target_index</span><br><span class="line"></span><br><span class="line"># My target_index状态为也只读</span><br><span class="line">PUT my_target_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Split Index</span><br><span class="line">DELETE my_source_index</span><br><span class="line">DELETE my_target_index</span><br><span class="line"></span><br><span class="line">PUT my_source_index</span><br><span class="line">&#123;</span><br><span class="line"> &quot;settings&quot;: &#123;</span><br><span class="line">   &quot;number_of_shards&quot;: 4,</span><br><span class="line">   &quot;number_of_replicas&quot;: 0</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_source_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _cat/shards/my_source_index</span><br><span class="line"></span><br><span class="line"># 必须是倍数</span><br><span class="line">POST my_source_index/_split/my_target</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.number_of_shards&quot;: 10</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 必须是只读</span><br><span class="line">POST my_source_index/_split/my_target</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.number_of_shards&quot;: 8</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#设置为只读</span><br><span class="line">PUT /my_source_index/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.blocks.write&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST my_source_index/_split/my_target_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;index.number_of_shards&quot;: 8,</span><br><span class="line">    &quot;index.number_of_replicas&quot;:0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET _cat/shards/my_target_index</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># write block</span><br><span class="line">PUT my_target_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Rollover API</span><br><span class="line">DELETE nginx-logs*</span><br><span class="line"># 不设定 is_write_true</span><br><span class="line"># 名字符合命名规范</span><br><span class="line">PUT /nginx-logs-000001</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;nginx_logs_write&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 多次写入文档</span><br><span class="line">POST nginx_logs_write/_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;log&quot;:&quot;something&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /nginx_logs_write/_rollover</span><br><span class="line">&#123;</span><br><span class="line">  &quot;conditions&quot;: &#123;</span><br><span class="line">    &quot;max_age&quot;:   &quot;1d&quot;,</span><br><span class="line">    &quot;max_docs&quot;:  5,</span><br><span class="line">    &quot;max_size&quot;:  &quot;5gb&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /nginx_logs_write/_count</span><br><span class="line"># 查看 Alias信息</span><br><span class="line">GET /nginx_logs_write</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE apache-logs*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置 is_write_index</span><br><span class="line">PUT apache-logs1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;apache_logs&quot;: &#123;</span><br><span class="line">      &quot;is_write_index&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">POST apache_logs/_count</span><br><span class="line"></span><br><span class="line">POST apache_logs/_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 需要指定 target 的名字</span><br><span class="line">POST /apache_logs/_rollover/apache-logs8xxxx</span><br><span class="line">&#123;</span><br><span class="line">  &quot;conditions&quot;: &#123;</span><br><span class="line">    &quot;max_age&quot;:   &quot;1d&quot;,</span><br><span class="line">    &quot;max_docs&quot;:  1,</span><br><span class="line">    &quot;max_size&quot;:  &quot;5gb&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看 Alias信息</span><br><span class="line">GET /apache_logs</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="11-2-索引全生命周期管理及工具介绍-md"><a href="#11-2-索引全生命周期管理及工具介绍-md" class="headerlink" title="11.2-索引全生命周期管理及工具介绍.md"></a>11.2-索引全生命周期管理及工具介绍.md</h1><h1 id="索引全生命周期管理及工具介绍"><a href="#索引全生命周期管理及工具介绍" class="headerlink" title="索引全生命周期管理及工具介绍"></a>索引全生命周期管理及工具介绍</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 运行三个节点，分片 将box_type设置成 hot，warm和cold</span><br><span class="line"># 具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置 1秒刷新1次，生产环境10分种刷新一次</span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;indices.lifecycle.poll_interval&quot;:&quot;1s&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 设置 Policy</span><br><span class="line">PUT /_ilm/policy/log_ilm_policy</span><br><span class="line">&#123;</span><br><span class="line">  &quot;policy&quot;: &#123;</span><br><span class="line">    &quot;phases&quot;: &#123;</span><br><span class="line">      &quot;hot&quot;: &#123;</span><br><span class="line">        &quot;actions&quot;: &#123;</span><br><span class="line">          &quot;rollover&quot;: &#123;</span><br><span class="line">            &quot;max_docs&quot;: 5</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;warm&quot;: &#123;</span><br><span class="line">        &quot;min_age&quot;: &quot;10s&quot;,</span><br><span class="line">        &quot;actions&quot;: &#123;</span><br><span class="line">          &quot;allocate&quot;: &#123;</span><br><span class="line">            &quot;include&quot;: &#123;</span><br><span class="line">              &quot;box_type&quot;: &quot;warm&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;cold&quot;: &#123;</span><br><span class="line">        &quot;min_age&quot;: &quot;15s&quot;,</span><br><span class="line">        &quot;actions&quot;: &#123;</span><br><span class="line">          &quot;allocate&quot;: &#123;</span><br><span class="line">            &quot;include&quot;: &#123;</span><br><span class="line">              &quot;box_type&quot;: &quot;cold&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;delete&quot;: &#123;</span><br><span class="line">        &quot;min_age&quot;: &quot;20s&quot;,</span><br><span class="line">        &quot;actions&quot;: &#123;</span><br><span class="line">          &quot;delete&quot;: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置索引模版</span><br><span class="line">PUT /_template/log_ilm_template</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index_patterns&quot; : [</span><br><span class="line">      &quot;ilm_index-*&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &#123;</span><br><span class="line">        &quot;lifecycle&quot; : &#123;</span><br><span class="line">          &quot;name&quot; : &quot;log_ilm_policy&quot;,</span><br><span class="line">          &quot;rollover_alias&quot; : &quot;ilm_alias&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;routing&quot; : &#123;</span><br><span class="line">          &quot;allocation&quot; : &#123;</span><br><span class="line">            &quot;include&quot; : &#123;</span><br><span class="line">              &quot;box_type&quot; : &quot;hot&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;number_of_shards&quot; : &quot;1&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot; : &quot;0&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot; : &#123; &#125;,</span><br><span class="line">    &quot;aliases&quot; : &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建索引</span><br><span class="line">PUT ilm_index-000001</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1,</span><br><span class="line">    &quot;number_of_replicas&quot;: 0,</span><br><span class="line">    &quot;index.lifecycle.name&quot;: &quot;log_ilm_policy&quot;,</span><br><span class="line">    &quot;index.lifecycle.rollover_alias&quot;: &quot;ilm_alias&quot;,</span><br><span class="line">    &quot;index.routing.allocation.include.box_type&quot;:&quot;hot&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;ilm_alias&quot;: &#123;</span><br><span class="line">      &quot;is_write_index&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 对 Alias写入文档</span><br><span class="line">POST  ilm_alias/_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;dfd&quot;:&quot;dfdsf&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="12-1-Logstash入门及架构介绍-md"><a href="#12-1-Logstash入门及架构介绍-md" class="headerlink" title="12.1-Logstash入门及架构介绍.md"></a>12.1-Logstash入门及架构介绍.md</h1><h1 id="Logstash-入门及架构介绍"><a href="#Logstash-入门及架构介绍" class="headerlink" title="Logstash 入门及架构介绍"></a>Logstash 入门及架构介绍</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 一个 Demo， demo 运行</span><br><span class="line">sudo bin/logstash -f logstash-filter.conf</span><br><span class="line"></span><br><span class="line"># demo数据</span><br><span class="line">127.0.0.1 - - [11/Dec/2013:00:01:45 -0800] &quot;GET /xampp/status.php HTTP/1.1&quot; 200 3891 &quot;http://cadenza/xampp/navi.php&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.9; rv:25.0) Gecko/20100101 Firefox/25.0&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># codec demo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo bin/logstash -e &quot;input&#123;stdin&#123;codec=&gt;line&#125;&#125;output&#123;stdout&#123;codec=&gt; rubydebug&#125;&#125;&quot;</span><br><span class="line">sudo bin/logstash -e &quot;input&#123;stdin&#123;codec=&gt;json&#125;&#125;output&#123;stdout&#123;codec=&gt; rubydebug&#125;&#125;&quot;</span><br><span class="line">sudo bin/logstash -e &quot;input&#123;stdin&#123;codec=&gt;line&#125;&#125;output&#123;stdout&#123;codec=&gt; dots&#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo bin/logstash -f multiline-exception.conf</span><br><span class="line"></span><br><span class="line"># 多行数据，异常</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.NullPointerException</span><br><span class="line">        at com.example.myproject.Book.getTitle(Book.java:16)</span><br><span class="line">        at com.example.myproject.Author.getBookTitles(Author.java:25)</span><br><span class="line">        at com.example.myproject.Bootstrap.main(Bootstrap.java:14)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 一个实例</span><br><span class="line">https://github.com/onebirdrocks/geektime-ELK/blob/master/part-1/2.4-Logstash%E5%AE%89%E8%A3%85%E4%B8%8E%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE/movielens/logstash.conf</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="12-2-利用JDBC插件导入数据到Elasticsearch-md"><a href="#12-2-利用JDBC插件导入数据到Elasticsearch-md" class="headerlink" title="12.2-利用JDBC插件导入数据到Elasticsearch.md"></a>12.2-利用JDBC插件导入数据到Elasticsearch.md</h1><h1 id="Logstash插件及文档介绍"><a href="#Logstash插件及文档介绍" class="headerlink" title="Logstash插件及文档介绍"></a>Logstash插件及文档介绍</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">https://spring.io/guides/gs/accessing-data-mysql/</span><br><span class="line">create database db_example;</span><br><span class="line">use db_example;</span><br><span class="line">show tables;</span><br><span class="line">drop table user;</span><br><span class="line">select * from user;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 新增用户</span><br><span class="line">curl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ</span><br><span class="line">curl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ</span><br><span class="line">curl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ</span><br><span class="line"></span><br><span class="line">#查看所有的用户</span><br><span class="line">curl &#x27;localhost:8080/demo/all&#x27;</span><br><span class="line"></span><br><span class="line"># 更新用户</span><br><span class="line">curl -X PUT localhost:8080/demo/update -d id=16 -d name=Bob2 -d email=bob2@xyz.com -d tags=Mysql,IntelliJ</span><br><span class="line"></span><br><span class="line"># 删除用户</span><br><span class="line">curl -X DELETE localhost:8080/demo/delete -d id=15</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql-demo.conf</span><br><span class="line"></span><br><span class="line"># 创建 alias，只显示没有被标记 deleted的用户</span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;users&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;view_users&quot;,</span><br><span class="line">         &quot;filter&quot; : &#123; &quot;term&quot; : &#123; &quot;is_deleted&quot; : false &#125; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 通过 Alias查询，查不到被标记成 deleted的用户</span><br><span class="line">POST view_users/_search</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST view_users/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;name.keyword&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;Jack&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;name.keyword&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;Jack&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="12-3-Beats介绍-md"><a href="#12-3-Beats介绍-md" class="headerlink" title="12.3-Beats介绍.md"></a>12.3-Beats介绍.md</h1><h1 id="Beats介绍"><a href="#Beats介绍" class="headerlink" title="Beats介绍"></a>Beats介绍</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##</span><br><span class="line"># 查看 packetbeat 模块</span><br><span class="line"># 设置 packetbeat 的mysql 模块</span><br><span class="line"># 启动运行</span><br><span class="line">#</span><br><span class="line">./metricbeat modules list</span><br><span class="line">./metricbeat modules enable mysql</span><br><span class="line">./metricbeat setup --dashboards</span><br><span class="line"></span><br><span class="line"># 安装mysql</span><br><span class="line">create database db_example</span><br><span class="line">use db_example;</span><br><span class="line">show tables;</span><br><span class="line">select * from user</span><br><span class="line"></span><br><span class="line">curl localhost:8080/demo/add -d name=Mike -d email=mike@xyz.com -d tags=Elasticsearch,IntelliJ</span><br><span class="line">curl localhost:8080/demo/add -d name=Jack -d email=jack@xyz.com -d tags=Mysql,IntelliJ</span><br><span class="line">curl localhost:8080/demo/add -d name=Bob -d email=bob@xyz.com -d tags=Mysql,IntelliJ</span><br><span class="line"></span><br><span class="line">curl &#x27;localhost:8080/demo/all&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置 packetbeat</span><br><span class="line"># 启动</span><br><span class="line">修改 packetbeat，打开 http 5601 9200 和 mysql 3306监控</span><br><span class="line"></span><br><span class="line">sudo chown root packetbeat.yml</span><br><span class="line">sudo ./packetbeat setup --dashboards</span><br><span class="line">sudo ./packetbeat</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看所有 Filebeat 模块</span><br><span class="line"># 查看所有的modules</span><br><span class="line">./filebeat modules list</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line">./filebeat modules enable mysql</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="13-1-使用IndexPattern配置数据-md"><a href="#13-1-使用IndexPattern配置数据-md" class="headerlink" title="13.1-使用IndexPattern配置数据.md"></a>13.1-使用IndexPattern配置数据.md</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">localhost:5601/status</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT /logstash-2015.05.18</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;geo&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;coordinates&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;geo_point&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT /logstash-2015.05.19</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;geo&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;coordinates&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;geo_point&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT /logstash-2015.05.20</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;geo&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;coordinates&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;geo_point&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># For Mac &amp; Windows</span><br><span class="line">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/_bulk?pretty&#x27; --data-binary @logs.jsonl</span><br><span class="line"></span><br><span class="line">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/bank/account/_bulk?pretty&#x27; --data-binary @accounts.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#For Windows</span><br><span class="line">Invoke-RestMethod &quot;http://localhost:9200/_bulk?pretty&quot; -Method Post -ContentType &#x27;application/x-ndjson&#x27; -InFile &quot;logs.jsonl&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /_cat/indices?v</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="13-2-使用KibanaDiscover探索数据-md"><a href="#13-2-使用KibanaDiscover探索数据-md" class="headerlink" title="13.2-使用KibanaDiscover探索数据.md"></a>13.2-使用KibanaDiscover探索数据.md</h1><h1 id="使用Kibana-Discovery-探索数据"><a href="#使用Kibana-Discovery-探索数据" class="headerlink" title="使用Kibana Discovery 探索数据"></a>使用Kibana Discovery 探索数据</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">设置时间过滤器</span><br><span class="line">搜索你的数据</span><br><span class="line">根据字段进行过滤</span><br><span class="line">查看文档数据</span><br><span class="line">查看文档上下文</span><br><span class="line">暂时字段数据统计</span><br><span class="line">Save Query</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="13-3-基本可视化组件介绍-md"><a href="#13-3-基本可视化组件介绍-md" class="headerlink" title="13.3-基本可视化组件介绍.md"></a>13.3-基本可视化组件介绍.md</h1><h1 id="基本可视化组件介绍"><a href="#基本可视化组件介绍" class="headerlink" title="基本可视化组件介绍"></a>基本可视化组件介绍</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PUT /shakespeare</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;speaker&quot;: &#123;&quot;type&quot;: &quot;keyword&quot;&#125;,</span><br><span class="line">    &quot;play_name&quot;: &#123;&quot;type&quot;: &quot;keyword&quot;&#125;,</span><br><span class="line">    &quot;line_id&quot;: &#123;&quot;type&quot;: &quot;integer&quot;&#125;,</span><br><span class="line">    &quot;speech_number&quot;: &#123;&quot;type&quot;: &quot;integer&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># For Mac &amp; Windows</span><br><span class="line">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/bank/account/_bulk?pretty&#x27; --data-binary @accounts.json</span><br><span class="line">curl -H &#x27;Content-Type: application/x-ndjson&#x27; -XPOST &#x27;localhost:9200/shakespeare/_bulk?pretty&#x27; --data-binary @shakespeare.json</span><br><span class="line"></span><br><span class="line">#For Windows</span><br><span class="line">Invoke-RestMethod &quot;http://localhost:9200/bank/account/_bulk?pretty&quot; -Method Post -ContentType &#x27;application/x-ndjson&#x27; -InFile &quot;accounts.json&quot;</span><br><span class="line">Invoke-RestMethod &quot;http://localhost:9200/shakespeare/_bulk?pretty&quot; -Method Post -ContentType &#x27;application/x-ndjson&#x27; -InFile &quot;shakespeare.json&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="13-4-构建Dashboard-md"><a href="#13-4-构建Dashboard-md" class="headerlink" title="13.4-构建Dashboard.md"></a>13.4-构建Dashboard.md</h1><h1 id="构建Dashboard"><a href="#构建Dashboard" class="headerlink" title="构建Dashboard"></a>构建Dashboard</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 创建仪表潘</span><br><span class="line">- 加载仪表盘</span><br><span class="line">- 共享仪表盘</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="14-3用机器学习实现时序数据的异常检测-上-md"><a href="#14-3用机器学习实现时序数据的异常检测-上-md" class="headerlink" title="14.3用机器学习实现时序数据的异常检测-上.md"></a>14.3用机器学习实现时序数据的异常检测-上.md</h1><p>mkdir server_metrics<br>cd server_metrics<br>wget <a target="_blank" rel="noopener" href="https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz">https://download.elasticsearch.org/demos/machine_learning/gettingstarted/server_metrics.tar.gz</a><br>tar -xvf server_metrics.tar.gz</p>
<h1 id="14-5-用ELK进行日志管理-md"><a href="#14-5-用ELK进行日志管理-md" class="headerlink" title="14.5-用ELK进行日志管理.md"></a>14.5-用ELK进行日志管理.md</h1><h1 id="用-ELK-来做日志管理"><a href="#用-ELK-来做日志管理" class="headerlink" title="用 ELK 来做日志管理"></a>用 ELK 来做日志管理</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">./filebeat modules list</span><br><span class="line">./filebeat modules enable system</span><br><span class="line">./filebeat modules enable elasticsearch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 进 modules.d 编辑相应的文件，修改log路径</span><br><span class="line"></span><br><span class="line">./filebeat setup –dashboards</span><br><span class="line"></span><br><span class="line">./filebeat export template | more</span><br><span class="line"></span><br><span class="line">./filebeat -e</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="14-6-用Canvas做数据演示-md"><a href="#14-6-用Canvas做数据演示-md" class="headerlink" title="14.6-用Canvas做数据演示.md"></a>14.6-用Canvas做数据演示.md</h1><p>POST elasticoffee&#x2F;_search<br>{<br>  “size”: 0,<br>  “aggs”: {<br>    “by”: {<br>      “terms”: {<br>        “field”: “beverage.keyword”,<br>        “size”: 10<br>      }<br>    }<br>  }<br>}</p>
<h1 id="4-1-基于词项和基于全文的搜索-md"><a href="#4-1-基于词项和基于全文的搜索-md" class="headerlink" title="4.1-基于词项和基于全文的搜索.md"></a>4.1-基于词项和基于全文的搜索.md</h1><h1 id="基于词项和基于全文的搜索"><a href="#基于词项和基于全文的搜索" class="headerlink" title="基于词项和基于全文的搜索"></a>基于词项和基于全文的搜索</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">DELETE products</span><br><span class="line">PUT products</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot;,&quot;desc&quot;:&quot;iPhone&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot;,&quot;desc&quot;:&quot;iPad&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class="line">&#123; &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot;,&quot;desc&quot;:&quot;MBP&quot; &#125;</span><br><span class="line"></span><br><span class="line">GET /products</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;desc&quot;: &#123;</span><br><span class="line">        //&quot;value&quot;: &quot;iPhone&quot;</span><br><span class="line">        &quot;value&quot;:&quot;iphone&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;desc.keyword&quot;: &#123;</span><br><span class="line">        //&quot;value&quot;: &quot;iPhone&quot;</span><br><span class="line">        //&quot;value&quot;:&quot;iphone&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;productID&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  //&quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;productID.keyword&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#设置 position_increment_gap</span><br><span class="line">DELETE groups</span><br><span class="line">PUT groups</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;names&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;position_increment_gap&quot;: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET groups/_mapping</span><br><span class="line"></span><br><span class="line">POST groups/_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;names&quot;: [ &quot;John Water&quot;, &quot;Water Smith&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST groups/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;names&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;Water Water&quot;,</span><br><span class="line">        &quot;slop&quot;: 100</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST groups/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;names&quot;: &quot;Water Smith&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-10-综合排序：Function-Score-Query-优化算分-md"><a href="#4-10-综合排序：Function-Score-Query-优化算分-md" class="headerlink" title="4.10-综合排序：Function Score Query 优化算分.md"></a>4.10-综合排序：Function Score Query 优化算分.md</h1><h1 id="综合排序：Function-Score-Query-优化算分"><a href="#综合排序：Function-Score-Query-优化算分" class="headerlink" title="综合排序：Function Score Query 优化算分"></a>综合排序：Function Score Query 优化算分</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">DELETE blogs</span><br><span class="line">PUT /blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:   &quot;About popularity&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;In this post we will talk about...&quot;,</span><br><span class="line">  &quot;votes&quot;:   0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /blogs/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:   &quot;About popularity&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;In this post we will talk about...&quot;,</span><br><span class="line">  &quot;votes&quot;:   100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /blogs/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:   &quot;About popularity&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;In this post we will talk about...&quot;,</span><br><span class="line">  &quot;votes&quot;:   1000000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;function_score&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &#123;</span><br><span class="line">        &quot;multi_match&quot;: &#123;</span><br><span class="line">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class="line">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;field_value_factor&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;votes&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;function_score&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &#123;</span><br><span class="line">        &quot;multi_match&quot;: &#123;</span><br><span class="line">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class="line">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;field_value_factor&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;votes&quot;,</span><br><span class="line">        &quot;modifier&quot;: &quot;log1p&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;function_score&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &#123;</span><br><span class="line">        &quot;multi_match&quot;: &#123;</span><br><span class="line">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class="line">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;field_value_factor&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;votes&quot;,</span><br><span class="line">        &quot;modifier&quot;: &quot;log1p&quot; ,</span><br><span class="line">        &quot;factor&quot;: 0.1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;function_score&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &#123;</span><br><span class="line">        &quot;multi_match&quot;: &#123;</span><br><span class="line">          &quot;query&quot;:    &quot;popularity&quot;,</span><br><span class="line">          &quot;fields&quot;: [ &quot;title&quot;, &quot;content&quot; ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;field_value_factor&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;votes&quot;,</span><br><span class="line">        &quot;modifier&quot;: &quot;log1p&quot; ,</span><br><span class="line">        &quot;factor&quot;: 0.1</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;boost_mode&quot;: &quot;sum&quot;,</span><br><span class="line">      &quot;max_boost&quot;: 3</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;function_score&quot;: &#123;</span><br><span class="line">      &quot;random_score&quot;: &#123;</span><br><span class="line">        &quot;seed&quot;: 911119</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-12-自动补全与基于上下文的提示-md"><a href="#4-12-自动补全与基于上下文的提示-md" class="headerlink" title="4.12-自动补全与基于上下文的提示.md"></a>4.12-自动补全与基于上下文的提示.md</h1><h1 id="自动补全与基于上下文的提示"><a href="#自动补全与基于上下文的提示" class="headerlink" title="自动补全与基于上下文的提示"></a>自动补全与基于上下文的提示</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">DELETE articles</span><br><span class="line">PUT articles</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;title_completion&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;completion&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST articles/_bulk</span><br><span class="line">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class="line">&#123; &quot;title_completion&quot;: &quot;lucene is very cool&quot;&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class="line">&#123; &quot;title_completion&quot;: &quot;Elasticsearch builds on top of lucene&quot;&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class="line">&#123; &quot;title_completion&quot;: &quot;Elasticsearch rocks&quot;&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class="line">&#123; &quot;title_completion&quot;: &quot;elastic is the company behind ELK stack&quot;&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123; &#125; &#125;</span><br><span class="line">&#123; &quot;title_completion&quot;: &quot;Elk stack rocks&quot;&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;&#125; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST articles/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;suggest&quot;: &#123;</span><br><span class="line">    &quot;article-suggester&quot;: &#123;</span><br><span class="line">      &quot;prefix&quot;: &quot;elk &quot;,</span><br><span class="line">      &quot;completion&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;title_completion&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE comments</span><br><span class="line">PUT comments</span><br><span class="line">PUT comments/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;comment_autocomplete&quot;:&#123;</span><br><span class="line">      &quot;type&quot;: &quot;completion&quot;,</span><br><span class="line">      &quot;contexts&quot;:[&#123;</span><br><span class="line">        &quot;type&quot;:&quot;category&quot;,</span><br><span class="line">        &quot;name&quot;:&quot;comment_category&quot;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST comments/_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;comment&quot;:&quot;I love the star war movies&quot;,</span><br><span class="line">  &quot;comment_autocomplete&quot;:&#123;</span><br><span class="line">    &quot;input&quot;:[&quot;star wars&quot;],</span><br><span class="line">    &quot;contexts&quot;:&#123;</span><br><span class="line">      &quot;comment_category&quot;:&quot;movies&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST comments/_doc</span><br><span class="line">&#123;</span><br><span class="line">  &quot;comment&quot;:&quot;Where can I find a Starbucks&quot;,</span><br><span class="line">  &quot;comment_autocomplete&quot;:&#123;</span><br><span class="line">    &quot;input&quot;:[&quot;starbucks&quot;],</span><br><span class="line">    &quot;contexts&quot;:&#123;</span><br><span class="line">      &quot;comment_category&quot;:&quot;coffee&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST comments/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;suggest&quot;: &#123;</span><br><span class="line">    &quot;MY_SUGGESTION&quot;: &#123;</span><br><span class="line">      &quot;prefix&quot;: &quot;sta&quot;,</span><br><span class="line">      &quot;completion&quot;:&#123;</span><br><span class="line">        &quot;field&quot;:&quot;comment_autocomplete&quot;,</span><br><span class="line">        &quot;contexts&quot;:&#123;</span><br><span class="line">          &quot;comment_category&quot;:&quot;coffee&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="4-13-跨集群搜索-md"><a href="#4-13-跨集群搜索-md" class="headerlink" title="4.13-跨集群搜索.md"></a>4.13-跨集群搜索.md</h1><h1 id="跨集群搜索"><a href="#跨集群搜索" class="headerlink" title="跨集群搜索"></a>跨集群搜索</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">//启动3个集群</span><br><span class="line"></span><br><span class="line">bin/elasticsearch -E node.name=cluster0node -E cluster.name=cluster0 -E path.data=cluster0_data -E discovery.type=single-node -E http.port=9200 -E transport.port=9300</span><br><span class="line">bin/elasticsearch -E node.name=cluster1node -E cluster.name=cluster1 -E path.data=cluster1_data -E discovery.type=single-node -E http.port=9201 -E transport.port=9301</span><br><span class="line">bin/elasticsearch -E node.name=cluster2node -E cluster.name=cluster2 -E path.data=cluster2_data -E discovery.type=single-node -E http.port=9202 -E transport.port=9302</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//在每个集群上设置动态的设置</span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;cluster&quot;: &#123;</span><br><span class="line">      &quot;remote&quot;: &#123;</span><br><span class="line">        &quot;cluster0&quot;: &#123;</span><br><span class="line">          &quot;seeds&quot;: [</span><br><span class="line">            &quot;127.0.0.1:9300&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;transport.ping_schedule&quot;: &quot;30s&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;cluster1&quot;: &#123;</span><br><span class="line">          &quot;seeds&quot;: [</span><br><span class="line">            &quot;127.0.0.1:9301&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;transport.compress&quot;: true,</span><br><span class="line">          &quot;skip_unavailable&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;cluster2&quot;: &#123;</span><br><span class="line">          &quot;seeds&quot;: [</span><br><span class="line">            &quot;127.0.0.1:9302&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#cURL</span><br><span class="line">curl -XPUT &quot;http://localhost:9200/_cluster/settings&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class="line">&#123;&quot;persistent&quot;:&#123;&quot;cluster&quot;:&#123;&quot;remote&quot;:&#123;&quot;cluster0&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9300&quot;],&quot;transport.ping_schedule&quot;:&quot;30s&quot;&#125;,&quot;cluster1&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9301&quot;],&quot;transport.compress&quot;:true,&quot;skip_unavailable&quot;:true&#125;,&quot;cluster2&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9302&quot;]&#125;&#125;&#125;&#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line">curl -XPUT &quot;http://localhost:9201/_cluster/settings&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class="line">&#123;&quot;persistent&quot;:&#123;&quot;cluster&quot;:&#123;&quot;remote&quot;:&#123;&quot;cluster0&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9300&quot;],&quot;transport.ping_schedule&quot;:&quot;30s&quot;&#125;,&quot;cluster1&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9301&quot;],&quot;transport.compress&quot;:true,&quot;skip_unavailable&quot;:true&#125;,&quot;cluster2&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9302&quot;]&#125;&#125;&#125;&#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line">curl -XPUT &quot;http://localhost:9202/_cluster/settings&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class="line">&#123;&quot;persistent&quot;:&#123;&quot;cluster&quot;:&#123;&quot;remote&quot;:&#123;&quot;cluster0&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9300&quot;],&quot;transport.ping_schedule&quot;:&quot;30s&quot;&#125;,&quot;cluster1&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9301&quot;],&quot;transport.compress&quot;:true,&quot;skip_unavailable&quot;:true&#125;,&quot;cluster2&quot;:&#123;&quot;seeds&quot;:[&quot;127.0.0.1:9302&quot;]&#125;&#125;&#125;&#125;&#125;&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建测试数据</span><br><span class="line">curl -XPOST &quot;http://localhost:9200/users/_doc&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class="line">&#123;&quot;name&quot;:&quot;user1&quot;,&quot;age&quot;:10&#125;&#x27;</span><br><span class="line"></span><br><span class="line">curl -XPOST &quot;http://localhost:9201/users/_doc&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class="line">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:20&#125;&#x27;</span><br><span class="line"></span><br><span class="line">curl -XPOST &quot;http://localhost:9202/users/_doc&quot; -H &#x27;Content-Type: application/json&#x27; -d&#x27;</span><br><span class="line">&#123;&quot;name&quot;:&quot;user3&quot;,&quot;age&quot;:30&#125;&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查询</span><br><span class="line">GET /users,cluster1:users,cluster2:users/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 20,</span><br><span class="line">        &quot;lte&quot;: 40</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="4-2-结构化搜索-md"><a href="#4-2-结构化搜索-md" class="headerlink" title="4.2-结构化搜索.md"></a>4.2-结构化搜索.md</h1><h1 id="结构化搜索"><a href="#结构化搜索" class="headerlink" title="结构化搜索"></a>结构化搜索</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#结构化搜索，精确匹配</span><br><span class="line">DELETE products</span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 10,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2018-01-01&quot;, &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 20,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2019-01-01&quot;, &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:true, &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:false, &quot;productID&quot; : &quot;QQPX-R-3956-#aD8&quot; &#125;</span><br><span class="line"></span><br><span class="line">GET products/_mapping</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#对布尔值 match 查询，有算分</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;avaliable&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#对布尔值，通过constant score 转成 filtering，没有算分</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;avaliable&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#数字类型 Term</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: 30</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#数字类型 terms</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;terms&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: [</span><br><span class="line">            &quot;20&quot;,</span><br><span class="line">            &quot;30&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#数字 Range 查询</span><br><span class="line">GET products/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;constant_score&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;range&quot; : &#123;</span><br><span class="line">                    &quot;price&quot; : &#123;</span><br><span class="line">                        &quot;gte&quot; : 20,</span><br><span class="line">                        &quot;lte&quot;  : 30</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 日期 range</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">        &quot;constant_score&quot; : &#123;</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;range&quot; : &#123;</span><br><span class="line">                    &quot;date&quot; : &#123;</span><br><span class="line">                      &quot;gte&quot; : &quot;now-1y&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#exists查询</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;exists&quot;: &#123;</span><br><span class="line">          &quot;field&quot;: &quot;date&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#处理多值字段</span><br><span class="line">POST /movies/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot; : &quot;Father of the Bridge Part II&quot;,&quot;year&quot;:1995, &quot;genre&quot;:&quot;Comedy&quot;&#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot; : &quot;Dave&quot;,&quot;year&quot;:1993,&quot;genre&quot;:[&quot;Comedy&quot;,&quot;Romance&quot;] &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#处理多值字段，term 查询是包含，而不是等于</span><br><span class="line">POST movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;genre.keyword&quot;: &quot;Comedy&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#字符类型 terms</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;terms&quot;: &#123;</span><br><span class="line">          &quot;productID.keyword&quot;: [</span><br><span class="line">            &quot;QQPX-R-3956-#aD8&quot;,</span><br><span class="line">            &quot;JODL-X-1937-#pV7&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: 30</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;date&quot;: &quot;2019-01-01&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;date&quot;: &quot;2019-01-01&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;productID.keyword&quot;: &quot;XHDK-A-1293-#fJ3&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#对布尔数值</span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;avaliable&quot;: &quot;false&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;avaliable&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;false&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;20&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;price&quot;: &quot;20&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">          &quot;must_not&quot;: &#123;</span><br><span class="line">            &quot;exists&quot;: &#123;</span><br><span class="line">              &quot;field&quot;: &quot;date&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="4-3-搜索的相关性算分-md"><a href="#4-3-搜索的相关性算分-md" class="headerlink" title="4.3-搜索的相关性算分.md"></a>4.3-搜索的相关性算分.md</h1><h1 id="搜索的相关性算分"><a href="#搜索的相关性算分" class="headerlink" title="搜索的相关性算分"></a>搜索的相关性算分</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">PUT testscore</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT testscore/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;content&quot;:&quot;we use Elasticsearch to power the search&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;content&quot;:&quot;we like elasticsearch&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class="line">&#123; &quot;content&quot;:&quot;The scoring of documents is caculated by the scoring formula&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class="line">&#123; &quot;content&quot;:&quot;you know, for search&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /testscore/_search</span><br><span class="line">&#123;</span><br><span class="line">  //&quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content&quot;:&quot;you&quot;</span><br><span class="line">      //&quot;content&quot;: &quot;elasticsearch&quot;</span><br><span class="line">      //&quot;content&quot;:&quot;the&quot;</span><br><span class="line">      //&quot;content&quot;: &quot;the elasticsearch&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST testscore/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;boosting&quot; : &#123;</span><br><span class="line">            &quot;positive&quot; : &#123;</span><br><span class="line">                &quot;term&quot; : &#123;</span><br><span class="line">                    &quot;content&quot; : &quot;elasticsearch&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;negative&quot; : &#123;</span><br><span class="line">                 &quot;term&quot; : &#123;</span><br><span class="line">                     &quot;content&quot; : &quot;like&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;negative_boost&quot; : 0.2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST tmdb/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_source&quot;: [&quot;title&quot;,&quot;overview&quot;],</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;more_like_this&quot;: &#123;</span><br><span class="line">      &quot;fields&quot;: [</span><br><span class="line">        &quot;title^10&quot;,&quot;overview&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;like&quot;: [&#123;&quot;_id&quot;:&quot;14191&quot;&#125;],</span><br><span class="line">      &quot;min_term_freq&quot;: 1,</span><br><span class="line">      &quot;max_query_terms&quot;: 12</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="4-4-Query-Filtering实现多字符串多字段查询-md"><a href="#4-4-Query-Filtering实现多字符串多字段查询-md" class="headerlink" title="4.4-Query&amp;Filtering实现多字符串多字段查询.md"></a>4.4-Query&amp;Filtering实现多字符串多字段查询.md</h1><h1 id="Query-Filtering-与多字符串多字段查询"><a href="#Query-Filtering-与多字符串多字段查询" class="headerlink" title="Query &amp; Filtering 与多字符串多字段查询"></a>Query &amp; Filtering 与多字符串多字段查询</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line">POST /products/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 10,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2018-01-01&quot;, &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 20,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2019-01-01&quot;, &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:true, &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:false, &quot;productID&quot; : &quot;QQPX-R-3956-#aD8&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#基本语法</span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot; : &#123;</span><br><span class="line">      &quot;must&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;price&quot; : &quot;30&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must_not&quot; : &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">          &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;should&quot; : [</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;JODL-X-1937-#pV7&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;minimum_should_match&quot; :1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#改变数据模型，增加字段。解决数组包含而不是精确匹配的问题</span><br><span class="line">POST /newmovies/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot; : &quot;Father of the Bridge Part II&quot;,&quot;year&quot;:1995, &quot;genre&quot;:&quot;Comedy&quot;,&quot;genre_count&quot;:1 &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot; : &quot;Dave&quot;,&quot;year&quot;:1993,&quot;genre&quot;:[&quot;Comedy&quot;,&quot;Romance&quot;],&quot;genre_count&quot;:2 &#125;</span><br><span class="line"></span><br><span class="line">#must，有算分</span><br><span class="line">POST /newmovies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;genre.keyword&quot;: &#123;&quot;value&quot;: &quot;Comedy&quot;&#125;&#125;&#125;,</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;genre_count&quot;: &#123;&quot;value&quot;: 1&#125;&#125;&#125;</span><br><span class="line"></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#Filter。不参与算分，结果的score是0</span><br><span class="line">POST /newmovies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;genre.keyword&quot;: &#123;&quot;value&quot;: &quot;Comedy&quot;&#125;&#125;&#125;,</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;genre_count&quot;: &#123;&quot;value&quot;: 1&#125;&#125;&#125;</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Filtering Context</span><br><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot; : &#123;</span><br><span class="line"></span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must_not&quot; : &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">          &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Query Context</span><br><span class="line">POST /products/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 10,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2018-01-01&quot;, &quot;productID&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 20,&quot;avaliable&quot;:true,&quot;date&quot;:&quot;2019-01-01&quot;, &quot;productID&quot; : &quot;KDKE-B-9947-#kL5&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:true, &quot;productID&quot; : &quot;JODL-X-1937-#pV7&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 4 &#125;&#125;</span><br><span class="line">&#123; &quot;price&quot; : 30,&quot;avaliable&quot;:false, &quot;productID&quot; : &quot;QQPX-R-3956-#aD8&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;productID.keyword&quot;: &#123;</span><br><span class="line">              &quot;value&quot;: &quot;JODL-X-1937-#pV7&quot;&#125;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;&quot;term&quot;: &#123;&quot;avaliable&quot;: &#123;&quot;value&quot;: true&#125;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#嵌套，实现了 should not 逻辑</span><br><span class="line">POST /products/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;price&quot;: &quot;30&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must_not&quot;: &#123;</span><br><span class="line">              &quot;term&quot;: &#123;</span><br><span class="line">                &quot;avaliable&quot;: &quot;false&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;minimum_should_match&quot;: 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Controll the Precision</span><br><span class="line">POST _search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot; : &#123;</span><br><span class="line">      &quot;must&quot; : &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;price&quot; : &quot;30&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot; : &#123; &quot;avaliable&quot; : &quot;true&quot; &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must_not&quot; : &#123;</span><br><span class="line">        &quot;range&quot; : &#123;</span><br><span class="line">          &quot;price&quot; : &#123; &quot;lte&quot; : 10 &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;should&quot; : [</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;JODL-X-1937-#pV7&quot; &#125; &#125;,</span><br><span class="line">        &#123; &quot;term&quot; : &#123; &quot;productID.keyword&quot; : &quot;XHDK-A-1293-#fJ3&quot; &#125; &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;minimum_should_match&quot; :2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST /animals/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;brown&quot; &#125;&#125;,</span><br><span class="line">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;red&quot; &#125;&#125;,</span><br><span class="line">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;quick&quot;   &#125;&#125;,</span><br><span class="line">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;dog&quot;   &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /animals/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;quick&quot; &#125;&#125;,</span><br><span class="line">        &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;dog&quot;   &#125;&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;bool&quot;:&#123;</span><br><span class="line">            &quot;should&quot;:[</span><br><span class="line">               &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;brown&quot; &#125;&#125;,</span><br><span class="line">                 &#123; &quot;term&quot;: &#123; &quot;text&quot;: &quot;brown&quot; &#125;&#125;,</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE blogs</span><br><span class="line">POST /blogs/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;Apple iPad&quot;, &quot;content&quot;:&quot;Apple iPad,Apple iPad&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;Apple iPad,Apple iPad&quot;, &quot;content&quot;:&quot;Apple iPad&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;title&quot;: &#123;</span><br><span class="line">            &quot;query&quot;: &quot;apple,ipad&quot;,</span><br><span class="line">            &quot;boost&quot;: 1.1</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;,</span><br><span class="line"></span><br><span class="line">        &#123;&quot;match&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &#123;</span><br><span class="line">            &quot;query&quot;: &quot;apple,ipad&quot;,</span><br><span class="line">            &quot;boost&quot;:</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE news</span><br><span class="line">POST /news/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;content&quot;:&quot;Apple Mac&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;content&quot;:&quot;Apple iPad&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 3 &#125;&#125;</span><br><span class="line">&#123; &quot;content&quot;:&quot;Apple employee like Apple Pie and Apple Juice&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: &#123;</span><br><span class="line">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;apple&quot;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: &#123;</span><br><span class="line">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;apple&quot;&#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;must_not&quot;: &#123;</span><br><span class="line">        &quot;match&quot;:&#123;&quot;content&quot;:&quot;pie&quot;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST news/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;boosting&quot;: &#123;</span><br><span class="line">      &quot;positive&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &quot;apple&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;content&quot;: &quot;pie&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative_boost&quot;: 0.5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="4-5-单字符串多字段查询-DisMaxQuery-md"><a href="#4-5-单字符串多字段查询-DisMaxQuery-md" class="headerlink" title="4.5-单字符串多字段查询-DisMaxQuery.md"></a>4.5-单字符串多字段查询-DisMaxQuery.md</h1><h1 id="单字符串多字段查询：Dis-Max-Query"><a href="#单字符串多字段查询：Dis-Max-Query" class="headerlink" title="单字符串多字段查询：Dis Max Query"></a>单字符串多字段查询：Dis Max Query</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PUT /blogs/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;Quick brown rabbits&quot;,</span><br><span class="line">    &quot;body&quot;:  &quot;Brown rabbits are commonly seen.&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /blogs/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;Keeping pets healthy&quot;,</span><br><span class="line">    &quot;body&quot;:  &quot;My quick brown fox eats rabbits on a regular basis.&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;should&quot;: [</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Brown fox&quot; &#125;&#125;,</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Brown fox&quot; &#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;dis_max&quot;: &#123;</span><br><span class="line">            &quot;queries&quot;: [</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;dis_max&quot;: &#123;</span><br><span class="line">            &quot;queries&quot;: [</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;tie_breaker&quot;: 0.2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="4-6-单字符串多字段查询-Multi-Match-md"><a href="#4-6-单字符串多字段查询-Multi-Match-md" class="headerlink" title="4.6-单字符串多字段查询-Multi-Match.md"></a>4.6-单字符串多字段查询-Multi-Match.md</h1><h1 id="单字符串多字段查询：Multi-Match"><a href="#单字符串多字段查询：Multi-Match" class="headerlink" title="单字符串多字段查询：Multi Match"></a>单字符串多字段查询：Multi Match</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;dis_max&quot;: &#123;</span><br><span class="line">            &quot;queries&quot;: [</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;title&quot;: &quot;Quick pets&quot; &#125;&#125;,</span><br><span class="line">                &#123; &quot;match&quot;: &#123; &quot;body&quot;:  &quot;Quick pets&quot; &#125;&#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;tie_breaker&quot;: 0.2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;best_fields&quot;,</span><br><span class="line">      &quot;query&quot;: &quot;Quick pets&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;title&quot;,&quot;body&quot;],</span><br><span class="line">      &quot;tie_breaker&quot;: 0.2,</span><br><span class="line">      &quot;minimum_should_match&quot;: &quot;20%&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST books/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">        &quot;query&quot;:  &quot;Quick brown fox&quot;,</span><br><span class="line">        &quot;fields&quot;: &quot;*_title&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST books/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">        &quot;query&quot;:  &quot;Quick brown fox&quot;,</span><br><span class="line">        &quot;fields&quot;: [ &quot;*_title&quot;, &quot;chapter_title^2&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE /titles</span><br><span class="line">PUT /titles</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123; &quot;number_of_shards&quot;: 1 &#125;,</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">        &quot;my_type&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;title&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;:     &quot;string&quot;,</span><br><span class="line">                    &quot;analyzer&quot;: &quot;english&quot;,</span><br><span class="line">                    &quot;fields&quot;: &#123;</span><br><span class="line">                        &quot;std&quot;:   &#123;</span><br><span class="line">                            &quot;type&quot;:     &quot;string&quot;,</span><br><span class="line">                            &quot;analyzer&quot;: &quot;standard&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /titles</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;english&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST titles/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;My dog barks&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;I see a lot of barking dogs on the road &quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET titles/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;barking dogs&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE /titles</span><br><span class="line">PUT /titles</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;english&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;&quot;std&quot;: &#123;&quot;type&quot;: &quot;text&quot;,&quot;analyzer&quot;: &quot;standard&quot;&#125;&#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST titles/_bulk</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 1 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;My dog barks&quot; &#125;</span><br><span class="line">&#123; &quot;index&quot;: &#123; &quot;_id&quot;: 2 &#125;&#125;</span><br><span class="line">&#123; &quot;title&quot;: &quot;I see a lot of barking dogs on the road &quot; &#125;</span><br><span class="line"></span><br><span class="line">GET /titles/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot;: &#123;</span><br><span class="line">        &quot;multi_match&quot;: &#123;</span><br><span class="line">            &quot;query&quot;:  &quot;barking dogs&quot;,</span><br><span class="line">            &quot;type&quot;:   &quot;most_fields&quot;,</span><br><span class="line">            &quot;fields&quot;: [ &quot;title&quot;, &quot;title.std&quot; ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /titles/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot;: &#123;</span><br><span class="line">        &quot;multi_match&quot;: &#123;</span><br><span class="line">            &quot;query&quot;:  &quot;barking dogs&quot;,</span><br><span class="line">            &quot;type&quot;:   &quot;most_fields&quot;,</span><br><span class="line">            &quot;fields&quot;: [ &quot;title^10&quot;, &quot;title.std&quot; ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="4-7-多语言及中文分词与检索-md"><a href="#4-7-多语言及中文分词与检索-md" class="headerlink" title="4.7-多语言及中文分词与检索.md"></a>4.7-多语言及中文分词与检索.md</h1><h1 id="多语言及中文分词与检索"><a href="#多语言及中文分词与检索" class="headerlink" title="多语言及中文分词与检索"></a>多语言及中文分词与检索</h1><ul>
<li><p>来到杨过曾经生活过的地方，小龙女动情地说：“我也想过过过儿过过的生活。”</p>
</li>
<li><p>你也想犯范范玮琪犯过的错吗</p>
</li>
<li><p>校长说衣服上除了校徽别别别的</p>
</li>
<li><p>这几天天天天气不好</p>
</li>
<li><p>我背有点驼，麻麻说“你的背得背背背背佳</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">#stop word</span><br><span class="line"></span><br><span class="line">DELETE my_index</span><br><span class="line">PUT /my_index/_doc/1</span><br><span class="line">&#123; &quot;title&quot;: &quot;I&#x27;m happy for this fox&quot; &#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/_doc/2</span><br><span class="line">&#123; &quot;title&quot;: &quot;I&#x27;m not happy about my fox problem&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;title&quot;: &quot;not happy fox&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#虽然通过使用 english （英语）分析器，使得匹配规则更加宽松，我们也因此提高了召回率，但却降低了精准匹配文档的能力。为了获得两方面的优势，我们可以使用multifields（多字段）对 title 字段建立两次索引： 一次使用 `english`（英语）分析器，另一次使用 `standard`（标准）分析器:</span><br><span class="line"></span><br><span class="line">DELETE my_index</span><br><span class="line"></span><br><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;blog&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;title&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;analyzer&quot;: &quot;english&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;blog&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;title&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;string&quot;,</span><br><span class="line">          &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;english&quot;: &#123;</span><br><span class="line">              &quot;type&quot;:     &quot;string&quot;,</span><br><span class="line">              &quot;analyzer&quot;: &quot;english&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT /my_index/blog/1</span><br><span class="line">&#123; &quot;title&quot;: &quot;I&#x27;m happy for this fox&quot; &#125;</span><br><span class="line"></span><br><span class="line">PUT /my_index/blog/2</span><br><span class="line">&#123; &quot;title&quot;: &quot;I&#x27;m not happy about my fox problem&quot; &#125;</span><br><span class="line"></span><br><span class="line">GET /_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;type&quot;:     &quot;most_fields&quot;,</span><br><span class="line">      &quot;query&quot;:    &quot;not happy foxes&quot;,</span><br><span class="line">      &quot;fields&quot;: [ &quot;title&quot;, &quot;title.english&quot; ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#安装插件</span><br><span class="line">./elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip</span><br><span class="line">#安装插件</span><br><span class="line">bin/elasticsearch install https://github.com/KennFalcon/elasticsearch-analysis-hanlp/releases/download/v7.1.0/elasticsearch-analysis-hanlp-7.1.0.zip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#ik_max_word</span><br><span class="line">#ik_smart</span><br><span class="line">#hanlp: hanlp默认分词</span><br><span class="line">#hanlp_standard: 标准分词</span><br><span class="line">#hanlp_index: 索引分词</span><br><span class="line">#hanlp_nlp: NLP分词</span><br><span class="line">#hanlp_n_short: N-最短路分词</span><br><span class="line">#hanlp_dijkstra: 最短路分词</span><br><span class="line">#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）</span><br><span class="line">#hanlp_speed: 极速词典分词</span><br><span class="line"></span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;hanlp_standard&quot;,</span><br><span class="line">  &quot;text&quot;: [&quot;剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜&quot;]</span><br><span class="line"></span><br><span class="line">&#125;     </span><br><span class="line"></span><br><span class="line">#Pinyin</span><br><span class="line">PUT /artists/</span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot; : &#123;</span><br><span class="line">        &quot;analysis&quot; : &#123;</span><br><span class="line">            &quot;analyzer&quot; : &#123;</span><br><span class="line">                &quot;user_name_analyzer&quot; : &#123;</span><br><span class="line">                    &quot;tokenizer&quot; : &quot;whitespace&quot;,</span><br><span class="line">                    &quot;filter&quot; : &quot;pinyin_first_letter_and_full_pinyin_filter&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;filter&quot; : &#123;</span><br><span class="line">                &quot;pinyin_first_letter_and_full_pinyin_filter&quot; : &#123;</span><br><span class="line">                    &quot;type&quot; : &quot;pinyin&quot;,</span><br><span class="line">                    &quot;keep_first_letter&quot; : true,</span><br><span class="line">                    &quot;keep_full_pinyin&quot; : false,</span><br><span class="line">                    &quot;keep_none_chinese&quot; : true,</span><br><span class="line">                    &quot;keep_original&quot; : false,</span><br><span class="line">                    &quot;limit_first_letter_length&quot; : 16,</span><br><span class="line">                    &quot;lowercase&quot; : true,</span><br><span class="line">                    &quot;trim_whitespace&quot; : true,</span><br><span class="line">                    &quot;keep_none_chinese_in_first_letter&quot; : true</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /artists/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;: [&quot;刘德华 张学友 郭富城 黎明 四大天王&quot;],</span><br><span class="line">  &quot;analyzer&quot;: &quot;user_name_analyzer&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><ul>
<li><p>Elasticsearch IK分词插件 <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>
</li>
<li><p>Elasticsearch hanlp 分词插件 <a target="_blank" rel="noopener" href="https://github.com/KennFalcon/elasticsearch-analysis-hanlp">https://github.com/KennFalcon/elasticsearch-analysis-hanlp</a></p>
</li>
<li><p>分词算法综述 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/50444885">https://zhuanlan.zhihu.com/p/50444885</a></p>
</li>
</ul>
<h3 id="一些分词工具，供参考："><a href="#一些分词工具，供参考：" class="headerlink" title="一些分词工具，供参考："></a>一些分词工具，供参考：</h3><ul>
<li>中科院计算所NLPIR <a target="_blank" rel="noopener" href="http://ictclas.nlpir.org/nlpir/">http://ictclas.nlpir.org/nlpir/</a></li>
<li>ansj分词器 <a target="_blank" rel="noopener" href="https://github.com/NLPchina/ansj_seg">https://github.com/NLPchina/ansj_seg</a></li>
<li>哈工大的LTP <a target="_blank" rel="noopener" href="https://github.com/HIT-SCIR/ltp">https://github.com/HIT-SCIR/ltp</a></li>
<li>清华大学THULAC <a target="_blank" rel="noopener" href="https://github.com/thunlp/THULAC">https://github.com/thunlp/THULAC</a></li>
<li>斯坦福分词器 <a target="_blank" rel="noopener" href="https://nlp.stanford.edu/software/segmenter.shtml">https://nlp.stanford.edu/software/segmenter.shtml</a></li>
<li>Hanlp分词器 <a target="_blank" rel="noopener" href="https://github.com/hankcs/HanLP">https://github.com/hankcs/HanLP</a></li>
<li>结巴分词 <a target="_blank" rel="noopener" href="https://github.com/yanyiwu/cppjieba">https://github.com/yanyiwu/cppjieba</a></li>
<li>KCWS分词器(字嵌入+Bi-LSTM+CRF) <a target="_blank" rel="noopener" href="https://github.com/koth/kcws">https://github.com/koth/kcws</a></li>
<li>ZPar <a target="_blank" rel="noopener" href="https://github.com/frcchang/zpar/releases">https://github.com/frcchang/zpar/releases</a></li>
<li>IKAnalyzer <a target="_blank" rel="noopener" href="https://github.com/wks/ik-analyzer">https://github.com/wks/ik-analyzer</a></li>
</ul>
<h1 id="4-8-SpaceJam一个全文搜索的实例-md"><a href="#4-8-SpaceJam一个全文搜索的实例-md" class="headerlink" title="4.8-SpaceJam一个全文搜索的实例.md"></a>4.8-SpaceJam一个全文搜索的实例.md</h1><h1 id="Space-Jam，一次全文搜索的实例"><a href="#Space-Jam，一次全文搜索的实例" class="headerlink" title="Space Jam，一次全文搜索的实例"></a>Space Jam，一次全文搜索的实例</h1><h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><ul>
<li>Python 2.7.15</li>
<li>可以使用pyenv管理多个python版本（可选）</li>
</ul>
<h2 id="进入-tmdb-search目录"><a href="#进入-tmdb-search目录" class="headerlink" title="进入 tmdb-search目录"></a>进入 tmdb-search目录</h2><p>Run<br>pip install -r requirements.txt<br>Run python .&#x2F;ingest_tmdb_from_file.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">POST tmdb/_search</span><br><span class="line">&#123;</span><br><span class="line">&quot;_source&quot;: [&quot;title&quot;,&quot;overview&quot;],</span><br><span class="line"> &quot;query&quot;: &#123;</span><br><span class="line">   &quot;match_all&quot;: &#123;&#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST tmdb/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_source&quot;: [&quot;title&quot;,&quot;overview&quot;],</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;basketball with cartoon aliens&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;title&quot;,&quot;overview&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot; : &#123;</span><br><span class="line">        &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;overview&quot; : &#123; &quot;pre_tags&quot; : [&quot;\\033[0;32;40m&quot;], &quot;post_tags&quot; : [&quot;\\033[0m&quot;] &#125;,</span><br><span class="line">            &quot;title&quot; : &#123; &quot;pre_tags&quot; : [&quot;\\033[0;32;40m&quot;], &quot;post_tags&quot; : [&quot;\\033[0m&quot;] &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="相关"><a href="#相关" class="headerlink" title="相关"></a>相关</h2><ul>
<li>Windows 安装 pyenv <a target="_blank" rel="noopener" href="https://github.com/pyenv-win/pyenv-win">https://github.com/pyenv-win/pyenv-win</a></li>
<li>Mac 安装pyenv <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000017403221">https://segmentfault.com/a/1190000017403221</a></li>
<li>Linux 安装 pyenv <a target="_blank" rel="noopener" href="https://blog.csdn.net/GX_1_11_real/article/details/80237064">https://blog.csdn.net/GX_1_11_real/article/details/80237064</a></li>
<li>Python.org <a target="_blank" rel="noopener" href="https://www.python.org/">https://www.python.org/</a></li>
</ul>
<h1 id="4-9-使用SearchTemplate和IndexAlias进行查询-md"><a href="#4-9-使用SearchTemplate和IndexAlias进行查询-md" class="headerlink" title="4.9-使用SearchTemplate和IndexAlias进行查询.md"></a>4.9-使用SearchTemplate和IndexAlias进行查询.md</h1><h1 id="使用-Search-Template-和-Index-Alias-查询"><a href="#使用-Search-Template-和-Index-Alias-查询" class="headerlink" title="使用 Search Template 和 Index Alias 查询"></a>使用 Search Template 和 Index Alias 查询</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">POST _scripts/tmdb</span><br><span class="line">&#123;</span><br><span class="line">  &quot;script&quot;: &#123;</span><br><span class="line">    &quot;lang&quot;: &quot;mustache&quot;,</span><br><span class="line">    &quot;source&quot;: &#123;</span><br><span class="line">      &quot;_source&quot;: [</span><br><span class="line">        &quot;title&quot;,&quot;overview&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;size&quot;: 20,</span><br><span class="line">      &quot;query&quot;: &#123;</span><br><span class="line">        &quot;multi_match&quot;: &#123;</span><br><span class="line">          &quot;query&quot;: &quot;&#123;&#123;q&#125;&#125;&quot;,</span><br><span class="line">          &quot;fields&quot;: [&quot;title&quot;,&quot;overview&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">DELETE _scripts/tmdb</span><br><span class="line"></span><br><span class="line">GET _scripts/tmdb</span><br><span class="line"></span><br><span class="line">POST tmdb/_search/template</span><br><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;:&quot;tmdb&quot;,</span><br><span class="line">    &quot;params&quot;: &#123;</span><br><span class="line">        &quot;q&quot;: &quot;basketball with cartoon aliens&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT movies-2019/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;the matrix&quot;,</span><br><span class="line">  &quot;rating&quot;:5</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT movies-2019/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;:&quot;Speed&quot;,</span><br><span class="line">  &quot;rating&quot;:3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;movies-2019&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;movies-latest&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST movies-latest/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST _aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;movies-2019&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;movies-lastest-highrate&quot;,</span><br><span class="line">        &quot;filter&quot;: &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;rating&quot;: &#123;</span><br><span class="line">              &quot;gte&quot;: 4</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST movies-lastest-highrate/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="5-1-集群分布式模型及选主与脑裂问题-md"><a href="#5-1-集群分布式模型及选主与脑裂问题-md" class="headerlink" title="5.1-集群分布式模型及选主与脑裂问题.md"></a>5.1-集群分布式模型及选主与脑裂问题.md</h1><h1 id="集群分布式模型及选主与脑裂问题"><a href="#集群分布式模型及选主与脑裂问题" class="headerlink" title="集群分布式模型及选主与脑裂问题"></a>集群分布式模型及选主与脑裂问题</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data</span><br><span class="line">bin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data</span><br><span class="line">bin/elasticsearch -E node.name=node3 -E cluster.name=geektime -E path.data=node3_data</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="5-2-分片与集群的故障转移-md"><a href="#5-2-分片与集群的故障转移-md" class="headerlink" title="5.2-分片与集群的故障转移.md"></a>5.2-分片与集群的故障转移.md</h1><h1 id="分片与集群的故障转移"><a href="#分片与集群的故障转移" class="headerlink" title="分片与集群的故障转移"></a>分片与集群的故障转移</h1><h1 id="5-3-文档分布式存储-md"><a href="#5-3-文档分布式存储-md" class="headerlink" title="5.3-文档分布式存储.md"></a>5.3-文档分布式存储.md</h1><h1 id="文档分布式存储"><a href="#文档分布式存储" class="headerlink" title="文档分布式存储"></a>文档分布式存储</h1><h1 id="5-4-分片及其生命周期-md"><a href="#5-4-分片及其生命周期-md" class="headerlink" title="5.4-分片及其生命周期.md"></a>5.4-分片及其生命周期.md</h1><h1 id="分片及其生命周期"><a href="#分片及其生命周期" class="headerlink" title="分片及其生命周期"></a>分片及其生命周期</h1><h1 id="5-5-剖析分布式查询及相关性评分-md"><a href="#5-5-剖析分布式查询及相关性评分-md" class="headerlink" title="5.5-剖析分布式查询及相关性评分.md"></a>5.5-剖析分布式查询及相关性评分.md</h1><h1 id="剖析分布式查询及相关性评分"><a href="#剖析分布式查询及相关性评分" class="headerlink" title="剖析分布式查询及相关性评分"></a>剖析分布式查询及相关性评分</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">DELETE message</span><br><span class="line">PUT message</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 20</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET message</span><br><span class="line"></span><br><span class="line">POST message/_doc?routing=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;:&quot;good&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST message/_doc?routing=2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;:&quot;good morning&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST message/_doc?routing=3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;:&quot;good morning everyone&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST message/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST message/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;explain&quot;: true,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;good&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST message/_search?search_type=dfs_query_then_fetch</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;good&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="5-6-排序及DocValues-Fielddata-md"><a href="#5-6-排序及DocValues-Fielddata-md" class="headerlink" title="5.6-排序及DocValues&amp;Fielddata.md"></a>5.6-排序及DocValues&amp;Fielddata.md</h1><h1 id="排序及Doc-Values-Fielddata"><a href="#排序及Doc-Values-Fielddata" class="headerlink" title="排序及Doc Values &amp; Fielddata"></a>排序及Doc Values &amp; Fielddata</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">#单字段排序</span><br><span class="line">POST /kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 5,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;&quot;order_date&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#多字段排序</span><br><span class="line">POST /kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 5,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;&quot;order_date&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;,</span><br><span class="line">    &#123;&quot;_doc&quot;:&#123;&quot;order&quot;: &quot;asc&quot;&#125;&#125;,</span><br><span class="line">    &#123;&quot;_score&quot;:&#123; &quot;order&quot;: &quot;desc&quot;&#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET kibana_sample_data_ecommerce/_mapping</span><br><span class="line"></span><br><span class="line">#对 text 字段进行排序。默认会报错，需打开fielddata</span><br><span class="line">POST /kibana_sample_data_ecommerce/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 5,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;&quot;customer_full_name&quot;: &#123;&quot;order&quot;: &quot;desc&quot;&#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#打开 text的 fielddata</span><br><span class="line">PUT kibana_sample_data_ecommerce/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;customer_full_name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fielddata&quot;: true,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#关闭 keyword的 doc values</span><br><span class="line">PUT test_keyword</span><br><span class="line">PUT test_keyword/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;user_name&quot;:&#123;</span><br><span class="line">      &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">      &quot;doc_values&quot;:false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE test_keyword</span><br><span class="line"></span><br><span class="line">PUT test_text</span><br><span class="line">PUT test_text/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;intro&quot;:&#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;doc_values&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE test_text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE temp_users</span><br><span class="line">PUT temp_users</span><br><span class="line">PUT temp_users/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;name&quot;:&#123;&quot;type&quot;: &quot;text&quot;,&quot;fielddata&quot;: true&#125;,</span><br><span class="line">    &quot;desc&quot;:&#123;&quot;type&quot;: &quot;text&quot;,&quot;fielddata&quot;: true&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Post temp_users/_doc</span><br><span class="line">&#123;&quot;name&quot;:&quot;Jack&quot;,&quot;desc&quot;:&quot;Jack is a good boy!&quot;,&quot;age&quot;:10&#125;</span><br><span class="line"></span><br><span class="line">#打开fielddata 后，查看 docvalue_fields数据</span><br><span class="line">POST  temp_users/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docvalue_fields&quot;: [</span><br><span class="line">    &quot;name&quot;,&quot;desc&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#查看整型字段的docvalues</span><br><span class="line">POST  temp_users/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;docvalue_fields&quot;: [</span><br><span class="line">    &quot;age&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="5-7-分页与遍历-FromSize-SearchAfter-ScrollAPI-md"><a href="#5-7-分页与遍历-FromSize-SearchAfter-ScrollAPI-md" class="headerlink" title="5.7-分页与遍历-FromSize&amp;SearchAfter&amp;ScrollAPI.md"></a>5.7-分页与遍历-FromSize&amp;SearchAfter&amp;ScrollAPI.md</h1><h1 id="分页与遍历-From-Size-Search-after-Scroll-API"><a href="#分页与遍历-From-Size-Search-after-Scroll-API" class="headerlink" title="分页与遍历 - From, Size, Search_after &amp; Scroll API"></a>分页与遍历 - From, Size, Search_after &amp; Scroll API</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">POST tmdb/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;from&quot;: 10000,</span><br><span class="line">  &quot;size&quot;: 1,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#Scroll API</span><br><span class="line">DELETE users</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;&quot;name&quot;:&quot;user1&quot;,&quot;age&quot;:10&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:11&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:12&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:13&#125;</span><br><span class="line"></span><br><span class="line">POST users/_count</span><br><span class="line"></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 1,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot;: [</span><br><span class="line">        &#123;&quot;age&quot;: &quot;desc&quot;&#125; ,</span><br><span class="line">        &#123;&quot;_id&quot;: &quot;asc&quot;&#125;    </span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST users/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 1,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;search_after&quot;:</span><br><span class="line">        [</span><br><span class="line">          10,</span><br><span class="line">          &quot;ZQ0vYGsBrR8X3IP75QqX&quot;],</span><br><span class="line">    &quot;sort&quot;: [</span><br><span class="line">        &#123;&quot;age&quot;: &quot;desc&quot;&#125; ,</span><br><span class="line">        &#123;&quot;_id&quot;: &quot;asc&quot;&#125;    </span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Scroll API</span><br><span class="line">DELETE users</span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;&quot;name&quot;:&quot;user1&quot;,&quot;age&quot;:10&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;&quot;name&quot;:&quot;user2&quot;,&quot;age&quot;:20&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;&quot;name&quot;:&quot;user3&quot;,&quot;age&quot;:30&#125;</span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;&quot;name&quot;:&quot;user4&quot;,&quot;age&quot;:40&#125;</span><br><span class="line"></span><br><span class="line">POST /users/_search?scroll=5m</span><br><span class="line">&#123;</span><br><span class="line">    &quot;size&quot;: 1,</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_all&quot; : &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST users/_doc</span><br><span class="line">&#123;&quot;name&quot;:&quot;user5&quot;,&quot;age&quot;:50&#125;</span><br><span class="line">POST /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">    &quot;scroll&quot; : &quot;1m&quot;,</span><br><span class="line">    &quot;scroll_id&quot; : &quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAWAWbWdoQXR2d3ZUd2kzSThwVTh4bVE0QQ==&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="5-8-处理并发读写-md"><a href="#5-8-处理并发读写-md" class="headerlink" title="5.8-处理并发读写.md"></a>5.8-处理并发读写.md</h1><h1 id="处理并发读写操作"><a href="#处理并发读写操作" class="headerlink" title="处理并发读写操作"></a>处理并发读写操作</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">DELETE products</span><br><span class="line">PUT products</span><br><span class="line"></span><br><span class="line">PUT products/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;iphone&quot;,</span><br><span class="line">  &quot;count&quot;:100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET products/_doc/1</span><br><span class="line"></span><br><span class="line">PUT products/_doc/1?if_seq_no=1&amp;if_primary_term=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;iphone&quot;,</span><br><span class="line">  &quot;count&quot;:100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT products/_doc/1?version=30000&amp;version_type=external</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;iphone&quot;,</span><br><span class="line">  &quot;count&quot;:100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="6-1-Bucket-Metric聚合分析及嵌套聚合-md"><a href="#6-1-Bucket-Metric聚合分析及嵌套聚合-md" class="headerlink" title="6.1-Bucket&amp;Metric聚合分析及嵌套聚合.md"></a>6.1-Bucket&amp;Metric聚合分析及嵌套聚合.md</h1><h1 id="Bucket-Metric-Aggregation"><a href="#Bucket-Metric-Aggregation" class="headerlink" title="Bucket &amp; Metric Aggregation"></a>Bucket &amp; Metric Aggregation</h1><h2 id="demos"><a href="#demos" class="headerlink" title="demos"></a>demos</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br></pre></td><td class="code"><pre><span class="line">DELETE /employees</span><br><span class="line">PUT /employees/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;age&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;gender&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;job&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 50</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;salary&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;integer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /employees/_bulk</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Emma&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Product Manager&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:35000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Underwood&quot;,&quot;age&quot;:41,&quot;job&quot;:&quot;Dev Manager&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 50000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Tran&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;4&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Rivera&quot;,&quot;age&quot;:26,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 22000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;5&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Rose&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;6&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Lucy&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;7&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Byrd&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:20000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;8&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Foster&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;9&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Gregory&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:22000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;10&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Bryant&quot;,&quot;age&quot;:20,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 9000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;11&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Jenny&quot;,&quot;age&quot;:36,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:38000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;12&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Mcdonald&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 32000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;13&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Jonthna&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:30000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;14&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Marshall&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;15&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;King&quot;,&quot;age&quot;:33,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:28000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;16&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Mccarthy&quot;,&quot;age&quot;:21,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;17&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Goodwin&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;18&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Catherine&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;19&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Boone&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 30000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;20&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Kathy&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class="line"></span><br><span class="line"># Metric 聚合，找到最低的工资</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;min_salary&quot;: &#123;</span><br><span class="line">      &quot;min&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Metric 聚合，找到最高的工资</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;max_salary&quot;: &#123;</span><br><span class="line">      &quot;max&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 多个 Metric 聚合，找到最低最高和平均工资</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;max_salary&quot;: &#123;</span><br><span class="line">      &quot;max&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;min_salary&quot;: &#123;</span><br><span class="line">      &quot;min&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;avg_salary&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 一个聚合，输出多值</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;stats_salary&quot;: &#123;</span><br><span class="line">      &quot;stats&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 对keword 进行聚合</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 对 Text 字段进行 terms 聚合查询，失败</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 对 Text 字段打开 fielddata，支持terms aggregation</span><br><span class="line">PUT employees/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot; : &#123;</span><br><span class="line">    &quot;job&quot;:&#123;</span><br><span class="line">       &quot;type&quot;:     &quot;text&quot;,</span><br><span class="line">       &quot;fielddata&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 对 Text 字段进行 terms 分词。分词后的terms</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;cardinate&quot;: &#123;</span><br><span class="line">      &quot;cardinality&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;job&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 对 性别的 keyword 进行聚合</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;gender&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;gender&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#指定 bucket 的 size</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;ages_5&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;age&quot;,</span><br><span class="line">        &quot;size&quot;:3</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 指定size，不同工种中，年纪最大的3个员工的具体信息</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;:&#123;</span><br><span class="line">        &quot;old_employee&quot;:&#123;</span><br><span class="line">          &quot;top_hits&quot;:&#123;</span><br><span class="line">            &quot;size&quot;:3,</span><br><span class="line">            &quot;sort&quot;:[</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;age&quot;:&#123;</span><br><span class="line">                  &quot;order&quot;:&quot;desc&quot;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Salary Ranges 分桶，可以自己定义 key</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;salary_range&quot;: &#123;</span><br><span class="line">      &quot;range&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;salary&quot;,</span><br><span class="line">        &quot;ranges&quot;:[</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;to&quot;:10000</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;:10000,</span><br><span class="line">            &quot;to&quot;:20000</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;key&quot;:&quot;&gt;20000&quot;,</span><br><span class="line">            &quot;from&quot;:20000</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Salary Histogram,工资0到10万，以 5000一个区间进行分桶</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;salary_histrogram&quot;: &#123;</span><br><span class="line">      &quot;histogram&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;salary&quot;,</span><br><span class="line">        &quot;interval&quot;:5000,</span><br><span class="line">        &quot;extended_bounds&quot;:&#123;</span><br><span class="line">          &quot;min&quot;:0,</span><br><span class="line">          &quot;max&quot;:100000</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 嵌套聚合1，按照工作类型分桶，并统计工资信息</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;Job_salary_stats&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;job.keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;salary&quot;: &#123;</span><br><span class="line">          &quot;stats&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;Job_gender_stats&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;job.keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;gender_stats&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;gender&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;salary_stats&quot;: &#123;</span><br><span class="line">              &quot;stats&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="6-2-Pipeline聚合分析-md"><a href="#6-2-Pipeline聚合分析-md" class="headerlink" title="6.2-Pipeline聚合分析.md"></a>6.2-Pipeline聚合分析.md</h1><h1 id="Pipeline-聚合分析"><a href="#Pipeline-聚合分析" class="headerlink" title="Pipeline 聚合分析"></a>Pipeline 聚合分析</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><span class="line">DELETE employees</span><br><span class="line">PUT /employees/_bulk</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Emma&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Product Manager&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:35000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Underwood&quot;,&quot;age&quot;:41,&quot;job&quot;:&quot;Dev Manager&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 50000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Tran&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;4&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Rivera&quot;,&quot;age&quot;:26,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 22000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;5&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Rose&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;6&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Lucy&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;7&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Byrd&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:20000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;8&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Foster&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;9&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Gregory&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:22000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;10&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Bryant&quot;,&quot;age&quot;:20,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 9000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;11&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Jenny&quot;,&quot;age&quot;:36,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:38000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;12&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Mcdonald&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 32000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;13&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Jonthna&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:30000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;14&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Marshall&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;15&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;King&quot;,&quot;age&quot;:33,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:28000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;16&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Mccarthy&quot;,&quot;age&quot;:21,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;17&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Goodwin&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;18&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Catherine&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;19&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Boone&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 30000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;20&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Kathy&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 平均工资最低的工作类型</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_salary&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;min_salary_by_job&quot;:&#123;</span><br><span class="line">      &quot;min_bucket&quot;: &#123;</span><br><span class="line">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 平均工资最高的工作类型</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_salary&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_salary_by_job&quot;:&#123;</span><br><span class="line">      &quot;max_bucket&quot;: &#123;</span><br><span class="line">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 平均工资的平均工资</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_salary&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;avg_salary_by_job&quot;:&#123;</span><br><span class="line">      &quot;avg_bucket&quot;: &#123;</span><br><span class="line">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 平均工资的统计分析</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_salary&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;stats_salary_by_job&quot;:&#123;</span><br><span class="line">      &quot;stats_bucket&quot;: &#123;</span><br><span class="line">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 平均工资的百分位数</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;job.keyword&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_salary&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;percentiles_salary_by_job&quot;:&#123;</span><br><span class="line">      &quot;percentiles_bucket&quot;: &#123;</span><br><span class="line">        &quot;buckets_path&quot;: &quot;jobs&gt;avg_salary&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#按照年龄对平均工资求导</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age&quot;: &#123;</span><br><span class="line">      &quot;histogram&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;min_doc_count&quot;: 1,</span><br><span class="line">        &quot;interval&quot;: 1</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_salary&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;derivative_avg_salary&quot;:&#123;</span><br><span class="line">          &quot;derivative&quot;: &#123;</span><br><span class="line">            &quot;buckets_path&quot;: &quot;avg_salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Cumulative_sum</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age&quot;: &#123;</span><br><span class="line">      &quot;histogram&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;min_doc_count&quot;: 1,</span><br><span class="line">        &quot;interval&quot;: 1</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_salary&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;cumulative_salary&quot;:&#123;</span><br><span class="line">          &quot;cumulative_sum&quot;: &#123;</span><br><span class="line">            &quot;buckets_path&quot;: &quot;avg_salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#Moving Function</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;age&quot;: &#123;</span><br><span class="line">      &quot;histogram&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;min_doc_count&quot;: 1,</span><br><span class="line">        &quot;interval&quot;: 1</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;avg_salary&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;moving_avg_salary&quot;:&#123;</span><br><span class="line">          &quot;moving_fn&quot;: &#123;</span><br><span class="line">            &quot;buckets_path&quot;: &quot;avg_salary&quot;,</span><br><span class="line">            &quot;window&quot;:10,</span><br><span class="line">            &quot;script&quot;: &quot;MovingFunctions.min(values)&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="6-3-作用范围与排序-md"><a href="#6-3-作用范围与排序-md" class="headerlink" title="6.3-作用范围与排序.md"></a>6.3-作用范围与排序.md</h1><h1 id="作用范围与排序"><a href="#作用范围与排序" class="headerlink" title="作用范围与排序"></a>作用范围与排序</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line">DELETE /employees</span><br><span class="line">PUT /employees/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;age&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;gender&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;job&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 50</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;name&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;salary&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;integer&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /employees/_bulk</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Emma&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Product Manager&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:35000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Underwood&quot;,&quot;age&quot;:41,&quot;job&quot;:&quot;Dev Manager&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 50000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Tran&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;4&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Rivera&quot;,&quot;age&quot;:26,&quot;job&quot;:&quot;Web Designer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 22000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;5&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Rose&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:18000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;6&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Lucy&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;7&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Byrd&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;QA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:20000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;8&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Foster&quot;,&quot;age&quot;:27,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;9&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Gregory&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:22000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;10&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Bryant&quot;,&quot;age&quot;:20,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 9000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;11&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Jenny&quot;,&quot;age&quot;:36,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:38000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;12&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Mcdonald&quot;,&quot;age&quot;:31,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 32000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;13&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Jonthna&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;:30000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;14&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Marshall&quot;,&quot;age&quot;:32,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 25000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;15&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;King&quot;,&quot;age&quot;:33,&quot;job&quot;:&quot;Java Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;:28000 &#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;16&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Mccarthy&quot;,&quot;age&quot;:21,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;17&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Goodwin&quot;,&quot;age&quot;:25,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 16000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;18&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Catherine&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;Javascript Programmer&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;19&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Boone&quot;,&quot;age&quot;:30,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;male&quot;,&quot;salary&quot;: 30000&#125;</span><br><span class="line">&#123; &quot;index&quot; : &#123;  &quot;_id&quot; : &quot;20&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;name&quot; : &quot;Kathy&quot;,&quot;age&quot;:29,&quot;job&quot;:&quot;DBA&quot;,&quot;gender&quot;:&quot;female&quot;,&quot;salary&quot;: 20000&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Query</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 20</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Filter</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;older_person&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;:&#123;</span><br><span class="line">        &quot;range&quot;:&#123;</span><br><span class="line">          &quot;age&quot;:&#123;</span><br><span class="line">            &quot;from&quot;:35</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;:&#123;</span><br><span class="line">         &quot;jobs&quot;:&#123;</span><br><span class="line">           &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class="line">      &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;&#125;,</span><br><span class="line">    &quot;all_jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Post field. 一条语句，找出所有的job类型。还能找到聚合后符合条件的结果</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;job.keyword&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;post_filter&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;job.keyword&quot;: &quot;Dev Manager&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#global</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 40</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job.keyword&quot;</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    &quot;all&quot;:&#123;</span><br><span class="line">      &quot;global&quot;:&#123;&#125;,</span><br><span class="line">      &quot;aggs&quot;:&#123;</span><br><span class="line">        &quot;salary_avg&quot;:&#123;</span><br><span class="line">          &quot;avg&quot;:&#123;</span><br><span class="line">            &quot;field&quot;:&quot;salary&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#排序 order</span><br><span class="line">#count and key</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: 20</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job.keyword&quot;,</span><br><span class="line">        &quot;order&quot;:[</span><br><span class="line">          &#123;&quot;_count&quot;:&quot;asc&quot;&#125;,</span><br><span class="line">          &#123;&quot;_key&quot;:&quot;desc&quot;&#125;</span><br><span class="line">          ]</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#排序 order</span><br><span class="line">#count and key</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job.keyword&quot;,</span><br><span class="line">        &quot;order&quot;:[  &#123;</span><br><span class="line">            &quot;avg_salary&quot;:&quot;desc&quot;</span><br><span class="line">          &#125;]</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">      &#125;,</span><br><span class="line">    &quot;aggs&quot;: &#123;</span><br><span class="line">      &quot;avg_salary&quot;: &#123;</span><br><span class="line">        &quot;avg&quot;: &#123;</span><br><span class="line">          &quot;field&quot;:&quot;salary&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#排序 order</span><br><span class="line">#count and key</span><br><span class="line">POST employees/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;jobs&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;job.keyword&quot;,</span><br><span class="line">        &quot;order&quot;:[  &#123;</span><br><span class="line">            &quot;stats_salary.min&quot;:&quot;desc&quot;</span><br><span class="line">          &#125;]</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">      &#125;,</span><br><span class="line">    &quot;aggs&quot;: &#123;</span><br><span class="line">      &quot;stats_salary&quot;: &#123;</span><br><span class="line">        &quot;stats&quot;: &#123;</span><br><span class="line">          &quot;field&quot;:&quot;salary&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="6-4-聚合分析的原理及精准度问题-md"><a href="#6-4-聚合分析的原理及精准度问题-md" class="headerlink" title="6.4-聚合分析的原理及精准度问题.md"></a>6.4-聚合分析的原理及精准度问题.md</h1><h1 id="聚合分析的原理及精准度问题"><a href="#聚合分析的原理及精准度问题" class="headerlink" title="聚合分析的原理及精准度问题"></a>聚合分析的原理及精准度问题</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_flights</span><br><span class="line">PUT my_flights</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 20</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;AvgTicketPrice&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;float&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Cancelled&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;boolean&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Carrier&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Dest&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DestAirportID&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DestCityName&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DestCountry&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DestLocation&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;geo_point&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DestRegion&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DestWeather&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DistanceKilometers&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;float&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;DistanceMiles&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;float&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;FlightDelay&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;boolean&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;FlightDelayMin&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;FlightDelayType&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;FlightNum&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;FlightTimeHour&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;FlightTimeMin&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;float&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Origin&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;OriginAirportID&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;OriginCityName&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;OriginCountry&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;OriginLocation&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;geo_point&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;OriginRegion&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;OriginWeather&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;dayOfWeek&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;integer&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;timestamp&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;date&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;kibana_sample_data_flights&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;my_flights&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET kibana_sample_data_flights/_count</span><br><span class="line">GET my_flights/_count</span><br><span class="line"></span><br><span class="line">get kibana_sample_data_flights/_search</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET kibana_sample_data_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;weather&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;OriginWeather&quot;,</span><br><span class="line">        &quot;size&quot;:5,</span><br><span class="line">        &quot;show_term_doc_count_error&quot;:true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_flights/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;weather&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;:&quot;OriginWeather&quot;,</span><br><span class="line">        &quot;size&quot;:1,</span><br><span class="line">        &quot;shard_size&quot;:1,</span><br><span class="line">        &quot;show_term_doc_count_error&quot;:true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="7-1-对象及-Nested-对象-md"><a href="#7-1-对象及-Nested-对象-md" class="headerlink" title="7.1-对象及 Nested 对象.md"></a>7.1-对象及 Nested 对象.md</h1><h1 id="对象及Nested对象"><a href="#对象及Nested对象" class="headerlink" title="对象及Nested对象"></a>对象及Nested对象</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line">DELETE blog</span><br><span class="line"># 设置blog的 Mapping</span><br><span class="line">PUT /blog</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;time&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;date&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;user&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;city&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;userid&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;username&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 插入一条 Blog 信息</span><br><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;:&quot;I like Elasticsearch&quot;,</span><br><span class="line">  &quot;time&quot;:&quot;2019-01-01T00:00:00&quot;,</span><br><span class="line">  &quot;user&quot;:&#123;</span><br><span class="line">    &quot;userid&quot;:1,</span><br><span class="line">    &quot;username&quot;:&quot;Jack&quot;,</span><br><span class="line">    &quot;city&quot;:&quot;Shanghai&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查询 Blog 信息</span><br><span class="line">POST blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;&quot;content&quot;: &quot;Elasticsearch&quot;&#125;&#125;,</span><br><span class="line">        &#123;&quot;match&quot;: &#123;&quot;user.username&quot;: &quot;Jack&quot;&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE my_movies</span><br><span class="line"></span><br><span class="line"># 电影的Mapping信息</span><br><span class="line">PUT my_movies</span><br><span class="line">&#123;</span><br><span class="line">      &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;actors&quot; : &#123;</span><br><span class="line">          &quot;properties&quot; : &#123;</span><br><span class="line">            &quot;first_name&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;last_name&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;title&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 256</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 写入一条电影信息</span><br><span class="line">POST my_movies/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;Speed&quot;,</span><br><span class="line">  &quot;actors&quot;:[</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;first_name&quot;:&quot;Keanu&quot;,</span><br><span class="line">      &quot;last_name&quot;:&quot;Reeves&quot;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      &quot;first_name&quot;:&quot;Dennis&quot;,</span><br><span class="line">      &quot;last_name&quot;:&quot;Hopper&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 查询电影信息</span><br><span class="line">POST my_movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;&quot;actors.first_name&quot;: &quot;Keanu&quot;&#125;&#125;,</span><br><span class="line">        &#123;&quot;match&quot;: &#123;&quot;actors.last_name&quot;: &quot;Hopper&quot;&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE my_movies</span><br><span class="line"># 创建 Nested 对象 Mapping</span><br><span class="line">PUT my_movies</span><br><span class="line">&#123;</span><br><span class="line">      &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;actors&quot; : &#123;</span><br><span class="line">          &quot;type&quot;: &quot;nested&quot;,</span><br><span class="line">          &quot;properties&quot; : &#123;</span><br><span class="line">            &quot;first_name&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;&#125;,</span><br><span class="line">            &quot;last_name&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;&#125;</span><br><span class="line">          &#125;&#125;,</span><br><span class="line">        &quot;title&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;&quot;keyword&quot;:&#123;&quot;type&quot;:&quot;keyword&quot;,&quot;ignore_above&quot;:256&#125;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST my_movies/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;Speed&quot;,</span><br><span class="line">  &quot;actors&quot;:[</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;first_name&quot;:&quot;Keanu&quot;,</span><br><span class="line">      &quot;last_name&quot;:&quot;Reeves&quot;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">      &quot;first_name&quot;:&quot;Dennis&quot;,</span><br><span class="line">      &quot;last_name&quot;:&quot;Hopper&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Nested 查询</span><br><span class="line">POST my_movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;&quot;title&quot;: &quot;Speed&quot;&#125;&#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;nested&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;actors&quot;,</span><br><span class="line">            &quot;query&quot;: &#123;</span><br><span class="line">              &quot;bool&quot;: &#123;</span><br><span class="line">                &quot;must&quot;: [</span><br><span class="line">                  &#123;&quot;match&quot;: &#123;</span><br><span class="line">                    &quot;actors.first_name&quot;: &quot;Keanu&quot;</span><br><span class="line">                  &#125;&#125;,</span><br><span class="line"></span><br><span class="line">                  &#123;&quot;match&quot;: &#123;</span><br><span class="line">                    &quot;actors.last_name&quot;: &quot;Hopper&quot;</span><br><span class="line">                  &#125;&#125;</span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Nested Aggregation</span><br><span class="line">POST my_movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;actors&quot;: &#123;</span><br><span class="line">      &quot;nested&quot;: &#123;</span><br><span class="line">        &quot;path&quot;: &quot;actors&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;actor_name&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;actors.first_name&quot;,</span><br><span class="line">            &quot;size&quot;: 10</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 普通 aggregation不工作</span><br><span class="line">POST my_movies/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;NAME&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;actors.first_name&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="7-2-文档的父子关系-md"><a href="#7-2-文档的父子关系-md" class="headerlink" title="7.2-文档的父子关系.md"></a>7.2-文档的父子关系.md</h1><h1 id="文档的父子关系"><a href="#文档的父子关系" class="headerlink" title="文档的父子关系"></a>文档的父子关系</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_blogs</span><br><span class="line"></span><br><span class="line"># 设定 Parent/Child Mapping</span><br><span class="line">PUT my_blogs</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 2</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;blog_comments_relation&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;join&quot;,</span><br><span class="line">        &quot;relations&quot;: &#123;</span><br><span class="line">          &quot;blog&quot;: &quot;comment&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;title&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#索引父文档</span><br><span class="line">PUT my_blogs/_doc/blog1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;Learning Elasticsearch&quot;,</span><br><span class="line">  &quot;content&quot;:&quot;learning ELK @ geektime&quot;,</span><br><span class="line">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class="line">    &quot;name&quot;:&quot;blog&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#索引父文档</span><br><span class="line">PUT my_blogs/_doc/blog2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;Learning Hadoop&quot;,</span><br><span class="line">  &quot;content&quot;:&quot;learning Hadoop&quot;,</span><br><span class="line">    &quot;blog_comments_relation&quot;:&#123;</span><br><span class="line">    &quot;name&quot;:&quot;blog&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#索引子文档</span><br><span class="line">PUT my_blogs/_doc/comment1?routing=blog1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;comment&quot;:&quot;I am learning ELK&quot;,</span><br><span class="line">  &quot;username&quot;:&quot;Jack&quot;,</span><br><span class="line">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class="line">    &quot;name&quot;:&quot;comment&quot;,</span><br><span class="line">    &quot;parent&quot;:&quot;blog1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#索引子文档</span><br><span class="line">PUT my_blogs/_doc/comment2?routing=blog2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;comment&quot;:&quot;I like Hadoop!!!!!&quot;,</span><br><span class="line">  &quot;username&quot;:&quot;Jack&quot;,</span><br><span class="line">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class="line">    &quot;name&quot;:&quot;comment&quot;,</span><br><span class="line">    &quot;parent&quot;:&quot;blog2&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#索引子文档</span><br><span class="line">PUT my_blogs/_doc/comment3?routing=blog2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;comment&quot;:&quot;Hello Hadoop&quot;,</span><br><span class="line">  &quot;username&quot;:&quot;Bob&quot;,</span><br><span class="line">  &quot;blog_comments_relation&quot;:&#123;</span><br><span class="line">    &quot;name&quot;:&quot;comment&quot;,</span><br><span class="line">    &quot;parent&quot;:&quot;blog2&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 查询所有文档</span><br><span class="line">POST my_blogs/_search</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#根据父文档ID查看</span><br><span class="line">GET my_blogs/_doc/blog2</span><br><span class="line"></span><br><span class="line"># Parent Id 查询</span><br><span class="line">POST my_blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;parent_id&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;comment&quot;,</span><br><span class="line">      &quot;id&quot;: &quot;blog2&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Has Child 查询,返回父文档</span><br><span class="line">POST my_blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;has_child&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;comment&quot;,</span><br><span class="line">      &quot;query&quot; : &#123;</span><br><span class="line">                &quot;match&quot;: &#123;</span><br><span class="line">                    &quot;username&quot; : &quot;Jack&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Has Parent 查询，返回相关的子文档</span><br><span class="line">POST my_blogs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;has_parent&quot;: &#123;</span><br><span class="line">      &quot;parent_type&quot;: &quot;blog&quot;,</span><br><span class="line">      &quot;query&quot; : &#123;</span><br><span class="line">                &quot;match&quot;: &#123;</span><br><span class="line">                    &quot;title&quot; : &quot;Learning Hadoop&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#通过ID ，访问子文档</span><br><span class="line">GET my_blogs/_doc/comment3</span><br><span class="line">#通过ID和routing ，访问子文档</span><br><span class="line">GET my_blogs/_doc/comment3?routing=blog2</span><br><span class="line"></span><br><span class="line">#更新子文档</span><br><span class="line">PUT my_blogs/_doc/comment3?routing=blog2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;comment&quot;: &quot;Hello Hadoop??&quot;,</span><br><span class="line">    &quot;blog_comments_relation&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;comment&quot;,</span><br><span class="line">      &quot;parent&quot;: &quot;blog2&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="7-5-Elasticsearch数据建模实例-md"><a href="#7-5-Elasticsearch数据建模实例-md" class="headerlink" title="7.5-Elasticsearch数据建模实例.md"></a>7.5-Elasticsearch数据建模实例.md</h1><h1 id="Elasticsearch-数据建模实例"><a href="#Elasticsearch-数据建模实例" class="headerlink" title="Elasticsearch 数据建模实例"></a>Elasticsearch 数据建模实例</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">###### Data Modeling Example</span><br><span class="line"></span><br><span class="line"># Index 一本书的信息</span><br><span class="line">PUT books/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;Mastering ElasticSearch 5.0&quot;,</span><br><span class="line">  &quot;description&quot;:&quot;Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins&quot;,</span><br><span class="line">  &quot;author&quot;:&quot;Bharvi Dixit&quot;,</span><br><span class="line">  &quot;public_date&quot;:&quot;2017&quot;,</span><br><span class="line">  &quot;cover_url&quot;:&quot;https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#查询自动创建的Mapping</span><br><span class="line">GET books/_mapping</span><br><span class="line"></span><br><span class="line">DELETE books</span><br><span class="line"></span><br><span class="line">#优化字段类型</span><br><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">      &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;author&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;&#125;,</span><br><span class="line">        &quot;cover_url&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;,&quot;index&quot;: false&#125;,</span><br><span class="line">        &quot;description&quot; : &#123;&quot;type&quot; : &quot;text&quot;&#125;,</span><br><span class="line">        &quot;public_date&quot; : &#123;&quot;type&quot; : &quot;date&quot;&#125;,</span><br><span class="line">        &quot;title&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 100</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#Cover URL index 设置成false，无法对该字段进行搜索</span><br><span class="line">POST books/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;cover_url&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#Cover URL index 设置成false，依然支持聚合分析</span><br><span class="line">POST books/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;cover&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;cover_url&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE books</span><br><span class="line">#新增 Content字段。数据量很大。选择将Source 关闭</span><br><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">      &quot;mappings&quot; : &#123;</span><br><span class="line">      &quot;_source&quot;: &#123;&quot;enabled&quot;: false&#125;,</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;author&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;,&quot;store&quot;: true&#125;,</span><br><span class="line">        &quot;cover_url&quot; : &#123;&quot;type&quot; : &quot;keyword&quot;,&quot;index&quot;: false,&quot;store&quot;: true&#125;,</span><br><span class="line">        &quot;description&quot; : &#123;&quot;type&quot; : &quot;text&quot;,&quot;store&quot;: true&#125;,</span><br><span class="line">         &quot;content&quot; : &#123;&quot;type&quot; : &quot;text&quot;,&quot;store&quot;: true&#125;,</span><br><span class="line">        &quot;public_date&quot; : &#123;&quot;type&quot; : &quot;date&quot;,&quot;store&quot;: true&#125;,</span><br><span class="line">        &quot;title&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;fields&quot; : &#123;</span><br><span class="line">            &quot;keyword&quot; : &#123;</span><br><span class="line">              &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">              &quot;ignore_above&quot; : 100</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;store&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Index 一本书的信息,包含Content</span><br><span class="line">PUT books/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;title&quot;:&quot;Mastering ElasticSearch 5.0&quot;,</span><br><span class="line">  &quot;description&quot;:&quot;Master the searching, indexing, and aggregation features in ElasticSearch Improve users’ search experience with Elasticsearch’s functionalities and develop your own Elasticsearch plugins&quot;,</span><br><span class="line">  &quot;content&quot;:&quot;The content of the book......Indexing data, aggregation, searching.    something else. something in the way............&quot;,</span><br><span class="line">  &quot;author&quot;:&quot;Bharvi Dixit&quot;,</span><br><span class="line">  &quot;public_date&quot;:&quot;2017&quot;,</span><br><span class="line">  &quot;cover_url&quot;:&quot;https://images-na.ssl-images-amazon.com/images/I/51OeaMFxcML.jpg&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#查询结果中，Source不包含数据</span><br><span class="line">POST books/_search</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">#搜索，通过store 字段显示数据，同时高亮显示 conent的内容</span><br><span class="line">POST books/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;stored_fields&quot;: [&quot;title&quot;,&quot;author&quot;,&quot;public_date&quot;],</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &quot;searching&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;content&quot;:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="7-6-Elasticsearch-数据建模最佳实践-md"><a href="#7-6-Elasticsearch-数据建模最佳实践-md" class="headerlink" title="7.6-Elasticsearch 数据建模最佳实践.md"></a>7.6-Elasticsearch 数据建模最佳实践.md</h1><h1 id="Elasticsearch-数据建模最佳实践"><a href="#Elasticsearch-数据建模最佳实践" class="headerlink" title="Elasticsearch 数据建模最佳实践"></a>Elasticsearch 数据建模最佳实践</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">###### Cookie Service</span><br><span class="line"></span><br><span class="line">##索引数据，dynamic mapping 会不断加入新增字段</span><br><span class="line">PUT cookie_service/_doc/1</span><br><span class="line">&#123;</span><br><span class="line"> &quot;url&quot;:&quot;www.google.com&quot;,</span><br><span class="line"> &quot;cookies&quot;:&#123;</span><br><span class="line">   &quot;username&quot;:&quot;tom&quot;,</span><br><span class="line">   &quot;age&quot;:32</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT cookie_service/_doc/2</span><br><span class="line">&#123;</span><br><span class="line"> &quot;url&quot;:&quot;www.amazon.com&quot;,</span><br><span class="line"> &quot;cookies&quot;:&#123;</span><br><span class="line">   &quot;login&quot;:&quot;2019-01-01&quot;,</span><br><span class="line">   &quot;email&quot;:&quot;xyz@abc.com&quot;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE cookie_service</span><br><span class="line">#使用 Nested 对象，增加key/value</span><br><span class="line">PUT cookie_service</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;cookies&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;nested&quot;,</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;dateValue&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;keywordValue&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;IntValue&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;url&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">            &quot;ignore_above&quot;: 256</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##写入数据，使用key和合适类型的value字段</span><br><span class="line">PUT cookie_service/_doc/1</span><br><span class="line">&#123;</span><br><span class="line"> &quot;url&quot;:&quot;www.google.com&quot;,</span><br><span class="line"> &quot;cookies&quot;:[</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;:&quot;username&quot;,</span><br><span class="line">      &quot;keywordValue&quot;:&quot;tom&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">       &quot;name&quot;:&quot;age&quot;,</span><br><span class="line">      &quot;intValue&quot;:32</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   ]</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT cookie_service/_doc/2</span><br><span class="line">&#123;</span><br><span class="line"> &quot;url&quot;:&quot;www.amazon.com&quot;,</span><br><span class="line"> &quot;cookies&quot;:[</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;:&quot;login&quot;,</span><br><span class="line">      &quot;dateValue&quot;:&quot;2019-01-01&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">       &quot;name&quot;:&quot;email&quot;,</span><br><span class="line">      &quot;IntValue&quot;:32</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   ]</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Nested 查询，通过bool查询进行过滤</span><br><span class="line">POST cookie_service/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;nested&quot;: &#123;</span><br><span class="line">      &quot;path&quot;: &quot;cookies&quot;,</span><br><span class="line">      &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">          &quot;filter&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">            &quot;term&quot;: &#123;</span><br><span class="line">              &quot;cookies.name&quot;: &quot;age&quot;</span><br><span class="line">            &#125;&#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              &quot;range&quot;:&#123;</span><br><span class="line">                &quot;cookies.intValue&quot;:&#123;</span><br><span class="line">                  &quot;gte&quot;:30</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 在Mapping中加入元信息，便于管理</span><br><span class="line">PUT softwares/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_meta&quot;: &#123;</span><br><span class="line">      &quot;software_version_mapping&quot;: &quot;1.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET softwares/_mapping</span><br><span class="line">PUT softwares/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;software_version&quot;:&quot;7.1.0&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DELETE softwares</span><br><span class="line"># 优化,使用inner object</span><br><span class="line">PUT softwares/</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_meta&quot;: &#123;</span><br><span class="line">      &quot;software_version_mapping&quot;: &quot;1.1&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;version&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;display_name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;hot_fix&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;byte&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;marjor&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;byte&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;minor&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;byte&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#通过 Inner Object 写入多个文档</span><br><span class="line">PUT softwares/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;version&quot;:&#123;</span><br><span class="line">  &quot;display_name&quot;:&quot;7.1.0&quot;,</span><br><span class="line">  &quot;marjor&quot;:7,</span><br><span class="line">  &quot;minor&quot;:1,</span><br><span class="line">  &quot;hot_fix&quot;:0  </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT softwares/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;version&quot;:&#123;</span><br><span class="line">  &quot;display_name&quot;:&quot;7.2.0&quot;,</span><br><span class="line">  &quot;marjor&quot;:7,</span><br><span class="line">  &quot;minor&quot;:2,</span><br><span class="line">  &quot;hot_fix&quot;:0  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT softwares/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  &quot;version&quot;:&#123;</span><br><span class="line">  &quot;display_name&quot;:&quot;7.2.1&quot;,</span><br><span class="line">  &quot;marjor&quot;:7,</span><br><span class="line">  &quot;minor&quot;:2,</span><br><span class="line">  &quot;hot_fix&quot;:1  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 通过 bool 查询，</span><br><span class="line">POST softwares/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;:&#123;</span><br><span class="line">            &quot;version.marjor&quot;:7</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;:&#123;</span><br><span class="line">            &quot;version.minor&quot;:2</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Not Null 解决聚合的问题</span><br><span class="line">DELETE ratings</span><br><span class="line">PUT ratings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;properties&quot;: &#123;</span><br><span class="line">        &quot;rating&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;float&quot;,</span><br><span class="line">          &quot;null_value&quot;: 1.0</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT ratings/_doc/1</span><br><span class="line">&#123;</span><br><span class="line"> &quot;rating&quot;:5</span><br><span class="line">&#125;</span><br><span class="line">PUT ratings/_doc/2</span><br><span class="line">&#123;</span><br><span class="line"> &quot;rating&quot;:null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST ratings/_search</span><br><span class="line">POST ratings/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;avg&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;rating&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST ratings/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;rating&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: 1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="7-7-第二部分总结与测验-md"><a href="#7-7-第二部分总结与测验-md" class="headerlink" title="7.7-第二部分总结与测验.md"></a>7.7-第二部分总结与测验.md</h1><h1 id="第二部分总结与测验"><a href="#第二部分总结与测验" class="headerlink" title="第二部分总结与测验"></a>第二部分总结与测验</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">DELETE test</span><br><span class="line">PUT test/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;:&quot;Hello World&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &quot;Hello World&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &quot;hello world&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content.keyword&quot;: &quot;Hello World&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content.keyword&quot;: &quot;hello world&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &quot;Hello World&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &quot;hello world&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;profile&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;content.keyword&quot;: &quot;Hello World&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="8-1-集群身份认证与用户鉴权-md"><a href="#8-1-集群身份认证与用户鉴权-md" class="headerlink" title="8.1-集群身份认证与用户鉴权.md"></a>8.1-集群身份认证与用户鉴权.md</h1><h1 id="集群身份认证与用户鉴权"><a href="#集群身份认证与用户鉴权" class="headerlink" title="集群身份认证与用户鉴权"></a>集群身份认证与用户鉴权</h1><ul>
<li>如何为集群启用X-Pack Security</li>
<li>如何为内置用户设置密码</li>
<li>设置 Kibana与ElasticSearch通信鉴权</li>
<li>使用安全API创建对特定索引具有有限访问权限的用户</li>
</ul>
<p>This tutorial involves a single node cluster, but if you had multiple nodes, you would enable Elasticsearch security features on every node in the cluster and configure Transport Layer Security (TLS) for internode-communication, which is beyond the scope of this tutorial. By enabling single-node discovery, we are postponing the configuration of TLS. For example, add the following setting:</p>
<p>discovery.type: single-node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">#启动单节点</span><br><span class="line">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true</span><br><span class="line"></span><br><span class="line">#使用Curl访问ES，或者浏览器访问 “localhost:9200/_cat/nodes?pretty”。返回401错误</span><br><span class="line">curl &#x27;localhost:9200/_cat/nodes?pretty&#x27;</span><br><span class="line"></span><br><span class="line">#运行密码设定的命令，设置ES内置用户及其初始密码。</span><br><span class="line">bin/elasticsearch-setup-passwords interactive</span><br><span class="line"></span><br><span class="line">curl -u elastic &#x27;localhost:9200/_cat/nodes?pretty&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改 kibana.yml</span><br><span class="line">elasticsearch.username: &quot;kibana&quot;</span><br><span class="line">elasticsearch.password: &quot;changeme&quot;</span><br><span class="line"></span><br><span class="line">#启动。使用用户名，elastic，密码elastic</span><br><span class="line">./bin/kibana</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST orders/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class="line">&#123;&quot;product&quot; : &quot;1&quot;,&quot;price&quot; : 18,&quot;payment&quot; : &quot;master&quot;,&quot;card&quot; : &quot;9876543210123456&quot;,&quot;name&quot; : &quot;jack&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class="line">&#123;&quot;product&quot; : &quot;2&quot;,&quot;price&quot; : 99,&quot;payment&quot; : &quot;visa&quot;,&quot;card&quot; : &quot;1234567890123456&quot;,&quot;name&quot; : &quot;bob&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#create a new role named read_only_orders, that satisfies the following criteria:</span><br><span class="line">#The role has no cluster privileges</span><br><span class="line">#The role only has access to indices that match the pattern sales_record</span><br><span class="line">#The index privileges are read, and view_index_metadata</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#create sales_user that satisfies the following criteria:</span><br><span class="line"># Use your own email address</span><br><span class="line"># Assign the user to two roles: read_only_orders and kibana_user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#验证读权限,可以执行</span><br><span class="line">POST orders/_search</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">#验证写权限,报错</span><br><span class="line">POST orders/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class="line">&#123;&quot;product&quot; : &quot;1&quot;,&quot;price&quot; : 18,&quot;payment&quot; : &quot;master&quot;,&quot;card&quot; : &quot;9876543210123456&quot;,&quot;name&quot; : &quot;jack&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&#125;&#125;</span><br><span class="line">&#123;&quot;product&quot; : &quot;2&quot;,&quot;price&quot; : 99,&quot;payment&quot; : &quot;visa&quot;,&quot;card&quot; : &quot;1234567890123456&quot;,&quot;name&quot; : &quot;bob&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h1 id="8-2-集群内部安全通信-md"><a href="#8-2-集群内部安全通信-md" class="headerlink" title="8.2-集群内部安全通信.md"></a>8.2-集群内部安全通信.md</h1><h1 id="-3"><a href="#-3" class="headerlink" title=""></a></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 生成证书</span><br><span class="line"># 为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：</span><br><span class="line">bin/elasticsearch-certutil ca</span><br><span class="line"></span><br><span class="line">#为群集中的每个节点生成证书和私钥。例如，使用elasticsearch-certutil cert 命令：</span><br><span class="line">bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br><span class="line"></span><br><span class="line">#将证书拷贝到 config/certs目录下</span><br><span class="line">elastic-certificates.p12</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class="line"></span><br><span class="line">bin/elasticsearch -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E http.port=9201 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#不提供证书的节点，无法加入</span><br><span class="line">bin/elasticsearch -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E http.port=9202 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">## elasticsearch.yml 配置</span><br><span class="line"></span><br><span class="line">#xpack.security.transport.ssl.enabled: true</span><br><span class="line">#xpack.security.transport.ssl.verification_mode: certificate</span><br><span class="line"></span><br><span class="line">#xpack.security.transport.ssl.keystore.path: certs/elastic-certificates.p12</span><br><span class="line">#xpack.security.transport.ssl.truststore.path: certs/elastic-certificates.p12</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="8-3-集群与外部间的安全通信-md"><a href="#8-3-集群与外部间的安全通信-md" class="headerlink" title="8.3-集群与外部间的安全通信.md"></a>8.3-集群与外部间的安全通信.md</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xpack.security.http.ssl.enabled: true</span><br><span class="line">xpack.security.http.ssl.keystore.path: certs/elastic-certificates.p12</span><br><span class="line">xpack.security.http.ssl.truststore.path: certs/elastic-certificates.p12</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># ES 启用 https</span><br><span class="line">bin/elasticsearch -E node.name=node0 -E cluster.name=geektime -E path.data=node0_data -E http.port=9200 -E xpack.security.enabled=true -E xpack.security.transport.ssl.enabled=true -E xpack.security.transport.ssl.verification_mode=certificate -E xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.enabled=true -E xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12 -E xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#Kibana 连接 ES https</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 为kibana生成pem</span><br><span class="line">openssl pkcs12 -in elastic-certificates.p12 -cacerts -nokeys -out elastic-ca.pem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elasticsearch.hosts: [&quot;https://localhost:9200&quot;]</span><br><span class="line">elasticsearch.ssl.certificateAuthorities: [ &quot;/Users/yiruan/geektime/kibana-7.1.0/config/certs/elastic-ca.pem&quot; ]</span><br><span class="line">elasticsearch.ssl.verificationMode: certificate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 为 Kibna 配置 HTTPS</span><br><span class="line"># 生成后解压，包含了instance.crt 和 instance.key</span><br><span class="line">bin/elasticsearch-certutil ca --pem</span><br><span class="line"></span><br><span class="line">server.ssl.enabled: true</span><br><span class="line">server.ssl.certificate: config/certs/instance.crt</span><br><span class="line">server.ssl.key: config/certs/instance.key</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="9-1-常见的集群部署方式-md-1"><a href="#9-1-常见的集群部署方式-md-1" class="headerlink" title="9.1-常见的集群部署方式.md"></a>9.1-常见的集群部署方式.md</h1><h1 id="常见的集群部署方式-1"><a href="#常见的集群部署方式-1" class="headerlink" title="常见的集群部署方式"></a>常见的集群部署方式</h1><h1 id="9-2-Hot-Warm架构与ShardFiltering-md-1"><a href="#9-2-Hot-Warm架构与ShardFiltering-md-1" class="headerlink" title="9.2-Hot&amp;Warm架构与ShardFiltering.md"></a>9.2-Hot&amp;Warm架构与ShardFiltering.md</h1><h1 id="Hot-Warm-架构与-Shard-Filtering-1"><a href="#Hot-Warm-架构与-Shard-Filtering-1" class="headerlink" title="Hot &amp; Warm 架构与 Shard Filtering"></a>Hot &amp; Warm 架构与 Shard Filtering</h1><h2 id="课程代码-1"><a href="#课程代码-1" class="headerlink" title="课程代码"></a>课程代码</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"># 标记一个 Hot 节点</span><br><span class="line">bin/elasticsearch  -E node.name=hotnode -E cluster.name=geektime -E path.data=hot_data -E node.attr.my_node_type=hot</span><br><span class="line"></span><br><span class="line"># 标记一个 warm 节点</span><br><span class="line">bin/elasticsearch  -E node.name=warmnode -E cluster.name=geektime -E path.data=warm_data -E node.attr.my_node_type=warm</span><br><span class="line"></span><br><span class="line"># 查看节点</span><br><span class="line">GET /_cat/nodeattrs?v</span><br><span class="line"></span><br><span class="line"># 配置到 Hot节点</span><br><span class="line">PUT logs-2019-06-27</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;:&#123;</span><br><span class="line">    &quot;number_of_shards&quot;:2,</span><br><span class="line">    &quot;number_of_replicas&quot;:0,</span><br><span class="line">    &quot;index.routing.allocation.require.my_node_type&quot;:&quot;hot&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT my_index1/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET _cat/shards?v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置到 warm 节点</span><br><span class="line">PUT PUT logs-2019-06-27/_settings</span><br><span class="line">&#123;  </span><br><span class="line">  &quot;index.routing.allocation.require.my_node_type&quot;:&quot;warm&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 标记一个 rack 1</span><br><span class="line">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class="line"></span><br><span class="line"># 标记一个 rack 2</span><br><span class="line">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack2</span><br><span class="line"></span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;:&#123;</span><br><span class="line">    &quot;number_of_shards&quot;:2,</span><br><span class="line">    &quot;number_of_replicas&quot;:1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT my_index1/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;key&quot;:&quot;value&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET _cat/shards?v</span><br><span class="line">DELETE my_index1/_doc/1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Fore awareness</span><br><span class="line"># 标记一个 rack 1</span><br><span class="line">bin/elasticsearch  -E node.name=node1 -E cluster.name=geektime -E path.data=node1_data -E node.attr.my_rack_id=rack1</span><br><span class="line"></span><br><span class="line"># 标记一个 rack 2</span><br><span class="line">bin/elasticsearch  -E node.name=node2 -E cluster.name=geektime -E path.data=node2_data -E node.attr.my_rack_id=rack1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;my_rack_id&quot;,</span><br><span class="line">    &quot;cluster.routing.allocation.awareness.force.my_rack_id.values&quot;: &quot;rack1,rack2&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET _cluster/settings</span><br><span class="line"></span><br><span class="line"># 集群黄色</span><br><span class="line">GET _cluster/health</span><br><span class="line"></span><br><span class="line"># 副本无法分配</span><br><span class="line">GET _cat/shards?v</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET _cluster/allocation/explain?pretty</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">candy</div><div class="post-copyright__author_desc">欢迎来到点到为止.</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://candyadmin.github.io/elasticsearch/es%E9%AB%98%E7%BA%A7%E5%91%BD%E4%BB%A4/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://candyadmin.github.io/elasticsearch/es%E9%AB%98%E7%BA%A7%E5%91%BD%E4%BB%A4/')">es高级命令</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://candyadmin.github.io/elasticsearch/es%E9%AB%98%E7%BA%A7%E5%91%BD%E4%BB%A4/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=es高级命令&amp;url=https://candyadmin.github.io/elasticsearch/es%E9%AB%98%E7%BA%A7%E5%91%BD%E4%BB%A4/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://candyadmin.github.io" target="_blank">点到为止</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>学习笔记<span class="tagsPageCount">2</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/elasticsearch/es%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">es常用命令</div></div></a></div><div class="next-post pull-right"><a href="/%E4%BA%A4%E6%98%93/%E4%BA%A4%E6%98%93%E7%AD%96%E7%95%A5%E6%80%BB%E7%BB%93/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">交易策略总结</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/elasticsearch/es%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" title="es常用命令"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-02-27</div><div class="title">es常用命令</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/04/27/64496e511b09c.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description"></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Elasticsearch-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E4%B8%8E%E4%BC%98%E5%8C%96%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">Elasticsearch 集群管理与优化笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%A7%BB%E5%8A%A8%E5%88%86%E7%89%87%E5%88%B0%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9"><span class="toc-number">1.1.</span> <span class="toc-text">1. 移动分片到另一个节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%BC%BA%E5%88%B6%E5%88%86%E9%85%8D%E6%9C%AA%E5%88%86%E9%85%8D%E7%9A%84%E5%88%86%E7%89%87%EF%BC%88%E5%B8%A6%E5%8E%9F%E5%9B%A0%E8%AF%B4%E6%98%8E%EF%BC%89"><span class="toc-number">1.2.</span> <span class="toc-text">2. 强制分配未分配的分片（带原因说明）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BB%8E%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.</span> <span class="toc-text">3. 从集群中移除节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%BC%BA%E5%88%B6%E6%89%A7%E8%A1%8C%E5%90%8C%E6%AD%A5%E5%88%B7%E6%96%B0"><span class="toc-number">1.4.</span> <span class="toc-text">4. 强制执行同步刷新</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%B0%83%E6%95%B4%E9%9B%86%E7%BE%A4%E5%B9%B3%E8%A1%A1%E6%97%B6%E7%A7%BB%E5%8A%A8%E7%9A%84%E5%88%86%E7%89%87%E6%95%B0%E9%87%8F"><span class="toc-number">1.5.</span> <span class="toc-text">5. 调整集群平衡时移动的分片数量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E8%B0%83%E6%95%B4%E6%AF%8F%E4%B8%AA%E8%8A%82%E7%82%B9%E5%90%8C%E6%97%B6%E6%81%A2%E5%A4%8D%E7%9A%84%E5%88%86%E7%89%87%E6%95%B0%E9%87%8F"><span class="toc-number">1.6.</span> <span class="toc-text">6. 调整每个节点同时恢复的分片数量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E8%B0%83%E6%95%B4%E6%81%A2%E5%A4%8D%E9%80%9F%E5%BA%A6"><span class="toc-number">1.7.</span> <span class="toc-text">7. 调整恢复速度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E8%B0%83%E6%95%B4%E5%8D%95%E8%8A%82%E7%82%B9%E6%81%A2%E5%A4%8D%E6%97%B6%E5%B9%B6%E5%8F%91%E6%B5%81%E6%95%B0%E9%87%8F"><span class="toc-number">1.8.</span> <span class="toc-text">8. 调整单节点恢复时并发流数量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E8%B0%83%E6%95%B4%E6%90%9C%E7%B4%A2%E9%98%9F%E5%88%97%E5%A4%A7%E5%B0%8F"><span class="toc-number">1.9.</span> <span class="toc-text">9. 调整搜索队列大小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E6%B8%85%E9%99%A4%E8%8A%82%E7%82%B9%E7%BC%93%E5%AD%98"><span class="toc-number">1.10.</span> <span class="toc-text">10. 清除节点缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E8%B0%83%E6%95%B4%E6%96%AD%E8%B7%AF%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.11.</span> <span class="toc-text">11. 调整断路器配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7-Elasticsearch-%E9%9B%86%E7%BE%A4"><span class="toc-number">2.</span> <span class="toc-text">监控 Elasticsearch 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%8A%82%E7%82%B9%E7%BB%9F%E8%AE%A1"><span class="toc-number">2.1.</span> <span class="toc-text">1. 节点统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%9B%86%E7%BE%A4%E7%BB%9F%E8%AE%A1"><span class="toc-number">2.2.</span> <span class="toc-text">2. 集群统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%B4%A2%E5%BC%95%E7%BB%9F%E8%AE%A1"><span class="toc-number">2.3.</span> <span class="toc-text">3. 索引统计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8B%E5%BE%85%E5%A4%84%E7%90%86%E7%9A%84%E9%9B%86%E7%BE%A4%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.4.</span> <span class="toc-text">4. 查看待处理的集群任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E4%BB%BB%E5%8A%A1%EF%BC%8C%E6%94%AF%E6%8C%81%E5%8F%96%E6%B6%88%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.5.</span> <span class="toc-text">5. 查看所有任务，支持取消任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%9F%A5%E7%9C%8B%E8%8A%82%E7%82%B9%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BF%A1%E6%81%AF"><span class="toc-number">2.6.</span> <span class="toc-text">6. 查看节点的线程池信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E8%AE%BE%E7%BD%AE%E7%B4%A2%E5%BC%95%E6%85%A2%E6%97%A5%E5%BF%97%EF%BC%88Slowlog%EF%BC%89"><span class="toc-number">2.7.</span> <span class="toc-text">7. 设置索引慢日志（Slowlog）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E9%9B%86%E7%BE%A4-Yellow-%E4%B8%8E-Red-%E7%8A%B6%E6%80%81%E9%97%AE%E9%A2%98"><span class="toc-number">3.</span> <span class="toc-text">解决集群 Yellow 与 Red 状态问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A3%80%E6%9F%A5%E9%9B%86%E7%BE%A4%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="toc-number">3.1.</span> <span class="toc-text">1. 检查集群健康状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95%E7%BA%A7%E5%88%AB%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81%EF%BC%8C%E6%89%BE%E5%87%BA%E7%BA%A2%E8%89%B2%E7%B4%A2%E5%BC%95"><span class="toc-number">3.2.</span> <span class="toc-text">2. 查看索引级别健康状态，找出红色索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%9F%A5%E7%9C%8B%E5%88%86%E7%89%87%E7%BA%A7%E5%88%AB%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="toc-number">3.3.</span> <span class="toc-text">3. 查看分片级别健康状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%A7%A3%E9%87%8A%E7%B4%A2%E5%BC%95%E5%88%86%E7%89%87%E6%97%A0%E6%B3%95%E5%88%86%E9%85%8D%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="toc-number">3.4.</span> <span class="toc-text">4. 解释索引分片无法分配的原因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%88%A0%E9%99%A4%E5%B9%B6%E9%87%8D%E6%96%B0%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-number">3.5.</span> <span class="toc-text">5. 删除并重新创建索引</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%90%E5%8D%87%E9%9B%86%E7%BE%A4%E5%86%99%E6%80%A7%E8%83%BD"><span class="toc-number">4.</span> <span class="toc-text">提升集群写性能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%AE%BE%E7%BD%AE%E4%BC%98%E5%8C%96%E5%86%99%E5%85%A5%E6%80%A7%E8%83%BD%E7%9A%84%E7%B4%A2%E5%BC%95%E8%AE%BE%E7%BD%AE"><span class="toc-number">4.1.</span> <span class="toc-text">1. 设置优化写入性能的索引设置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%90%E5%8D%87%E9%9B%86%E7%BE%A4%E8%AF%BB%E6%80%A7%E8%83%BD"><span class="toc-number">5.</span> <span class="toc-text">提升集群读性能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%A4%BA%E4%BE%8B%EF%BC%9A%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-number">5.1.</span> <span class="toc-text">1. 示例：查询优化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">6.</span> <span class="toc-text">集群压力测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AE-esrally"><span class="toc-number">6.1.</span> <span class="toc-text">1. 安装并配置 esrally</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%89%A7%E8%A1%8C%E7%AE%80%E5%8D%95%E7%9A%84%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">6.2.</span> <span class="toc-text">2. 执行简单的压力测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%95%B4%E6%95%B0%E6%8D%AE%E6%B5%8B%E8%AF%95"><span class="toc-number">6.3.</span> <span class="toc-text">3. 执行完整数据测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98%E4%B8%8E-Breaker-%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">使用缓存与 Breaker 限制内存使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%8E%B7%E5%8F%96%E8%8A%82%E7%82%B9%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">7.1.</span> <span class="toc-text">1. 获取节点统计信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%AE%BE%E7%BD%AE%E5%86%85%E5%AD%98%E9%99%90%E5%88%B6"><span class="toc-number">7.2.</span> <span class="toc-text">2. 设置内存限制</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Shrink-%E4%B8%8E-Rollover-API-%E7%AE%A1%E7%90%86%E7%B4%A2%E5%BC%95"><span class="toc-number">8.</span> <span class="toc-text">使用 Shrink 与 Rollover API 管理索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Shrink-%E7%B4%A2%E5%BC%95"><span class="toc-number">8.1.</span> <span class="toc-text">1. Shrink 索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Rollover-%E7%B4%A2%E5%BC%95"><span class="toc-number">8.2.</span> <span class="toc-text">2. Rollover 索引</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E4%B8%89%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%8C%E5%88%86%E7%89%87-%E5%B0%86box-type%E8%AE%BE%E7%BD%AE%E6%88%90-hot%EF%BC%8Cwarm%E5%92%8Ccold"><span class="toc-number">9.</span> <span class="toc-text">运行三个节点，分片 将box_type设置成 hot，warm和cold</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%8F%82%E8%80%83-github%E4%B8%8B%EF%BC%8Cdocker-hot-warm-cold-%E4%B8%8B%E7%9A%84docker-compose-%E6%96%87%E4%BB%B6"><span class="toc-number">10.</span> <span class="toc-text">具体参考 github下，docker-hot-warm-cold 下的docker-compose 文件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-1%E7%A7%92%E5%88%B7%E6%96%B01%E6%AC%A1%EF%BC%8C%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%8310%E5%88%86%E7%A7%8D%E5%88%B7%E6%96%B0%E4%B8%80%E6%AC%A1"><span class="toc-number">11.</span> <span class="toc-text">设置 1秒刷新1次，生产环境10分种刷新一次</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-Policy"><span class="toc-number">12.</span> <span class="toc-text">设置 Policy</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%B4%A2%E5%BC%95%E6%A8%A1%E7%89%88"><span class="toc-number">13.</span> <span class="toc-text">设置索引模版</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9-Alias%E5%86%99%E5%85%A5%E6%96%87%E6%A1%A3"><span class="toc-number">14.</span> <span class="toc-text">对 Alias写入文档</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA-Demo%EF%BC%8C-demo-%E8%BF%90%E8%A1%8C"><span class="toc-number">15.</span> <span class="toc-text">一个 Demo， demo 运行</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#demo%E6%95%B0%E6%8D%AE"><span class="toc-number">16.</span> <span class="toc-text">demo数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#codec-demo"><span class="toc-number">17.</span> <span class="toc-text">codec demo</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E8%A1%8C%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%BC%82%E5%B8%B8"><span class="toc-number">18.</span> <span class="toc-text">多行数据，异常</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B"><span class="toc-number">19.</span> <span class="toc-text">一个实例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E7%94%A8%E6%88%B7"><span class="toc-number">20.</span> <span class="toc-text">新增用户</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7"><span class="toc-number">21.</span> <span class="toc-text">更新用户</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7"><span class="toc-number">22.</span> <span class="toc-text">删除用户</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-alias%EF%BC%8C%E5%8F%AA%E6%98%BE%E7%A4%BA%E6%B2%A1%E6%9C%89%E8%A2%AB%E6%A0%87%E8%AE%B0-deleted%E7%9A%84%E7%94%A8%E6%88%B7"><span class="toc-number">23.</span> <span class="toc-text">创建 alias，只显示没有被标记 deleted的用户</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-Alias%E6%9F%A5%E8%AF%A2%EF%BC%8C%E6%9F%A5%E4%B8%8D%E5%88%B0%E8%A2%AB%E6%A0%87%E8%AE%B0%E6%88%90-deleted%E7%9A%84%E7%94%A8%E6%88%B7"><span class="toc-number">24.</span> <span class="toc-text">通过 Alias查询，查不到被标记成 deleted的用户</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">24.1.</span> <span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B-packetbeat-%E6%A8%A1%E5%9D%97"><span class="toc-number">25.</span> <span class="toc-text">查看 packetbeat 模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-packetbeat-%E7%9A%84mysql-%E6%A8%A1%E5%9D%97"><span class="toc-number">26.</span> <span class="toc-text">设置 packetbeat 的mysql 模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%BF%90%E8%A1%8C"><span class="toc-number">27.</span> <span class="toc-text">启动运行</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-1"><span class="toc-number">28.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85mysql"><span class="toc-number">29.</span> <span class="toc-text">安装mysql</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-packetbeat"><span class="toc-number">30.</span> <span class="toc-text">配置 packetbeat</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">31.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89-Filebeat-%E6%A8%A1%E5%9D%97"><span class="toc-number">32.</span> <span class="toc-text">查看所有 Filebeat 模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E7%9A%84modules"><span class="toc-number">33.</span> <span class="toc-text">查看所有的modules</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-2"><span class="toc-number">34.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#For-Mac-Windows"><span class="toc-number">35.</span> <span class="toc-text">For Mac &amp; Windows</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#For-Mac-Windows-1"><span class="toc-number">36.</span> <span class="toc-text">For Mac &amp; Windows</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B-modules-d-%E7%BC%96%E8%BE%91%E7%9B%B8%E5%BA%94%E7%9A%84%E6%96%87%E4%BB%B6%EF%BC%8C%E4%BF%AE%E6%94%B9log%E8%B7%AF%E5%BE%84"><span class="toc-number">36.1.</span> <span class="toc-text">进 modules.d 编辑相应的文件，修改log路径</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F-range"><span class="toc-number">37.</span> <span class="toc-text">日期 range</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Metric-%E8%81%9A%E5%90%88%EF%BC%8C%E6%89%BE%E5%88%B0%E6%9C%80%E4%BD%8E%E7%9A%84%E5%B7%A5%E8%B5%84"><span class="toc-number">38.</span> <span class="toc-text">Metric 聚合，找到最低的工资</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Metric-%E8%81%9A%E5%90%88%EF%BC%8C%E6%89%BE%E5%88%B0%E6%9C%80%E9%AB%98%E7%9A%84%E5%B7%A5%E8%B5%84"><span class="toc-number">39.</span> <span class="toc-text">Metric 聚合，找到最高的工资</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA-Metric-%E8%81%9A%E5%90%88%EF%BC%8C%E6%89%BE%E5%88%B0%E6%9C%80%E4%BD%8E%E6%9C%80%E9%AB%98%E5%92%8C%E5%B9%B3%E5%9D%87%E5%B7%A5%E8%B5%84"><span class="toc-number">40.</span> <span class="toc-text">多个 Metric 聚合，找到最低最高和平均工资</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E8%81%9A%E5%90%88%EF%BC%8C%E8%BE%93%E5%87%BA%E5%A4%9A%E5%80%BC"><span class="toc-number">41.</span> <span class="toc-text">一个聚合，输出多值</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9keword-%E8%BF%9B%E8%A1%8C%E8%81%9A%E5%90%88"><span class="toc-number">42.</span> <span class="toc-text">对keword 进行聚合</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9-Text-%E5%AD%97%E6%AE%B5%E8%BF%9B%E8%A1%8C-terms-%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2%EF%BC%8C%E5%A4%B1%E8%B4%A5"><span class="toc-number">43.</span> <span class="toc-text">对 Text 字段进行 terms 聚合查询，失败</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9-Text-%E5%AD%97%E6%AE%B5%E6%89%93%E5%BC%80-fielddata%EF%BC%8C%E6%94%AF%E6%8C%81terms-aggregation"><span class="toc-number">44.</span> <span class="toc-text">对 Text 字段打开 fielddata，支持terms aggregation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9-Text-%E5%AD%97%E6%AE%B5%E8%BF%9B%E8%A1%8C-terms-%E5%88%86%E8%AF%8D%E3%80%82%E5%88%86%E8%AF%8D%E5%90%8E%E7%9A%84terms"><span class="toc-number">45.</span> <span class="toc-text">对 Text 字段进行 terms 分词。分词后的terms</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9job-keyword-%E5%92%8C-job-%E8%BF%9B%E8%A1%8C-terms-%E8%81%9A%E5%90%88%EF%BC%8C%E5%88%86%E6%A1%B6%E7%9A%84%E6%80%BB%E6%95%B0%E5%B9%B6%E4%B8%8D%E4%B8%80%E6%A0%B7"><span class="toc-number">46.</span> <span class="toc-text">对job.keyword 和 job 进行 terms 聚合，分桶的总数并不一样</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9-%E6%80%A7%E5%88%AB%E7%9A%84-keyword-%E8%BF%9B%E8%A1%8C%E8%81%9A%E5%90%88"><span class="toc-number">47.</span> <span class="toc-text">对 性别的 keyword 进行聚合</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8C%87%E5%AE%9Asize%EF%BC%8C%E4%B8%8D%E5%90%8C%E5%B7%A5%E7%A7%8D%E4%B8%AD%EF%BC%8C%E5%B9%B4%E7%BA%AA%E6%9C%80%E5%A4%A7%E7%9A%843%E4%B8%AA%E5%91%98%E5%B7%A5%E7%9A%84%E5%85%B7%E4%BD%93%E4%BF%A1%E6%81%AF"><span class="toc-number">48.</span> <span class="toc-text">指定size，不同工种中，年纪最大的3个员工的具体信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97%E8%81%9A%E5%90%881%EF%BC%8C%E6%8C%89%E7%85%A7%E5%B7%A5%E4%BD%9C%E7%B1%BB%E5%9E%8B%E5%88%86%E6%A1%B6%EF%BC%8C%E5%B9%B6%E7%BB%9F%E8%AE%A1%E5%B7%A5%E8%B5%84%E4%BF%A1%E6%81%AF"><span class="toc-number">49.</span> <span class="toc-text">嵌套聚合1，按照工作类型分桶，并统计工资信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E6%AC%A1%E5%B5%8C%E5%A5%97%E3%80%82%E6%A0%B9%E6%8D%AE%E5%B7%A5%E4%BD%9C%E7%B1%BB%E5%9E%8B%E5%88%86%E6%A1%B6%EF%BC%8C%E7%84%B6%E5%90%8E%E6%8C%89%E7%85%A7%E6%80%A7%E5%88%AB%E5%88%86%E6%A1%B6%EF%BC%8C%E8%AE%A1%E7%AE%97%E5%B7%A5%E8%B5%84%E7%9A%84%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">50.</span> <span class="toc-text">多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%B3%E5%9D%87%E5%B7%A5%E8%B5%84%E6%9C%80%E4%BD%8E%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%B1%BB%E5%9E%8B"><span class="toc-number">51.</span> <span class="toc-text">平均工资最低的工作类型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%B3%E5%9D%87%E5%B7%A5%E8%B5%84%E6%9C%80%E9%AB%98%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%B1%BB%E5%9E%8B"><span class="toc-number">52.</span> <span class="toc-text">平均工资最高的工作类型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%B3%E5%9D%87%E5%B7%A5%E8%B5%84%E7%9A%84%E5%B9%B3%E5%9D%87%E5%B7%A5%E8%B5%84"><span class="toc-number">53.</span> <span class="toc-text">平均工资的平均工资</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%B3%E5%9D%87%E5%B7%A5%E8%B5%84%E7%9A%84%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90"><span class="toc-number">54.</span> <span class="toc-text">平均工资的统计分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B9%B3%E5%9D%87%E5%B7%A5%E8%B5%84%E7%9A%84%E7%99%BE%E5%88%86%E4%BD%8D%E6%95%B0"><span class="toc-number">55.</span> <span class="toc-text">平均工资的百分位数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Query"><span class="toc-number">56.</span> <span class="toc-text">Query</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEblog%E7%9A%84-Mapping"><span class="toc-number">57.</span> <span class="toc-text">设置blog的 Mapping</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E4%B8%80%E6%9D%A1-Blog-%E4%BF%A1%E6%81%AF"><span class="toc-number">58.</span> <span class="toc-text">插入一条 Blog 信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2-Blog-%E4%BF%A1%E6%81%AF"><span class="toc-number">59.</span> <span class="toc-text">查询 Blog 信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%B5%E5%BD%B1%E7%9A%84Mapping%E4%BF%A1%E6%81%AF"><span class="toc-number">60.</span> <span class="toc-text">电影的Mapping信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E4%B8%80%E6%9D%A1%E7%94%B5%E5%BD%B1%E4%BF%A1%E6%81%AF"><span class="toc-number">61.</span> <span class="toc-text">写入一条电影信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%94%B5%E5%BD%B1%E4%BF%A1%E6%81%AF"><span class="toc-number">62.</span> <span class="toc-text">查询电影信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-Nested-%E5%AF%B9%E8%B1%A1-Mapping"><span class="toc-number">63.</span> <span class="toc-text">创建 Nested 对象 Mapping</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nested-%E6%9F%A5%E8%AF%A2"><span class="toc-number">64.</span> <span class="toc-text">Nested 查询</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nested-Aggregation"><span class="toc-number">65.</span> <span class="toc-text">Nested Aggregation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%99%AE%E9%80%9A-aggregation%E4%B8%8D%E5%B7%A5%E4%BD%9C"><span class="toc-number">66.</span> <span class="toc-text">普通 aggregation不工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E5%AE%9A-Parent-Child-Mapping"><span class="toc-number">67.</span> <span class="toc-text">设定 Parent&#x2F;Child Mapping</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E6%96%87%E6%A1%A3"><span class="toc-number">68.</span> <span class="toc-text">查询所有文档</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Parent-Id-%E6%9F%A5%E8%AF%A2"><span class="toc-number">69.</span> <span class="toc-text">Parent Id 查询</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Has-Child-%E6%9F%A5%E8%AF%A2-%E8%BF%94%E5%9B%9E%E7%88%B6%E6%96%87%E6%A1%A3"><span class="toc-number">70.</span> <span class="toc-text">Has Child 查询,返回父文档</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Has-Parent-%E6%9F%A5%E8%AF%A2%EF%BC%8C%E8%BF%94%E5%9B%9E%E7%9B%B8%E5%85%B3%E7%9A%84%E5%AD%90%E6%96%87%E6%A1%A3"><span class="toc-number">71.</span> <span class="toc-text">Has Parent 查询，返回相关的子文档</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Data-Modeling-Example"><span class="toc-number">71.0.0.0.0.1.</span> <span class="toc-text">Data Modeling Example</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Index-%E4%B8%80%E6%9C%AC%E4%B9%A6%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="toc-number">72.</span> <span class="toc-text">Index 一本书的信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Index-%E4%B8%80%E6%9C%AC%E4%B9%A6%E7%9A%84%E4%BF%A1%E6%81%AF-%E5%8C%85%E5%90%ABContent"><span class="toc-number">73.</span> <span class="toc-text">Index 一本书的信息,包含Content</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Cookie-Service"><span class="toc-number">73.0.0.0.0.1.</span> <span class="toc-text">Cookie Service</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nested-%E6%9F%A5%E8%AF%A2%EF%BC%8C%E9%80%9A%E8%BF%87bool%E6%9F%A5%E8%AF%A2%E8%BF%9B%E8%A1%8C%E8%BF%87%E6%BB%A4"><span class="toc-number">74.</span> <span class="toc-text">Nested 查询，通过bool查询进行过滤</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%A8Mapping%E4%B8%AD%E5%8A%A0%E5%85%A5%E5%85%83%E4%BF%A1%E6%81%AF%EF%BC%8C%E4%BE%BF%E4%BA%8E%E7%AE%A1%E7%90%86"><span class="toc-number">75.</span> <span class="toc-text">在Mapping中加入元信息，便于管理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%98%E5%8C%96-%E4%BD%BF%E7%94%A8inner-object"><span class="toc-number">76.</span> <span class="toc-text">优化,使用inner object</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-bool-%E6%9F%A5%E8%AF%A2%EF%BC%8C"><span class="toc-number">77.</span> <span class="toc-text">通过 bool 查询，</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Not-Null-%E8%A7%A3%E5%86%B3%E8%81%9A%E5%90%88%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">78.</span> <span class="toc-text">Not Null 解决聚合的问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-kibana-yml"><span class="toc-number">79.</span> <span class="toc-text">修改 kibana.yml</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Use-your-own-email-address"><span class="toc-number">80.</span> <span class="toc-text">Use your own email address</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Assign-the-user-to-two-roles-read-only-orders-and-kibana-user"><span class="toc-number">81.</span> <span class="toc-text">Assign the user to two roles: read_only_orders and kibana_user</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-number">82.</span> <span class="toc-text">生成证书</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E6%82%A8%E7%9A%84Elasticearch%E9%9B%86%E7%BE%A4%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%AF%81%E4%B9%A6%E9%A2%81%E5%8F%91%E6%9C%BA%E6%9E%84%E3%80%82%E4%BE%8B%E5%A6%82%EF%BC%8C%E4%BD%BF%E7%94%A8elasticsearch-certutil-ca%E5%91%BD%E4%BB%A4%EF%BC%9A"><span class="toc-number">83.</span> <span class="toc-text">为您的Elasticearch集群创建一个证书颁发机构。例如，使用elasticsearch-certutil ca命令：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#elasticsearch-yml-%E9%85%8D%E7%BD%AE"><span class="toc-number">83.1.</span> <span class="toc-text">elasticsearch.yml 配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-1-%E5%B8%B8%E8%A7%81%E7%9A%84%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F-md"><span class="toc-number">84.</span> <span class="toc-text">9.1-常见的集群部署方式.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F"><span class="toc-number">85.</span> <span class="toc-text">常见的集群部署方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-2-Hot-Warm%E6%9E%B6%E6%9E%84%E4%B8%8EShardFiltering-md"><span class="toc-number">86.</span> <span class="toc-text">9.2-Hot&amp;Warm架构与ShardFiltering.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hot-Warm-%E6%9E%B6%E6%9E%84%E4%B8%8E-Shard-Filtering"><span class="toc-number">87.</span> <span class="toc-text">Hot &amp; Warm 架构与 Shard Filtering</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">87.1.</span> <span class="toc-text">课程代码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-3-%E5%A6%82%E4%BD%95%E5%AF%B9%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E5%AE%B9%E9%87%8F%E8%A7%84%E5%88%92-md"><span class="toc-number">88.</span> <span class="toc-text">9.3-如何对集群进行容量规划.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AF%B9%E9%9B%86%E7%BE%A4%E8%BF%9B%E8%A1%8C%E5%AE%B9%E9%87%8F%E8%A7%84%E5%88%92"><span class="toc-number">89.</span> <span class="toc-text">如何对集群进行容量规划</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81Demo"><span class="toc-number">89.1.</span> <span class="toc-text">代码Demo</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-4-%E5%88%86%E7%89%87%E8%AE%BE%E8%AE%A1%E5%8F%8A%E7%AE%A1%E7%90%86-md"><span class="toc-number">90.</span> <span class="toc-text">9.4-分片设计及管理.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E7%89%87%E8%AE%BE%E8%AE%A1%E5%8F%8A%E7%AE%A1%E7%90%86"><span class="toc-number">91.</span> <span class="toc-text">分片设计及管理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-5-%E5%9C%A8%E7%A7%81%E6%9C%89%E4%BA%91%E4%B8%8A%E7%AE%A1%E7%90%86%E4%B8%8E%E9%83%A8%E7%BD%B2Elasticsearch%E9%9B%86%E7%BE%A4-md"><span class="toc-number">92.</span> <span class="toc-text">9.5-在私有云上管理与部署Elasticsearch集群.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%A8%E7%A7%81%E6%9C%89%E4%BA%91%E4%B8%8A%E7%AE%A1%E7%90%86%E4%B8%8E%E9%83%A8%E7%BD%B2-Elasticsearch-%E9%9B%86%E7%BE%A4"><span class="toc-number">93.</span> <span class="toc-text">在私有云上管理与部署 Elasticsearch 集群</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-6-%E5%9C%A8%E5%85%AC%E6%9C%89%E4%BA%91%E4%B8%8A%E7%AE%A1%E7%90%86%E4%B8%8E%E9%83%A8%E7%BD%B2Elasticsearch%E9%9B%86%E7%BE%A4-md"><span class="toc-number">94.</span> <span class="toc-text">9.6-在公有云上管理与部署Elasticsearch集群.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%A8%E5%85%AC%E6%9C%89%E4%BA%91%E4%B8%8A%E7%AE%A1%E7%90%86%E4%B8%8E%E9%83%A8%E7%BD%B2-Elasticsearch-%E9%9B%86%E7%BE%A4"><span class="toc-number">95.</span> <span class="toc-text">在公有云上管理与部署 Elasticsearch 集群</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#result-md"><span class="toc-number">96.</span> <span class="toc-text">result.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-1-%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%B8%8A%E7%BA%BF%E6%B8%85%E5%8D%95-md"><span class="toc-number">97.</span> <span class="toc-text">10.1-生产环境常用配置与上线清单.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%9F%A5%E7%94%A8%E9%85%8D%E7%BD%AE%E4%B8%8E%E7%BA%BF%E4%B8%8A%E6%B8%85%E5%8D%95"><span class="toc-number">98.</span> <span class="toc-text">生产环境查用配置与线上清单</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-10-%E4%B8%80%E4%BA%9B%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE-md"><span class="toc-number">99.</span> <span class="toc-text">10.10-一些运维相关的建议.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3%E7%9A%84%E5%BB%BA%E8%AE%AE"><span class="toc-number">100.</span> <span class="toc-text">一些运维相关的建议</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-2-%E7%9B%91%E6%8E%A7Elasticsearch%E9%9B%86%E7%BE%A4-md"><span class="toc-number">101.</span> <span class="toc-text">10.2-监控Elasticsearch集群.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7-Elasticsearch-%E9%9B%86%E7%BE%A4-1"><span class="toc-number">102.</span> <span class="toc-text">监控 Elasticsearch 集群</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-3-%E8%AF%8A%E6%96%AD%E9%9B%86%E7%BE%A4%E7%9A%84%E6%BD%9C%E5%9C%A8%E9%97%AE%E9%A2%98-md"><span class="toc-number">103.</span> <span class="toc-text">10.3-诊断集群的潜在问题.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%8A%E6%96%AD%E9%9B%86%E7%BE%A4%E7%9A%84%E6%BD%9C%E5%9C%A8%E9%97%AE%E9%A2%98"><span class="toc-number">104.</span> <span class="toc-text">诊断集群的潜在问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-4-%E8%A7%A3%E5%86%B3%E9%9B%86%E7%BE%A4Yellow%E4%B8%8ERed%E7%9A%84%E9%97%AE%E9%A2%98-md"><span class="toc-number">105.</span> <span class="toc-text">10.4-解决集群Yellow与Red的问题.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%81%A5%E5%BA%B7%E4%B8%8E%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="toc-number">106.</span> <span class="toc-text">集群健康与问题排查</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-5-%E6%8F%90%E5%8D%87%E9%9B%86%E7%BE%A4%E5%86%99%E6%80%A7%E8%83%BD-md"><span class="toc-number">107.</span> <span class="toc-text">10.5-提升集群写性能.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%90%E5%8D%87%E9%9B%86%E7%BE%A4%E5%86%99%E6%80%A7%E8%83%BD-1"><span class="toc-number">108.</span> <span class="toc-text">提升集群写性能</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-6-%E6%8F%90%E5%8D%87%E9%9B%86%E7%BE%A4%E8%AF%BB%E6%80%A7%E8%83%BD-md"><span class="toc-number">109.</span> <span class="toc-text">10.6-提升集群读性能.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%90%E5%8D%87%E9%9B%86%E7%BE%A4%E8%AF%BB%E6%80%A7%E8%83%BD-1"><span class="toc-number">110.</span> <span class="toc-text">提升集群读性能</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-7-%E9%9B%86%E7%BE%A4%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95-md"><span class="toc-number">111.</span> <span class="toc-text">10.7-集群压力测试.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95-1"><span class="toc-number">112.</span> <span class="toc-text">集群压力测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-9-%E7%BC%93%E5%AD%98%E5%8F%8A%E4%BD%BF%E7%94%A8Breaker%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8-md"><span class="toc-number">113.</span> <span class="toc-text">10.9-缓存及使用Breaker限制内存使用.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E5%8F%8A%E4%BD%BF%E7%94%A8Circuit-Breaker%E9%99%90%E5%88%B6%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8"><span class="toc-number">114.</span> <span class="toc-text">缓存及使用Circuit Breaker限制内存使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%E9%98%85%E8%AF%BB"><span class="toc-number">114.1.</span> <span class="toc-text">补充阅读</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-1-%E4%BD%BF%E7%94%A8Shrink%E4%B8%8ERolloverAPI%E6%9C%89%E6%95%88%E7%AE%A1%E7%90%86%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E7%B4%A2%E5%BC%95-md"><span class="toc-number">115.</span> <span class="toc-text">11.1-使用Shrink与RolloverAPI有效管理时间序列索引.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-shrink%E4%B8%8ErolloverAPI%E6%9C%89%E6%95%88%E7%9A%84%E7%AE%A1%E7%90%86%E7%B4%A2%E5%BC%95"><span class="toc-number">116.</span> <span class="toc-text">使用 shrink与rolloverAPI有效的管理索引</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-2-%E7%B4%A2%E5%BC%95%E5%85%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86%E5%8F%8A%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D-md"><span class="toc-number">117.</span> <span class="toc-text">11.2-索引全生命周期管理及工具介绍.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%85%A8%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86%E5%8F%8A%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="toc-number">118.</span> <span class="toc-text">索引全生命周期管理及工具介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-1-Logstash%E5%85%A5%E9%97%A8%E5%8F%8A%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D-md"><span class="toc-number">119.</span> <span class="toc-text">12.1-Logstash入门及架构介绍.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Logstash-%E5%85%A5%E9%97%A8%E5%8F%8A%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">120.</span> <span class="toc-text">Logstash 入门及架构介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-2-%E5%88%A9%E7%94%A8JDBC%E6%8F%92%E4%BB%B6%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E5%88%B0Elasticsearch-md"><span class="toc-number">121.</span> <span class="toc-text">12.2-利用JDBC插件导入数据到Elasticsearch.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Logstash%E6%8F%92%E4%BB%B6%E5%8F%8A%E6%96%87%E6%A1%A3%E4%BB%8B%E7%BB%8D"><span class="toc-number">122.</span> <span class="toc-text">Logstash插件及文档介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-3-Beats%E4%BB%8B%E7%BB%8D-md"><span class="toc-number">123.</span> <span class="toc-text">12.3-Beats介绍.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Beats%E4%BB%8B%E7%BB%8D"><span class="toc-number">124.</span> <span class="toc-text">Beats介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-1-%E4%BD%BF%E7%94%A8IndexPattern%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE-md"><span class="toc-number">125.</span> <span class="toc-text">13.1-使用IndexPattern配置数据.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-2-%E4%BD%BF%E7%94%A8KibanaDiscover%E6%8E%A2%E7%B4%A2%E6%95%B0%E6%8D%AE-md"><span class="toc-number">126.</span> <span class="toc-text">13.2-使用KibanaDiscover探索数据.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Kibana-Discovery-%E6%8E%A2%E7%B4%A2%E6%95%B0%E6%8D%AE"><span class="toc-number">127.</span> <span class="toc-text">使用Kibana Discovery 探索数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-3-%E5%9F%BA%E6%9C%AC%E5%8F%AF%E8%A7%86%E5%8C%96%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D-md"><span class="toc-number">128.</span> <span class="toc-text">13.3-基本可视化组件介绍.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8F%AF%E8%A7%86%E5%8C%96%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">129.</span> <span class="toc-text">基本可视化组件介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-4-%E6%9E%84%E5%BB%BADashboard-md"><span class="toc-number">130.</span> <span class="toc-text">13.4-构建Dashboard.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%84%E5%BB%BADashboard"><span class="toc-number">131.</span> <span class="toc-text">构建Dashboard</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-3%E7%94%A8%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%AE%9E%E7%8E%B0%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%BC%82%E5%B8%B8%E6%A3%80%E6%B5%8B-%E4%B8%8A-md"><span class="toc-number">132.</span> <span class="toc-text">14.3用机器学习实现时序数据的异常检测-上.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-5-%E7%94%A8ELK%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-md"><span class="toc-number">133.</span> <span class="toc-text">14.5-用ELK进行日志管理.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8-ELK-%E6%9D%A5%E5%81%9A%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86"><span class="toc-number">134.</span> <span class="toc-text">用 ELK 来做日志管理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-6-%E7%94%A8Canvas%E5%81%9A%E6%95%B0%E6%8D%AE%E6%BC%94%E7%A4%BA-md"><span class="toc-number">135.</span> <span class="toc-text">14.6-用Canvas做数据演示.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-1-%E5%9F%BA%E4%BA%8E%E8%AF%8D%E9%A1%B9%E5%92%8C%E5%9F%BA%E4%BA%8E%E5%85%A8%E6%96%87%E7%9A%84%E6%90%9C%E7%B4%A2-md"><span class="toc-number">136.</span> <span class="toc-text">4.1-基于词项和基于全文的搜索.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%AF%8D%E9%A1%B9%E5%92%8C%E5%9F%BA%E4%BA%8E%E5%85%A8%E6%96%87%E7%9A%84%E6%90%9C%E7%B4%A2"><span class="toc-number">137.</span> <span class="toc-text">基于词项和基于全文的搜索</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-10-%E7%BB%BC%E5%90%88%E6%8E%92%E5%BA%8F%EF%BC%9AFunction-Score-Query-%E4%BC%98%E5%8C%96%E7%AE%97%E5%88%86-md"><span class="toc-number">138.</span> <span class="toc-text">4.10-综合排序：Function Score Query 优化算分.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E6%8E%92%E5%BA%8F%EF%BC%9AFunction-Score-Query-%E4%BC%98%E5%8C%96%E7%AE%97%E5%88%86"><span class="toc-number">139.</span> <span class="toc-text">综合排序：Function Score Query 优化算分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-12-%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E4%B8%8E%E5%9F%BA%E4%BA%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E6%8F%90%E7%A4%BA-md"><span class="toc-number">140.</span> <span class="toc-text">4.12-自动补全与基于上下文的提示.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E4%B8%8E%E5%9F%BA%E4%BA%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E6%8F%90%E7%A4%BA"><span class="toc-number">141.</span> <span class="toc-text">自动补全与基于上下文的提示</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-13-%E8%B7%A8%E9%9B%86%E7%BE%A4%E6%90%9C%E7%B4%A2-md"><span class="toc-number">142.</span> <span class="toc-text">4.13-跨集群搜索.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%A8%E9%9B%86%E7%BE%A4%E6%90%9C%E7%B4%A2"><span class="toc-number">143.</span> <span class="toc-text">跨集群搜索</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-2-%E7%BB%93%E6%9E%84%E5%8C%96%E6%90%9C%E7%B4%A2-md"><span class="toc-number">144.</span> <span class="toc-text">4.2-结构化搜索.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E5%8C%96%E6%90%9C%E7%B4%A2"><span class="toc-number">145.</span> <span class="toc-text">结构化搜索</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-3-%E6%90%9C%E7%B4%A2%E7%9A%84%E7%9B%B8%E5%85%B3%E6%80%A7%E7%AE%97%E5%88%86-md"><span class="toc-number">146.</span> <span class="toc-text">4.3-搜索的相关性算分.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E7%9A%84%E7%9B%B8%E5%85%B3%E6%80%A7%E7%AE%97%E5%88%86"><span class="toc-number">147.</span> <span class="toc-text">搜索的相关性算分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-4-Query-Filtering%E5%AE%9E%E7%8E%B0%E5%A4%9A%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2-md"><span class="toc-number">148.</span> <span class="toc-text">4.4-Query&amp;Filtering实现多字符串多字段查询.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Query-Filtering-%E4%B8%8E%E5%A4%9A%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">149.</span> <span class="toc-text">Query &amp; Filtering 与多字符串多字段查询</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-5-%E5%8D%95%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2-DisMaxQuery-md"><span class="toc-number">150.</span> <span class="toc-text">4.5-单字符串多字段查询-DisMaxQuery.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%95%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2%EF%BC%9ADis-Max-Query"><span class="toc-number">151.</span> <span class="toc-text">单字符串多字段查询：Dis Max Query</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-6-%E5%8D%95%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2-Multi-Match-md"><span class="toc-number">152.</span> <span class="toc-text">4.6-单字符串多字段查询-Multi-Match.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%95%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%9A%E5%AD%97%E6%AE%B5%E6%9F%A5%E8%AF%A2%EF%BC%9AMulti-Match"><span class="toc-number">153.</span> <span class="toc-text">单字符串多字段查询：Multi Match</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-7-%E5%A4%9A%E8%AF%AD%E8%A8%80%E5%8F%8A%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E4%B8%8E%E6%A3%80%E7%B4%A2-md"><span class="toc-number">154.</span> <span class="toc-text">4.7-多语言及中文分词与检索.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E8%AF%AD%E8%A8%80%E5%8F%8A%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E4%B8%8E%E6%A3%80%E7%B4%A2"><span class="toc-number">155.</span> <span class="toc-text">多语言及中文分词与检索</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90"><span class="toc-number">155.1.</span> <span class="toc-text">相关资源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%88%86%E8%AF%8D%E5%B7%A5%E5%85%B7%EF%BC%8C%E4%BE%9B%E5%8F%82%E8%80%83%EF%BC%9A"><span class="toc-number">155.1.1.</span> <span class="toc-text">一些分词工具，供参考：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-8-SpaceJam%E4%B8%80%E4%B8%AA%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E7%9A%84%E5%AE%9E%E4%BE%8B-md"><span class="toc-number">156.</span> <span class="toc-text">4.8-SpaceJam一个全文搜索的实例.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Space-Jam%EF%BC%8C%E4%B8%80%E6%AC%A1%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E7%9A%84%E5%AE%9E%E4%BE%8B"><span class="toc-number">157.</span> <span class="toc-text">Space Jam，一次全文搜索的实例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="toc-number">157.1.</span> <span class="toc-text">环境要求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E5%85%A5-tmdb-search%E7%9B%AE%E5%BD%95"><span class="toc-number">157.2.</span> <span class="toc-text">进入 tmdb-search目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3"><span class="toc-number">157.3.</span> <span class="toc-text">相关</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-9-%E4%BD%BF%E7%94%A8SearchTemplate%E5%92%8CIndexAlias%E8%BF%9B%E8%A1%8C%E6%9F%A5%E8%AF%A2-md"><span class="toc-number">158.</span> <span class="toc-text">4.9-使用SearchTemplate和IndexAlias进行查询.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Search-Template-%E5%92%8C-Index-Alias-%E6%9F%A5%E8%AF%A2"><span class="toc-number">159.</span> <span class="toc-text">使用 Search Template 和 Index Alias 查询</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-1-%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F%E6%A8%A1%E5%9E%8B%E5%8F%8A%E9%80%89%E4%B8%BB%E4%B8%8E%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98-md"><span class="toc-number">160.</span> <span class="toc-text">5.1-集群分布式模型及选主与脑裂问题.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%88%86%E5%B8%83%E5%BC%8F%E6%A8%A1%E5%9E%8B%E5%8F%8A%E9%80%89%E4%B8%BB%E4%B8%8E%E8%84%91%E8%A3%82%E9%97%AE%E9%A2%98"><span class="toc-number">161.</span> <span class="toc-text">集群分布式模型及选主与脑裂问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-2-%E5%88%86%E7%89%87%E4%B8%8E%E9%9B%86%E7%BE%A4%E7%9A%84%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB-md"><span class="toc-number">162.</span> <span class="toc-text">5.2-分片与集群的故障转移.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E7%89%87%E4%B8%8E%E9%9B%86%E7%BE%A4%E7%9A%84%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-number">163.</span> <span class="toc-text">分片与集群的故障转移</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-3-%E6%96%87%E6%A1%A3%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8-md"><span class="toc-number">164.</span> <span class="toc-text">5.3-文档分布式存储.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8"><span class="toc-number">165.</span> <span class="toc-text">文档分布式存储</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-4-%E5%88%86%E7%89%87%E5%8F%8A%E5%85%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-md"><span class="toc-number">166.</span> <span class="toc-text">5.4-分片及其生命周期.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%8F%8A%E5%85%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">167.</span> <span class="toc-text">分片及其生命周期</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-5-%E5%89%96%E6%9E%90%E5%88%86%E5%B8%83%E5%BC%8F%E6%9F%A5%E8%AF%A2%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%80%A7%E8%AF%84%E5%88%86-md"><span class="toc-number">168.</span> <span class="toc-text">5.5-剖析分布式查询及相关性评分.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%96%E6%9E%90%E5%88%86%E5%B8%83%E5%BC%8F%E6%9F%A5%E8%AF%A2%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%80%A7%E8%AF%84%E5%88%86"><span class="toc-number">169.</span> <span class="toc-text">剖析分布式查询及相关性评分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-6-%E6%8E%92%E5%BA%8F%E5%8F%8ADocValues-Fielddata-md"><span class="toc-number">170.</span> <span class="toc-text">5.6-排序及DocValues&amp;Fielddata.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E5%8F%8ADoc-Values-Fielddata"><span class="toc-number">171.</span> <span class="toc-text">排序及Doc Values &amp; Fielddata</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-7-%E5%88%86%E9%A1%B5%E4%B8%8E%E9%81%8D%E5%8E%86-FromSize-SearchAfter-ScrollAPI-md"><span class="toc-number">172.</span> <span class="toc-text">5.7-分页与遍历-FromSize&amp;SearchAfter&amp;ScrollAPI.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E4%B8%8E%E9%81%8D%E5%8E%86-From-Size-Search-after-Scroll-API"><span class="toc-number">173.</span> <span class="toc-text">分页与遍历 - From, Size, Search_after &amp; Scroll API</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-8-%E5%A4%84%E7%90%86%E5%B9%B6%E5%8F%91%E8%AF%BB%E5%86%99-md"><span class="toc-number">174.</span> <span class="toc-text">5.8-处理并发读写.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%B9%B6%E5%8F%91%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-number">175.</span> <span class="toc-text">处理并发读写操作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-1-Bucket-Metric%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E5%8F%8A%E5%B5%8C%E5%A5%97%E8%81%9A%E5%90%88-md"><span class="toc-number">176.</span> <span class="toc-text">6.1-Bucket&amp;Metric聚合分析及嵌套聚合.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Bucket-Metric-Aggregation"><span class="toc-number">177.</span> <span class="toc-text">Bucket &amp; Metric Aggregation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#demos"><span class="toc-number">177.1.</span> <span class="toc-text">demos</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-2-Pipeline%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90-md"><span class="toc-number">178.</span> <span class="toc-text">6.2-Pipeline聚合分析.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pipeline-%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="toc-number">179.</span> <span class="toc-text">Pipeline 聚合分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-3-%E4%BD%9C%E7%94%A8%E8%8C%83%E5%9B%B4%E4%B8%8E%E6%8E%92%E5%BA%8F-md"><span class="toc-number">180.</span> <span class="toc-text">6.3-作用范围与排序.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8%E8%8C%83%E5%9B%B4%E4%B8%8E%E6%8E%92%E5%BA%8F"><span class="toc-number">181.</span> <span class="toc-text">作用范围与排序</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-4-%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E7%B2%BE%E5%87%86%E5%BA%A6%E9%97%AE%E9%A2%98-md"><span class="toc-number">182.</span> <span class="toc-text">6.4-聚合分析的原理及精准度问题.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E7%B2%BE%E5%87%86%E5%BA%A6%E9%97%AE%E9%A2%98"><span class="toc-number">183.</span> <span class="toc-text">聚合分析的原理及精准度问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-1-%E5%AF%B9%E8%B1%A1%E5%8F%8A-Nested-%E5%AF%B9%E8%B1%A1-md"><span class="toc-number">184.</span> <span class="toc-text">7.1-对象及 Nested 对象.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%8F%8ANested%E5%AF%B9%E8%B1%A1"><span class="toc-number">185.</span> <span class="toc-text">对象及Nested对象</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-2-%E6%96%87%E6%A1%A3%E7%9A%84%E7%88%B6%E5%AD%90%E5%85%B3%E7%B3%BB-md"><span class="toc-number">186.</span> <span class="toc-text">7.2-文档的父子关系.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%9A%84%E7%88%B6%E5%AD%90%E5%85%B3%E7%B3%BB"><span class="toc-number">187.</span> <span class="toc-text">文档的父子关系</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-5-Elasticsearch%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E5%AE%9E%E4%BE%8B-md"><span class="toc-number">188.</span> <span class="toc-text">7.5-Elasticsearch数据建模实例.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Elasticsearch-%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E5%AE%9E%E4%BE%8B"><span class="toc-number">189.</span> <span class="toc-text">Elasticsearch 数据建模实例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-6-Elasticsearch-%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-md"><span class="toc-number">190.</span> <span class="toc-text">7.6-Elasticsearch 数据建模最佳实践.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Elasticsearch-%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">191.</span> <span class="toc-text">Elasticsearch 数据建模最佳实践</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-7-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E6%80%BB%E7%BB%93%E4%B8%8E%E6%B5%8B%E9%AA%8C-md"><span class="toc-number">192.</span> <span class="toc-text">7.7-第二部分总结与测验.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E6%80%BB%E7%BB%93%E4%B8%8E%E6%B5%8B%E9%AA%8C"><span class="toc-number">193.</span> <span class="toc-text">第二部分总结与测验</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-1-%E9%9B%86%E7%BE%A4%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%8E%E7%94%A8%E6%88%B7%E9%89%B4%E6%9D%83-md"><span class="toc-number">194.</span> <span class="toc-text">8.1-集群身份认证与用户鉴权.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E4%B8%8E%E7%94%A8%E6%88%B7%E9%89%B4%E6%9D%83"><span class="toc-number">195.</span> <span class="toc-text">集群身份认证与用户鉴权</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-2-%E9%9B%86%E7%BE%A4%E5%86%85%E9%83%A8%E5%AE%89%E5%85%A8%E9%80%9A%E4%BF%A1-md"><span class="toc-number">196.</span> <span class="toc-text">8.2-集群内部安全通信.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#-3"><span class="toc-number">197.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-3-%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%A4%96%E9%83%A8%E9%97%B4%E7%9A%84%E5%AE%89%E5%85%A8%E9%80%9A%E4%BF%A1-md"><span class="toc-number">198.</span> <span class="toc-text">8.3-集群与外部间的安全通信.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-1-%E5%B8%B8%E8%A7%81%E7%9A%84%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F-md-1"><span class="toc-number">199.</span> <span class="toc-text">9.1-常见的集群部署方式.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F-1"><span class="toc-number">200.</span> <span class="toc-text">常见的集群部署方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-2-Hot-Warm%E6%9E%B6%E6%9E%84%E4%B8%8EShardFiltering-md-1"><span class="toc-number">201.</span> <span class="toc-text">9.2-Hot&amp;Warm架构与ShardFiltering.md</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hot-Warm-%E6%9E%B6%E6%9E%84%E4%B8%8E-Shard-Filtering-1"><span class="toc-number">202.</span> <span class="toc-text">Hot &amp; Warm 架构与 Shard Filtering</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E4%BB%A3%E7%A0%81-1"><span class="toc-number">202.1.</span> <span class="toc-text">课程代码</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/linux/linux%E4%B8%8B%E4%BF%AE%E5%A4%8D%E7%BD%91%E5%8D%A1%E5%87%BA%E5%85%A5%E5%8F%A3%E7%AD%96%E7%95%A5/" title="linux下修复网卡出入口策略">linux下修复网卡出入口策略</a><time datetime="2025-10-17T09:51:59.000Z" title="发表于 2025-10-17 17:51:59">2025-10-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/k8s/%E5%B0%86%E7%94%9F%E4%BA%A7%E7%9A%84%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E5%88%B0%E9%A2%84%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" title="将生产的流量镜像到预生产环境的一些思考">将生产的流量镜像到预生产环境的一些思考</a><time datetime="2025-06-24T07:06:47.000Z" title="发表于 2025-06-24 15:06:47">2025-06-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/docker/%E5%9F%BA%E4%BA%8Ek8s%E5%AE%9E%E7%8E%B0%E4%BC%98%E9%9B%85%E5%81%9C%E6%9C%BA/" title="基于k8s实现优雅停机">基于k8s实现优雅停机</a><time datetime="2025-06-06T04:27:16.000Z" title="发表于 2025-06-06 12:27:16">2025-06-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/mysql/mysql%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5sql/" title="mysql异常排查sql">mysql异常排查sql</a><time datetime="2025-06-04T16:09:57.000Z" title="发表于 2025-06-05 00:09:57">2025-06-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/java/Java%E9%80%9A%E8%BF%87JNI%E8%B0%83%E7%94%A8C-C/" title="Java通过JNI调用C/C++">Java通过JNI调用C/C++</a><time datetime="2025-04-25T01:47:01.000Z" title="发表于 2025-04-25 09:47:01">2025-04-25</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2025 By <a class="footer-bar-link" href="/" title="candy" target="_blank">candy</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">38</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">28</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">14</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/JNI/" style="font-size: 0.88rem;">JNI<sup>1</sup></a><a href="/tags/chrome/" style="font-size: 0.88rem;">chrome<sup>2</sup></a><a href="/tags/docker/" style="font-size: 0.88rem;">docker<sup>1</sup></a><a href="/tags/docker%E9%83%A8%E7%BD%B2/" style="font-size: 0.88rem;">docker部署<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>1</sup></a><a href="/tags/k8s/" style="font-size: 0.88rem;">k8s<sup>1</sup></a><a href="/tags/lua%E8%A1%A8%E8%BE%BE%E5%BC%8F/" style="font-size: 0.88rem;">lua表达式<sup>1</sup></a><a href="/tags/nginx/" style="font-size: 0.88rem;">nginx<sup>2</sup></a><a href="/tags/openvpn/" style="font-size: 0.88rem;">openvpn<sup>2</sup></a><a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 0.88rem;">事务<sup>1</sup></a><a href="/tags/%E4%BA%A4%E6%98%93%E7%AD%96%E7%95%A5/" style="font-size: 0.88rem;">交易策略<sup>1</sup></a><a href="/tags/%E5%91%BD%E4%BB%A4/" style="font-size: 0.88rem;">命令<sup>1</sup></a><a href="/tags/%E5%A4%87%E4%BB%BD/" style="font-size: 0.88rem;">备份<sup>2</sup></a><a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 0.88rem;">学习笔记<sup>2</sup></a><a href="/tags/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" style="font-size: 0.88rem;">常用命令<sup>1</sup></a><a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 0.88rem;">并发<sup>1</sup></a><a href="/tags/%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/" style="font-size: 0.88rem;">开机自启<sup>1</sup></a><a href="/tags/%E6%89%93%E5%8D%B0%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97/" style="font-size: 0.88rem;">打印异常日志<sup>1</sup></a><a href="/tags/%E6%89%A9%E5%AE%B9%E7%A3%81%E7%9B%98/" style="font-size: 0.88rem;">扩容磁盘<sup>2</sup></a><a href="/tags/%E6%8A%A5%E8%AD%A6/" style="font-size: 0.88rem;">报警<sup>1</sup></a><a href="/tags/%E6%9F%A5%E6%89%BE%E8%BF%9B%E7%A8%8B/" style="font-size: 0.88rem;">查找进程<sup>1</sup></a><a href="/tags/%E6%BC%8F%E6%B4%9E/" style="font-size: 0.88rem;">漏洞<sup>1</sup></a><a href="/tags/%E7%8A%B6%E6%80%81%E6%9C%BA/" style="font-size: 0.88rem;">状态机<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%AB%99%E8%B5%84%E6%BA%90/" style="font-size: 0.88rem;">网站资源<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>1</sup></a><a href="/tags/%E7%BF%BB%E5%A2%99/" style="font-size: 0.88rem;">翻墙<sup>1</sup></a><a href="/tags/%E8%87%AA%E5%AD%A6%E5%85%AC%E5%BC%8F/" style="font-size: 0.88rem;">自学公式<sup>1</sup></a><a href="/tags/%E8%B4%A6%E6%88%B7%E8%B5%84%E9%87%91/" style="font-size: 0.88rem;">账户资金<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 candy 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>